<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <!-- (Alpha 1) Viewport per PWA e mobile -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Gestione Spese</title>
    
    <!-- (Alpha 1) Meta tag per PWA iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Spese">
    
    <!-- (Alpha 1) Icona PWA (SVG in base64) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBmaWxsPSIjNDE2OWUxIiBkPSJNMCAwaDEwMHYxMDBIMHoiLz48ZyBmaWxsPSIjZmZmIj48cGF0aCBkPSJNNzkuNDEgMjguNzJhMS44MyAxLjgzIDAgMCAwLTEuNTYtMS4wM2gtOS4zOWMtMS4wMSAwLTEuODMuNzYtMS44MyAxLjcydjMuNThoLTQuMDV2LTMuNThjMC0xLS44Mi0xLjcyLTEuODMtMS43MmgtOS4zOWMtMS4wMSAwLTEuODMuNzYtMS44MyAxLjcydjMuNThoLTMuODZ2LTMuNThjMC0xLS44Mi0xLjcyLTEuODMtMS43MmgtOS4zOWMtMS4wMSAwLTEuODMuNzYtMS44MyAxLjcydi42N2MwIDEgLjgyIDEuNzIgMS44MyAxLjcyaDcuMDd2My41OGgtNy4wN2MtMS4wMSAwLTEuODMuNzYtMS44MyAxLjcydi42N2MwIDEgLjgyIDEuNzIgMS44MyAxLjcyaDcuMDd2My41OGgtNy4wN2MtMS4wMSAwLTEuODMuNzYtMS44MyAxLjcydi42N2MwIDEgLjgyIDEuNzIgMS44MyAxLjcyaDcuMDd2My45N2gtNy4wN2MtMS4wMSAwLTEuODMuNzctMS44MyAxLjcydi42N2MwIDEgLjgyIDEuNzIgMS44MyAxLjcyaDguMTZ2MTEuNjRjMCAxIC44MiAxLjcyIDEuODMgMS43MnMxLjgzLS43NiAxLjgzLTEuNzJWNTguOTdoMS41OXYxMS4xMmMwIDEgLjgyIDEuNzIgMS44MyAxLjcMnMxLjgzLS43NiAxLjgzLTEuNzJWNTguOTdoMS42MXYxMS4xMmMwIDEgLjgyIDEuNzIgMS44MyAxLjcMnMxLjgzLS43NiAxLjgzLTEuNzJWNTguOTdoMS4yM2w4LjE2IDBjMS4wMSAwIDEuODMtLjc3IDEuODMtMS43MnYtMS4xMmMwLS45NS0uODItMS43Mi0xLjgzLTEuNzJoLTcuMDd2LTMuOTdoNy4wN2MxLjAxIDAgMS44My0uNzcgMS44My0xLjcydi0uNjdjMC0uOTUtLjgyLTEuNzItMS44My0xLjcyaC03LjA3di0zLjU4aDcuMDdjMS4wMSAwIDEuODMtLjcYIDEuODMtMS43MnYtLjY3YzAtLjk1LS44Mi0xLjcyLTEuODMtMS43MmgtNy4wN3YtMy41OGgxLjYxdjMuNThaTTgwLjY2IDM0LjM0di0zLjU4aDEuNjF2My41OGgtMS42MVptLTExLjIyIDBoLTEuNTl2LTMuNThoMS41OXYzLjU4Wm0tMTEuMDMgMGgtMS42MXYtMy41OGgxLjYxdjMuNThabTIyLjI1IDUuMTZoLTEuNjF2LTMuNThoMS42MXYzLjU4Wm0tMTEuMjIgMGgtMS41OXYtMy41OGgxLjU5djMuNThabS0xMS4wMyAwaC0xLjYxdi0zLjU4aDEuNjF2My41OFptNS41MSA4Ljc0YzAgMSAuODIgMS43MiAxLjgzIDEuNzJzMS44My0uNzYgMS44My0xLjc3VjU4Ljk3aC0zLjY2djYuNDFaIi8+PC9nPjwvc3ZnPg==">
    
    <!-- (Alpha 36) Aggiunta libreria Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>


    <style>
        /* CSS: Stile dell'app */
/* --- (Alpha 65) GESTIONE TEMI --- */

       /* --- (Alpha 83) TEMA PRO --- */
       /* TEMA 1: Pro (Chiaro) - Default */
        body, body.theme-pro-light {
            --bg-color-top: #f6f6f8; /* Grigio chiaro pulito (non crema) */
            --bg-color-bottom: #f0f0f2; /* Gradiente leggero */
            --card-bg: rgba(255, 255, 255, 0.75); /* Vetro più pulito */
            --glass-border: rgba(0, 0, 0, 0.08); /* Bordo vetro */
            --primary-color: #007AFF; /* Blu "Pro" (Apple Style) */
            --primary-dark: #0056b3;
            --text-color: #1d1d1f; /* Nero quasi puro */
            --secondary-text-color: #6e6e73;
            --input-bg: #f0f0f2;
            --border-color: #d1d1d6;
            --monthly-icon-bg: #e6f2ff; /* Sfondi icone (ora usati per il cerchio) */
            --monthly-icon-color: #007AFF;
            --weekly-icon-bg: #e6f2ff;
            --weekly-icon-color: #007AFF;
            --green: #34C759;
            --yellow: #FF9500;
            --orange: #FF9500;
            --red: #FF3B30;
            --toast-bg: rgba(0, 0, 0, 0.85);
        }

        /* TEMA 2: Pro (Scuro) */
        body.theme-pro-dark {
            --bg-color-top: #101012; /* Gradiente scuro */
            --bg-color-bottom: #000000; /* Nero puro */
            --card-bg: #1A1B1E; /* (v104) Grigio scuro personalizzato */
            --glass-border: rgba(255, 255, 255, 0.15); /* Bordo vetro */
            --primary-color: #0A84FF; /* Blu "Pro" scuro */
            --primary-dark: #007AFF;
            --text-color: #f5f5f7;
            --secondary-text-color: #8e8e93;
            --input-bg: #1a1a1c;
            --border-color: #38383a;
            --monthly-icon-bg: #2c2c2e;
            --monthly-icon-color: #0A84FF;
            --weekly-icon-bg: #2c2c2e;
            --weekly-icon-color: #0A84FF;
            --green: #30D158;
            --yellow: #FF9F0A;
            --orange: #FF9F0A;
            --red: #FF453A;
            --toast-bg: rgba(230, 230, 230, 0.9);
        }
    
        /* --- FINE GESTIONE TEMI --- */
		/* Dark mode Style */

body.theme-dark select,
body.theme-dark option,
body.theme-dark label {
  color: var(--text-color);
  background-color: var(--input-bg);
}

@keyframes screenFadeIn {
            from {
                opacity: 0;
                transform: scale(0.97);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        body {
            /* (Alpha 99) Sfondo spostato su pseudo-elemento (Fix iPhone Overscroll) */
            background-color: var(--bg-color-top); /* Colore di base (fallback) */
            min-height: 100vh; 
            position: relative; /* Necessario per lo z-index */

            /* (Alpha 100) Aggiunge padding per coprire l'area notch/camera */
            padding-top: env(safe-area-inset-top);
            
            transition: background-color 0.3s ease, color 0.3s ease;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            color: var(--text-color);
            -webkit-user-select: none; 
            user-select: none;
            -webkit-tap-highlight-color: transparent; 
        }
        /* (Alpha 99) Sfondo "Fixed" con pseudo-elemento */
        body::before {
            content: '';
            position: fixed; /* Fissa allo schermo, non scorre */
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            
            /* Applica qui il gradiente */
            background-image: linear-gradient(180deg, var(--bg-color-top), var(--bg-color-bottom));
            background-repeat: no-repeat;
            
            z-index: -1; /* Mette lo sfondo DIETRO a tutto il contenuto */
        }
        /* (Alpha 99) Sfondo "Fixed" con pseudo-elemento */
        body::before {
            content: '';
            position: fixed; /* Fissa allo schermo, non scorre */
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            
            /* Applica qui il gradiente */
            background-image: linear-gradient(180deg, var(--bg-color-top), var(--bg-color-bottom));
            background-repeat: no-repeat;
            
            z-index: -1; /* Mette lo sfondo DIETRO a tutto il contenuto */
        }

        .container {
            /* (Alpha 99) Abilita lo scroll verticale solo per il contenuto */
            height: 100vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* Scrolling fluido su iOS */

            padding: 15px;
            /* (Alpha 94) Aumentiamo il padding inferiore per fare spazio alla barra */
            padding-bottom: 100px; 
            max-width: 600px;
            margin: 0 auto;
            /* (Alpha 86) Forza il contesto di impilamento (z-index) */
            position: relative;
            box-sizing: border-box; /* Assicura che il padding sia incluso nell'altezza */
        }

        .hidden {
            display: none !important;
        }

        /* (Alpha 74) Applica l'animazione a tutte le "schermate" */
        #home-screen, #add-expense-category-screen, #manage-categories-screen,
        #add-expense-amount-screen, #view-expenses-screen, #category-detail-screen,
        #edit-expense-screen, #edit-category-screen, #monthly-history-screen,
        #weekly-detail-screen, #weekly-category-detail-screen, #chart-screen {
            
            /* Applica l'animazione solo quando NON è nascosta */
            animation: screenFadeIn 0.25s ease-out;
        }

        /* (Alpha 77) Header (Sticky + Gradient) e Padding corretto */
        .header {
            display: grid;
            grid-template-columns: 1fr auto; 
            grid-template-rows: auto auto;    
            align-items: start; 

            /* (Alpha 77) Ripristinato gradiente per leggibilità */
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            background-size: 200% 200%; 
            animation: gradientMove 8s ease infinite; 
            color: white; /* Il testo bianco ora è corretto */
            
            /* (Alpha 77) Padding ridotto */
            padding: 20px 15px 20px 15px; 
            
            border-radius: 0 0 24px 24px; 
            margin: -15px -15px 0 -15px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);

            /* (Alpha 76) Mantenuto STICKY */
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* (Alpha 55) Rimosso .header-top */

        .header h1 {
            grid-column: 1 / 2; 
            grid-row: 1 / 2;
            font-size: 24px;
            margin: 0;
            color: white; /* (Alpha 41) */
            text-align: left; 
        }

        .header p {
            grid-column: 1 / 2; 
            grid-row: 2 / 3;
            text-align: left; 
            margin: 0; /* (Alpha 41) Rimosso margine superiore */
            color: rgba(255, 255, 255, 0.8); /* (Alpha 41) */
            font-size: 14px;
            line-height: 1.4; 
        }
        
        /* (Alpha 55) Riquadro icone spese fisse */
        #fixed-expenses-summary {
            grid-column: 2 / 3;
            grid-row: 1 / 2; /* Sopra il budget */
            display: flex;
            flex-direction: row-reverse; /* Allinea a destra */
            gap: 8px;
            padding-bottom: 5px;
            align-items: center;
            justify-content: flex-start; /* Inizia da destra */
            min-height: 30px; /* Altezza minima */
        }
        .summary-icon-item {
            width: 24px;
            height: 24px;
            padding: 4px;
            border-radius: 50%;
            background-color: var(--card-bg);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .summary-icon-item svg {
            width: 16px;
            height: 16px;
            color: var(--primary-color);
        }

        /* (Alpha 55) Budget spostato sotto */
        #monthly-budget-summary {
            grid-column: 2 / 3;  
            grid-row: 2 / 3;     /* Sotto le icone */
            justify-self: end; 
            align-self: center; 
            font-size: 10px; 
            color: rgba(255, 255, 255, 0.8); /* (Alpha 41) */
            padding: 0 5px 0 0; 
            white-space: nowrap; 
            text-align: right; 
            line-height: 1.3; 
        }
        #monthly-budget-summary h4 {
            margin: 0;
            font-weight: normal; 
            text-transform: uppercase; 
        }
         #monthly-budget-summary .remaining-budget {
            font-weight: bold; 
            font-size: 14px; 
            color: white; /* (Alpha 41) */
            display: block; 
         }


        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.1); /* (Alpha 74) Ombra default */
        }
        
        /* (Alpha 77) Rimosso .header dal blur, ora è colorato */
        .card,
        .total-box,
        .modal-content {
            -webkit-backdrop-filter: blur(14px);
            backdrop-filter: blur(14px);
            /* (Alpha 83) Aggiunto bordo "vetro" */
            border: 1px solid var(--glass-border);
        }   
        /* (Alpha 41) Riquadri home spostati in su */
        .summary-cards {
            display: grid;
            grid-template-columns: 1fr; 
            gap: 15px; 
            margin-bottom: 20px; 
            margin-top: 20px; /* (Alpha 77) Corretto overlap con header sticky */
            position: relative;
            z-index: 10;
        }
        
        /* (Alpha 41) Stile riquadri home con icone */
        .summary-cards .total-box {
            background-color: var(--card-bg); /* (Alpha 41) Sfondo bianco */
            padding: 16px; 
            border-radius: 12px;
            box-shadow: var(--card-shadow); 
            margin-bottom: 0; 
            border: none; 
            display: flex; /* (Alpha 41) Layout Flex */
            align-items: center; /* (Alpha 41) */
            gap: 15px; /* (Alpha 41) Spazio tra icona e testo */
        }

        /* (Alpha 83) Icone Home "pulite" (via il cerchio) */
        .total-box-icon {
            /* Non più un cerchio, solo un contenitore */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; 
        }
        /* (Alpha 103) Icone IMG ridimensionate per matchare le Emoji */
        .summary-icon-img {
            width: 44px;
            height: 44px;
            /* Le tue icone hanno già gli angoli smussati, 
               ma questo aiuta a uniformare se necessario */
            border-radius: 8px; 
        }

        /* (Alpha 102) Rimuove gli sfondi colorati dai contenitori */
        #monthly-icon-bg,
        #weekly-icon-bg {
            background-color: transparent;
            color: unset;
        }
        .total-box-text {
            text-align: left; /* (Alpha 41) Testo allineato a sx */
        }
        /* Rimossi sfondi gradiente da ID */
        /* #monthly-box.total-box { ... } */
        /* #weekly-box.total-box { ... } */

        .total-box {
            cursor: pointer;
            transition: transform 0.2s;
        }

        .total-box:active {
            transform: scale(0.97);
        }

        .total-box h3 {
            margin: 0 0 5px;
            font-size: 16px; /* (Alpha 41) Ridotto per nuovo layout */
            color: var(--secondary-text-color); 
            font-weight: 500;
        }

        .total-box p {
            margin: 0;
            font-size: 24px; /* (Alpha 41) Ridotto per nuovo layout */
            font-weight: 600;
            color: var(--text-color); /* (Alpha 41) */
        }

        /* Stile per il range date (Alpha 2) */
        .total-box .date-range {
            font-size: 12px; 
            color: var(--secondary-text-color); 
            margin-top: 4px; /* (Alpha 41) Aggiunto spazio sopra */
            display: block;
        }

        /* (Alpha 67) Stile Pulsante Primario (Reso Thematic) */
        .btn {
          display: block;
          width: 100%;
          padding: 14px;
          /* USA LE VARIABILI DI TEMA */
          background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
          background-size: 200% 200%;
          animation: gradientMove 4s ease infinite;
          color: white; /* Il testo resta bianco, va bene con tutti i temi primari */
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          text-align: center;
          position: relative;
          overflow: hidden;
          /* Sostituiamo la shadow "rotta" con una generica */
          box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.2);
          transition: transform 0.2s, box-shadow 0.2s, filter 0.2s;
        }

        @keyframes gradientMove {
          0% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
          100% { background-position: 0% 50%; }
        }

        .btn:active {
            /* Scurisce il gradiente del tema attivo invece di usare un colore fisso */
            filter: brightness(0.9); 
            transform: translateY(1px); 
            box-shadow: 0 2px 6px -1px rgba(0, 0, 0, 0.2); 
        }
        
        /* (Alpha 40 / 41) Stile Pulsante Secondario (Filled) */
        .btn-secondary {
            background-color: var(--card-bg); /* (Alpha 41) Sfondo bianco */
            color: var(--text-color); /* (Alpha 41) Testo scuro */
            border: 1px solid var(--border-color); /* (Alpha 41) Bordo leggero */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); /* (Alpha 41) Ombra leggera */
        }
        
        .btn-secondary:active {
            background-color: #f7f8fc; /* (Alpha 40) Sfondo leggero al tocco */
            transform: none;
            box-shadow: none;
            border-color: #d0d2d6; /* (Alpha 41) */
        }

        .btn-danger {
            background-color: var(--red);
            box-shadow: 0 4px 12px -2px rgba(250, 56, 62, 0.4); /* (Alpha 40) Ombra rossa */
        }

        .btn-danger:active {
            background-color: #d92e33;
            box-shadow: 0 2px 6px -1px rgba(250, 56, 62, 0.4); /* (Alpha 40) */
            transform: translateY(1px);
        }

        .actions {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            /* (Alpha 17) Aggiungi spazio sotto i pulsanti per la versione */
            margin-bottom: 20px;
        }

        /* (Alpha 17) Stile per la versione */
        #app-version {
            text-align: left;
            font-size: 11px;
            color: var(--secondary-text-color);
            opacity: 0.7;
            padding-left: 5px; /* Piccolo padding a sinistra */
        }

        /* Griglia Categorie */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
        }

        .category-item {
            background-color: var(--card-bg); /* (Alpha 18) */
            border: 1px solid var(--border-color); /* (Alpha 18) */
            padding: 15px 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            transition: transform 0.1s, box-shadow 0.2s;
            position: relative;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06); /* (Alpha 40) Ombra più definita */
        }

        .category-item:active {
            transform: scale(0.96);
        }
        
        /* Icona elimina per la gestione categorie (Alpha 1) */
        .category-item .delete-icon {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background-color: var(--red);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            border: 2px solid white;
        }

        /* (Alpha 8) Stile per il nome della categoria (per renderlo cliccabile) */
        .category-item .category-name {
            cursor: pointer;
            display: block;
            padding: 5px; /* Aumenta l'area cliccabile */
            transition: background-color 0.2s;
            border-radius: 5px;
        }
        .category-item .category-name:active {
            background-color: #e0e2e7;
        }


        .category-item .budget-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            background-color: var(--green);
            border-radius: 0 0 8px 8px;
        }
        
        /* Stile per i riquadri in "Visualizza Spese" (Alpha 1) */
        .expense-category-item {
            padding: 12px;
            border-radius: 8px;
            color: white;
            cursor: pointer; /* Aggiunto per mostrare che è cliccabile */
            transition: transform 0.1s;
        }
        
        .expense-category-item:active {
            transform: scale(0.97); /* Feedback al tocco */
        }

        .expense-category-item h4 {
            margin: 0 0 4px;
            font-size: 16px;
        }

        .expense-category-item p {
            margin: 0 0 4px 0; /* (Alpha 12) Aggiunto margin-bottom */
            font-size: 12px;
            opacity: 0.9;
        }

        .expense-category-item .amount {
            font-size: 22px;
            font-weight: 600;
            margin-top: 8px;
        }
        
        /* (Alpha 36) Rendi cliccabili anche i box in #monthly-history-grid */
        #monthly-history-grid .expense-category-item {
             cursor: pointer;
             transition: transform 0.1s; /* (Alpha 37) Aggiunto */
        }
         #monthly-history-grid .expense-category-item:active {
             transform: scale(0.97);
         }


        /* (Alpha 40) Stile Form di input "Filled" */
       .input-group {
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}


        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        /* (Alpha 22) Checkbox stile */
        .input-group label input[type="checkbox"] {
            margin-right: 8px;
            vertical-align: middle;
        }

        .input-group input:not([type="checkbox"]), .input-group textarea, .input-group select { 
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color); /* (Alpha 40) Bordo leggero */
            background-color: var(--input-bg); /* (Alpha 41) Sfondo "pieno" */
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box; 
        }
        
        .input-group input:not([type="checkbox"]):focus, .input-group textarea:focus, .input-group select:focus {
             background-color: var(--card-bg);
             border-color: var(--primary-color);
             outline: none;
             box-shadow: 0 0 0 2px rgba(74, 105, 226, 0.2); /* (Alpha 41) */
        }
        
        textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        /* (Alpha 55) Griglia selezione icone */
        .icon-select-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 10px;
            padding-top: 5px;
        }
        .icon-select-item {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .icon-select-item svg {
            width: 20px;
            height: 20px;
            color: var(--secondary-text-color);
            transition: color 0.2s;
        }
        .icon-select-item.selected {
            border-color: var(--primary-color);
            background-color: #f0f5ff;
        }
        .icon-select-item.selected svg {
            color: var(--primary-color);
        }

        /* Modale di conferma personalizzato (Alpha 1 / Alpha 27) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            pointer-events: none; /* (Alpha 27) Ignora click su overlay */
            opacity: 0; /* (Alpha 27) Nascosto per transizione */
            transition: opacity 0.2s ease-in-out;
        }
         /* (Alpha 27) Stile per mostrare il modale */
        .modal-overlay.visible {
  opacity: 1;
  pointer-events: auto;
  backdrop-filter: blur(6px);
  background-color: rgba(0, 0, 0, 0.4);
}
        .modal-content {
            background-color: var(--card-bg); /* (Alpha 76) Sfondo vetro */
            padding: 20px;
            border-radius: 12px;
            width: 85%;
            max-width: 300px;
            text-align: center;
            transform: scale(0.9); /* (Alpha 27) Per animazione */
            transition: transform 0.2s ease-in-out;
        }
        /* (Alpha 27) Stile per mostrare il contenuto del modale */
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        
        .modal-content h3 {
            margin-top: 0;
        }

        .modal-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Messaggio "Nessuna spesa" (Alpha 1) */
        #no-expenses-message {
            text-align: center;
            padding: 30px;
            color: var(--secondary-text-color);
        }
        
        /* Stili per la schermata di dettaglio (Alpha 1) */
        .expense-list-item {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer; /* Aggiunto per renderlo cliccabile */
            transition: background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05); /* (Alpha 40) */
            position: relative; /* (Alpha 53) Aggiunto per icona delete */
            padding-right: 40px; /* (Alpha 53) Spazio per icona delete */
        }
        .expense-list-item:active {
            background-color: #f0f2f5; /* Feedback al tocco */
            box-shadow: none; /* (Alpha 40) */
            transform: scale(0.99); /* (Alpha 40) */
        }
        .expense-list-item .details {
            font-size: 15px;
        }
        .expense-list-item .details .note {
            font-size: 13px;
            color: var(--secondary-text-color);
            margin-top: 4px;
        }
        .expense-list-item .amount {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        /* (Alpha 53) Icona elimina per le spese */
        .expense-list-item .delete-icon {
            position: absolute;
            top: 50%;
            right: 8px;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            background-color: var(--red);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .expense-list-item:hover .delete-icon {
             opacity: 1;
        }
        .expense-list-item .delete-icon:active {
            transform: translateY(-50%) scale(0.9);
            opacity: 1;
        }

        
        /* (Alpha 37) Stile per i riquadri di riepilogo categoria */
        .category-summary-item {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s; /* (Alpha 40) */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05); /* (Alpha 40) */
        }
        .category-summary-item:active {
            background-color: #f0f2f5;
            box-shadow: none; /* (Alpha 40) */
            transform: scale(0.99); /* (Alpha 40) */
        }
        .category-summary-item .details {
            font-size: 16px;
            font-weight: 500;
        }
        .category-summary-item .amount {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }


        /* (Alpha 26) Stili per Import/Export */
        .import-export-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        .import-export-section h3 {
            text-align: center;
            color: var(--secondary-text-color);
            margin-bottom: 15px;
        }
        .import-export-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        /* Nascondi l'input file, useremo il bottone per attivarlo */
        #import-file-input {
            display: none;
        }

         /* (Alpha 27) Stile Toast */
        #toast-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--toast-bg);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        #toast-message.visible {
            opacity: 1;
        }
        
        /* (Alpha 36) Stile per il contenitore del grafico */
        #chart-container {
            width: 100%;
            max-width: 600px; /* Consistente col container */
            margin: 20px 0;
            padding: 10px;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: var(--card-shadow); /* (Alpha 40) */
            border: none; /* (Alpha 40) */
        }
        #expense-chart {
            max-height: 400px; /* Limita altezza su mobile */
        }
		@keyframes fadeSlide {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.total-box,
.expense-category-item,
.category-summary-item {
  animation: fadeSlide 0.4s ease-out;
}

.category-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

/* Modal: usa variabili (sfondo scuro + testo chiaro) */
body.theme-dark .modal-content {
  background-color: var(--card-bg);    /* evita sfondo bianco fisso */
  color: var(--text-color);            /* testo leggibile */
  border: 1px solid var(--border-color);
}

/* Pulsanti secondari: stato active più scuro in dark mode */
body.theme-dark .btn-secondary:active {
  background-color: rgba(255,255,255,0.04); /* leggero contrasto sul card-bg */
  border-color: var(--border-color);
  box-shadow: none;
}

/* Rimuove sfondi chiari hardcoded su item attivi */
body.theme-dark .expense-list-item:active,
body.theme-dark .category-summary-item:active,
body.theme-dark .category-item .category-name:active {
  background-color: rgba(255,255,255,0.02); /* contrasto leggero compatibile */
  color: var(--text-color);
  box-shadow: none;
}

/* Toast: testo scuro su sfondo chiaro era già gestito; forziamo contrasto opposto se necessario */
body.theme-dark #toast-message {
  background-color: var(--toast-bg);
  color: var(--text-color);
}

/* Input/label/select già gestiti; assicuriamoci che il testo del modal di conferma (bottoni) sia leggibile */
body.theme-dark .modal-actions .btn,
body.theme-dark .modal-actions .btn-secondary,
body.theme-dark .modal-actions .btn-danger {
  color: white;
}
/* Sfondo dei control form per contrasto in dark mode */
body.theme-dark input,
body.theme-dark textarea,
body.theme-dark select {
  background-color: var(--input-bg) !important;
  border-color: var(--border-color) !important;
}

/* Placeholder leggibile */
body.theme-dark input::placeholder,
body.theme-dark textarea::placeholder {
  color: rgba(241,241,241,0.6) !important; /* usa --text-color chiaro se vuoi */
}

/* Forza colore dei bottoni/testo dentro modali e toast */
body.theme-dark .modal-content,
body.theme-dark .modal-content input,
body.theme-dark .modal-content textarea,
body.theme-dark #toast-message {
  color: var(--text-color) !important;
}

/* (Alpha 78, 85 & 91) Aggiunge spazio sotto l'header sticky */
        #history-selector-group, /* (Alpha 91) Sostituito #monthly-history-grid */
        #view-expenses-grid,
        #no-expenses-message,
        #category-selection-grid,
        #manage-categories-screen #existing-categories-block, /* (Alpha 85) */
        #data-screen .import-export-section, /* (Alpha 85) */
        #edit-category-screen .card:first-of-type,
        #add-expense-amount-screen .card:first-of-type,
        #expense-list,
        #weekly-detail-list,
        #weekly-category-detail-list,
        #edit-expense-screen .card:first-of-type,
        #chart-screen .card:first-of-type {
            margin-top: 20px;
        }

/* --- (Alpha 94) Stile Barra di Navigazione --- */
        .bottom-nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 65px; /* Altezza base */
            background-color: var(--card-bg);
            border-top: 1px solid var(--glass-border);
            -webkit-backdrop-filter: blur(14px);
            backdrop-filter: blur(14px);
            
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            
            /* Spazio per la home bar di iOS */
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .nav-btn {
            background-color: transparent;
            border: none;
            padding: 4px 0 0 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            color: var(--secondary-text-color);
            cursor: pointer;
            transition: color 0.2s;
            height: 100%;
        }
        
        .nav-btn svg {
            width: 26px;
            height: 26px;
            stroke-width: 1.5;
        }
        
        .nav-btn span {
            font-size: 10px;
            margin-top: 4px;
        }
        
        .nav-btn.active {
            color: var(--primary-color);
        }
        
        .nav-btn:active {
            transform: scale(0.95);
        }
        
        /* Stile Speciale Pulsante Aggiungi */
        .nav-btn-add-special {
            /* Sovrascrive il colore per renderlo sempre primario */
            color: var(--primary-color);
        }
        .nav-btn-add-special svg {
            width: 40px; /* Più grande */
            height: 40px;
            stroke-width: 1.5;
        }
        
        /* Adatta il container per non finire sotto la barra */
        .container {
             /* Aumentiamo il padding inferiore per fare spazio alla barra */
             padding-bottom: 100px; 
        }
        /* (Alpha 96) Rimuove il testo dal pulsante "Aggiungi" per fare spazio */
        .nav-btn-add-special span {
            display: none;
        }
        
        /* (Alpha 96) Centra l'icona "+" ora che il testo è sparito */
        .nav-btn-add-special svg {
            width: 44px; /* Leggermente più grande per riempire lo spazio */
            height: 44px;
        }
        /* --- (Alpha 98) Stile Overlays Fissi --- */
        .fixed-overlay-container {
            position: fixed;
            bottom: 80px; /* Altezza tab bar (65px) + 15px spazio */
            left: 15px;
            right: 15px;
            z-index: 999;
            display: flex;
            justify-content: space-between; /* Spinge i 2 elementi ai lati */
            align-items: center;
            pointer-events: none; /* Rende il contenitore "invisibile" ai click */
            padding-bottom: env(safe-area-inset-bottom); /* Spazio per iOS Home Bar */
        }
        
        /* Rende cliccabili solo i figli */
        .fixed-overlay-container > * {
            pointer-events: auto;
        }

        #app-version-fixed {
            font-size: 11px;
            color: var(--secondary-text-color);
            opacity: 0.7;
        }
        
        /* Nascondi la versione se non siamo in Home */
        #home-screen.hidden + .fixed-overlay-container #app-version-fixed {
            display: none;
        }

        #theme-toggle-btn {
            background-color: var(--card-bg);
            color: var(--secondary-text-color);
            border: 1px solid var(--glass-border);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            -webkit-backdrop-filter: blur(14px);
            backdrop-filter: blur(14px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        #theme-toggle-btn:active {
            transform: scale(0.95);
        }
        #theme-toggle-btn span {
            font-size: 24px;
        }
    /* --- (Alpha 100) Stile Header "App" (Solo Tema Scuro) --- */
        body.theme-pro-dark .header {
            /* Sfondo grigio scuro (campionato dalla foto) */
            background: #1C1C1E; 
            /* Rimuove l'animazione del gradiente blu */
            animation: none;
            
            /* (Alpha 100) Aggiunge un bordo inferiore per staccare */
            border-bottom: 1px solid #333;
        }

        body.theme-pro-dark .header h1 {
            /* (v100-fix) Aggiunto 'color: transparent' per rimuovere warning */
            color: transparent; 
            
            /* Gradiente per il testo (campionato dalla foto) */
            background: linear-gradient(90deg, #5A7BED, #C764E3);
            -webkit-background-clip: text; /* Per Chrome/Safari */
            -webkit-text-fill-color: transparent; /* Per Chrome/Safari */
            background-clip: text; /* Standard (per Firefox) */
            /* La riga 'text-fill-color' è stata rimossa perché non è standard */
        }    
    </style>
    
</head>

<body>
    
    <!-- Contenitore Principale -->
    <div class="container" id="main-container"> 
        
        <!-- Schermata Home -->
        <div id="home-screen">
            <div class="header">
                 <!-- (Alpha 41) Layout header modificato -->
                 <h1>Gestione Spese</h1>
                 <p id="current-date"></p>
                 <!-- (Alpha 55) Nuovo riquadro icone spese fisse -->
                 <div id="fixed-expenses-summary">
                     <!-- Icone caricate da JS -->
                 </div>
                 <div id="monthly-budget-summary">
                      <h4>BUDGET RESIDUO:</h4>
                      <p class="remaining-budget">€0.00</p>
                 </div>
            </div>

            <!-- Riquadri Totali (Alpha 4 / Alpha 11 / Alpha 13 / Alpha 19 / Alpha 41) -->
            <div class="summary-cards">
                <!-- (Alpha 19) Ordine invertito: Mese prima, Settimana dopo -->
                <div class="total-box" id="monthly-box">
                    <!-- (Alpha 41) Icona Mese -->
                    <div class="total-box-icon" id="monthly-icon-bg">
                      <img src="icone/30.png" alt="Icona 30" class="summary-icon-img" />
                    </div>
                    <div class="total-box-text">
                        <h3>Questo Mese</h3>
                        <span id="monthly-name" class="date-range"></span> <!-- (Alpha 11) -->
                        <p id="monthly-total">€0.00</p>
                    </div>
                </div>
                
                <div class="total-box" id="weekly-box">
                    <div class="total-box-icon" id="weekly-icon-bg">
                       <img src="icone/7.png" alt="Icona 7" class="summary-icon-img" />
                    </div>
                    <div class="total-box-text">
                        <h3>Questa Settimana</h3>
                        <span id="weekly-date-range" class="date-range"></span> <!-- (Alpha 2) -->
                        <p id="weekly-total">€0.00</p>
                    </div>
                </div>
            </div>
                   
        </div>

        <!-- Schermata Aggiungi Spesa (Scelta Categoria) -->
        <div id="add-expense-category-screen" class="hidden">
            <div class="header">
                 <div class="header-top">
                    <div>
                        <h1>Scegli Categoria</h1>
                        <p>Seleziona una categoria per la tua spesa.</p>
                    </div>
                 </div>
            </div>
            <div class="category-grid" id="category-selection-grid">
                <!-- Categorie caricate da JS -->
            </div>
            <div class="actions" style="margin-top: 20px;">
                 <!-- (Alpha 4) Pulsante Gestisci rimosso -->
                 <button class="btn btn-danger" id="back-to-home-from-add-btn">Annulla</button>
            </div>
        </div>
        
        <!-- Schermata Gestione Categorie (Alpha 1 / Alpha 16) -->
<div id="manage-categories-screen" class="hidden">
            <div class="header">
                 <div class="header-top">
                    <div>
                        <h1>Gestisci Categorie</h1>
                        <p>Aggiungi, rimuovi o modifica le tue categorie.</p>
                    </div>
                 </div>
            </div>

            <div id="existing-categories-block">
                <h3>Categorie Esistenti</h3>
                <div class="category-grid" id="manage-category-list">
                    </div>
            </div>

            <div class="card" style="margin-top: 20px;">
                 <h3>Aggiungi Nuova Categoria</h3>
                <div class="input-group">
                    <label for="new-category-name">Nuova Categoria</label>
                    <input type="text" id="new-category-name" placeholder="Es. Benzina">
                </div>
                <div class="input-group">
                     <label>
                        <input type="checkbox" id="new-category-is-preset"> Spesa Fissa?
                    </label>
                </div>
                 <div class="input-group hidden" id="new-category-preset-value-group">
                    <label for="new-category-preset-value">Importo Fisso (€)</label>
                    <input type="number" id="new-category-preset-value" placeholder="Es. 10" step="0.01">
                </div>
                <div class="input-group hidden" id="new-category-recurring-group">
                  <label>
                    <input type="checkbox" id="new-category-recurring"> Spesa Ricorrente (ogni mese)
                  </label>
                </div>
                <div class="input-group hidden" id="new-category-icon-select-group">
                    <label>Icona</label>
                    <div class="icon-select-grid" id="new-category-icon-select">
                        </div>
                </div>
                <div id="new-category-budget-fields">
                    <div class="input-group">
                        <label for="new-category-budget-type">Tipo Budget Categoria</label>
                        <select id="new-category-budget-type">
                            <option value="none" selected>Nessuno</option>
                            <option value="weekly">Settimanale</option>
                            <option value="monthly">Mensile</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="new-category-budget-value">Valore Budget Categoria (Opz.)</label>
                        <input type="number" id="new-category-budget-value" placeholder="Es. 50" step="0.01">
                    </div>
                </div>
                <button class="btn" id="save-category-btn">Aggiungi Categoria</button>
            </div>
            
            <div class="card">
                 <h3>Budget Mensile</h3> <div class="input-group">
                     <label for="global-monthly-budget">Imposta Budget (€)</label>
                     <input type="number" id="global-monthly-budget" placeholder="Es. 500" step="0.01">
                 </div>
                 <button class="btn" id="save-global-budget-btn">Salva Budget</button>
            </div>
            <div class="actions" style="margin-top: 20px;">
                <button class="btn btn-secondary" id="back-to-home-from-manage-btn">Torna alla Home</button>
            </div>
        </div>
        
        <!-- (Alpha 5) Nuova Schermata Modifica Categoria (Alpha 16) -->
        <div id="edit-category-screen" class="hidden">
             <div class="header">
                 <!-- (Alpha 41) Header semplice per schermate secondarie -->
                 <div class="header-top">
                    <div>
                        <h1 id="edit-category-title">Modifica Categoria</h1>
                    </div>
                 </div>
            </div>
            <div class="card">
                <div class="input-group">
                    <label for="edit-category-name">Nome Categoria</label>
                    <input type="text" id="edit-category-name">
                </div>
                <!-- --- (Alpha 16) Aggiunta Scelta Tipo Budget --- -->
                 <!-- --- (Alpha 22) Modificato per Categoria Predefinita --- -->
                <div class="input-group">
                     <label>
                        <!-- (Alpha 39) Testo modificato -->
                        <input type="checkbox" id="edit-category-is-preset"> Spesa Fissa?
                    </label>
                </div>
                 <div class="input-group hidden" id="edit-category-preset-value-group">
                     <!-- (Alpha 39) Testo modificato -->
                    <label for="edit-category-preset-value">Importo Fisso (€)</label>
                    <input type="number" id="edit-category-preset-value" placeholder="Es. 10" step="0.01">
                </div>
				<div class="input-group">
  <label>
    <input type="checkbox" id="edit-category-recurring"> Spesa Ricorrente (ogni mese)
  </label>
</div>
                 <!-- (Alpha 55) Selettore Icone -->
                <div class="input-group hidden" id="edit-category-icon-select-group">
                    <label>Icona</label>
                    <div class="icon-select-grid" id="edit-category-icon-select">
                        <!-- Icone caricate da JS -->
                    </div>
                </div>
                <div id="edit-category-budget-fields">
                    <div class="input-group">
                        <label for="edit-category-budget-type">Tipo Budget Categoria</label>
                        <select id="edit-category-budget-type">
                            <option value="none">Nessuno</option>
                            <option value="weekly">Settimanale</option>
                            <option value="monthly">Mensile</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="edit-category-budget-value">Valore Budget Categoria (Opz.)</label>
                        <input type="number" id="edit-category-budget-value" placeholder="Es. 50" step="0.01">
                    </div>
                 </div>
                <!-- --- Fine Modifica --- -->
            </div>
            <div class="actions" style="grid-template-columns: 1fr 1fr; gap: 12px;">
                <button class="btn btn-danger" id="cancel-edit-category-btn">Annulla</button>
                <button class="btn" id="confirm-edit-category-btn">Salva Modifiche</button>
            </div>
        </div>

        <!-- Schermata Aggiungi Spesa (Importo) (Alpha 1) -->
        <div id="add-expense-amount-screen" class="hidden">
            <div class="header">
                 <!-- (Alpha 41) Header semplice per schermate secondarie -->
                 <div class="header-top">
                    <div>
                        <h1 id="add-amount-title">Aggiungi Spesa</h1>
                    </div>
                 </div>
            </div>
            <div class="card">
                <div class="input-group">
                    <label for="expense-amount">Importo (€)</label>
                    <input type="number" id="expense-amount" placeholder="0.00" step="0.01">
                </div>
                <div class="input-group">
                    <label for="expense-note">Nota (opzionale)</label>
					<div class="input-group">
  <label>
    <input type="checkbox" id="expense-recurring"> Spesa Ricorrente (ogni mese)
  </label>
</div>
                    <textarea id="expense-note" placeholder="Es. Spesa settimanale"></textarea>
                </div>
            </div>
            <div class="actions" style="grid-template-columns: 1fr 1fr; gap: 12px;">
                <button class="btn btn-danger" id="cancel-add-amount-btn">Annulla</button>
                <button class="btn" id="confirm-expense-btn">Conferma</button>
            </div>
        </div>

        <!-- Schermata Visualizza Spese (Settimanali per Categoria) (Alpha 1) -->
        <div id="view-expenses-screen" class="hidden">
            <div class="header">
                 <!-- (Alpha 41) Header semplice per schermate secondarie -->
                 <div class="header-top">
                    <div>
                        <h1>Spese della Settimana</h1>
                        <p>Riepilogo per categoria (solo spese variabili).</p>
                    </div>
                 </div>
            </div>
            
            <!-- Messaggio "Nessuna spesa" (Alpha 1) -->
            <div id="no-expenses-message" class="hidden">
                <h3>Nessuna spesa questa settimana</h3>
                <p>Inizia aggiungendo una nuova spesa dalla Home.</p>
            </div>
            <div class="category-grid" id="view-expenses-grid">
                <!-- Riepiloghi spese caricati da JS -->
            </div>
            <div class="actions" style="margin-top: 20px;">
                <button class="btn btn-secondary" id="back-to-home-from-view-btn">Torna alla Home</button>
            </div>
			
        </div>

        <!-- Schermata Dettaglio Categoria (Elenco Spese) (Alpha 1) -->
        <div id="category-detail-screen" class="hidden">
            <div class="header">
                 <!-- (Alpha 41) Header semplice per schermate secondarie -->
                 <div class="header-top">
                    <div>
                        <h1 id="category-detail-title">Dettaglio Spese Categoria</h1>
                        <p>Elenco delle spese mensili variabili per questa categoria.</p>
                    </div>
                 </div>
            </div>
            
            <div id="expense-list">
                <!-- Elenco spese caricato da JS -->
            </div>

            <div class="actions" style="margin-top: 20px;">
                <button class="btn btn-secondary" id="back-to-view-from-detail-btn">Torna Indietro</button>
            </div>
        </div>
        
        <!-- (Alpha 3) Nuova Schermata Storico Mensile -->
        <div id="monthly-history-screen" class="hidden">
            <div class="header">
                 <div class="header-top">
                    <div>
                        <h1 id="monthly-history-title">Riepilogo del Mese</h1>
                        <p>Totali per settimana (TUTTE LE SPESE). Clicca per i dettagli.</p>
                    </div>
                 </div>
            </div>
            
            <div class="input-group" id="history-selector-group" style="grid-template-columns: 1fr 1fr; gap: 10px; display: grid; margin-bottom: 12px;">
                <select id="history-month-select" style="padding: 12px; font-size: 16px; text-align: center; border-radius: 8px;">
                    </select>
                <select id="history-year-select" style="padding: 12px; font-size: 16px; text-align: center; border-radius: 8px;">
                    </select>
            </div>
            
            <div class="category-grid" id="monthly-history-grid">
                 </div>
            
            <h3 style="margin-top: 30px; margin-bottom: 15px; padding-left: 5px;">Riepilogo Categorie del Mese</h3>
            <div id="monthly-category-summary-list">
                </div>

            <div class="actions" style="margin-top: 20px;">
                <button class="btn btn-secondary" id="back-to-home-from-monthly-btn">Torna alla Home</button>
            </div>
        </div>
        
        <!-- (Alpha 36 / Alpha 37) Nuova Schermata Dettaglio Settimana (da Storico Mese) -->
        <div id="weekly-detail-screen" class="hidden">
            <div class="header">
                 <!-- (Alpha 41) Header semplice per schermate secondarie -->
                 <div class="header-top">
                    <div>
                        <h1 id="weekly-detail-title">Dettaglio Settimana</h1>
                        <!-- (Alpha 39) Testo modificato -->
                        <p>Riepilogo per categoria (TUTTE LE SPESE). Clicca per i dettagli.</p> <!-- (Alpha 37) Modificato -->
                    </div>
                 </div>
            </div>
            
             <!-- (Alpha 37) Modificato: ora è un elenco di riepiloghi, non spese -->
            <div id="weekly-detail-list">
                <!-- Riepilogo per categorie caricato da JS -->
            </div>

            <div class="actions" style="margin-top: 20px;">
                <button class="btn btn-secondary" id="back-to-history-from-weekly-detail-btn">Torna al Mese</button>
            </div>
        </div>
        
        <!-- (Alpha 37) Nuova Schermata Dettaglio Categoria Settimanale -->
         <div id="weekly-category-detail-screen" class="hidden">
            <div class="header">
                 <!-- (Alpha 41) Header semplice per schermate secondarie -->
                 <div class="header-top">
                    <div>
                        <h1 id="weekly-category-detail-title">Dettaglio Categoria</h1>
                        <p>Elenco delle spese per la settimana e categoria selezionate.</p>
                    </div>
                 </div>
            </div>
            
            <div id="weekly-category-detail-list">
                <!-- Elenco spese caricato da JS -->
            </div>

            <div class="actions" style="margin-top: 20px;">
                <button class="btn btn-secondary" id="back-to-weekly-detail-from-cat-btn">Torna alla Settimana</button>
            </div>
        </div>


        <!-- Schermata Modifica Spesa (Alpha 1) -->
        <div id="edit-expense-screen" class="hidden">
            <div class="header">
                 <!-- (Alpha 41) Header semplice per schermate secondarie -->
                 <div class="header-top">
                    <div>
                        <h1 id="edit-expense-title">Modifica Spesa</h1>
                    </div>
                 </div>
            </div>
            <div class="card">
                <div class="input-group">
                    <label for="edit-expense-amount">Importo (€)</label>
                    <input type="number" id="edit-expense-amount" placeholder="0.00" step="0.01">
                </div>
                <div class="input-group">
                    <label for="edit-expense-note">Nota (opzionale)</label>
                    <textarea id="edit-expense-note" placeholder="Es. Spesa settimanale"></textarea>
                </div>
                
                <div class="input-group">
                    <label for="edit-expense-category-select">Sposta Categoria</label>
                    <select id="edit-expense-category-select">
                        </select>
                </div>
                
            </div>
            <div class="actions" style="grid-template-columns: 1fr 1fr; gap: 12px;">
                <button class="btn btn-danger" id="cancel-edit-btn">Annulla</button>
                <button class="btn" id="confirm-edit-btn">Salva Modifiche</button>
            </div>
            <!-- (Alpha 53) Pulsante Elimina Spesa RIMOSSO da qui -->
            <!--
            <div class="actions" style="margin-top: 20px;">
                <button class="btn btn-danger" id="delete-expense-btn">Elimina Spesa</button>
            </div>
            -->
        </div>
        
        <!-- (Alpha 36) Nuova Schermata Grafico Spese -->
        <div id="chart-screen" class="hidden">
            <div class="header">
                 <!-- (Alpha 41) Header semplice per schermate secondarie -->
                 <div class="header-top">
                    <div>
                        <h1>Grafico Spese</h1>
                        <p>Suddivisione delle spese per categoria.</p>
                    </div>
                 </div>
            </div>
            
            <div class="card">
                <div class="input-group" style="margin-bottom: 0;">
                    <label for="chart-category-select">Scegli Categoria</label>
                    <select id="chart-category-select">
                        <!-- Opzioni caricate da JS -->
                    </select>
					<div class="input-group" style="margin-top: 15px;">
  <label for="chart-period">Periodo</label>
  <select id="chart-period">
    <option value="week">Settimana in corso</option>
    <option value="month" selected>Mese in corso</option>
    <option value="year">Anno in corso</option>
  </select>
</div>

                </div>
            </div>
            
            <div id="chart-container">
                <canvas id="pie-chart" style="margin-top:20px; max-height:400px;"></canvas>			
            </div>

            <div class="actions" style="margin-top: 20px;">
                <button class="btn btn-secondary" id="back-to-home-from-chart-btn">Torna alla Home</button>
            </div>
        </div>
<div id="data-screen" class="hidden">
            <div class="header">
                 <div class="header-top">
                    <div>
                        <h1>Backup e Dati</h1>
                        <p>Importa o esporta i dati della tua app.</p>
                    </div>
                 </div>
            </div>
            <!-- (Alpha 26) Sezione Import/Export -->
            <div class="import-export-section">
                <h3>Backup Dati</h3>
                <div class="import-export-actions">
                    <button class="btn btn-secondary" id="import-btn">Importa Dati</button>
                    <button class="btn btn-secondary" id="export-btn">Esporta Dati</button>
                    <input type="file" id="import-file-input" accept=".json">
                </div>
            </div>

            <div class="manual-transfer-section" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                <h3>Trasferimento Manuale (Copia/Incolla)</h3>
                <p style="font-size: 14px; color: var(--secondary-text-color);">Per trasferire dati tra dispositivi/browser (es. da Dropbox a Netlify).</p>
                <div class="input-group">
                    <label for="manual-data-textarea">Testo di Backup/Importazione</label>
                    <textarea id="manual-data-textarea" style="height: 120px; font-size: 10px; line-height: 1.2; width: 100%;" placeholder="1. Clicca 'Mostra Dati' e Copia.&#10;2. Incolla in questo box sulla nuova app.&#10;3. Clicca 'Importa Dati Incollati'."></textarea>
                </div>
                <div class="import-export-actions">
                    <button class="btn btn-secondary" id="manual-export-show-btn">Mostra Dati</button>
                    <button class="btn" id="manual-import-process-btn">Importa Dati Incollati</button>
                </div>
            </div>
            <div class="actions" style="margin-top: 20px;">
                <button class="btn btn-secondary" id="back-to-home-from-data-btn">Torna alla Home</button>
            </div>
        </div>
    </div>
    
    <!-- Modale di Conferma Personalizzato (Alpha 1 / Alpha 27) -->
    <div id="custom-modal" class="modal-overlay hidden"> <!-- Modificato per animazione -->
        <div class="modal-content">
            <h3 id="modal-title">Sei sicuro?</h3>
            <p id="modal-text">Questa azione è irreversibile.</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="modal-cancel-btn">Annulla</button>
                <button class="btn btn-danger" id="modal-confirm-btn">Conferma</button>
            </div>
        </div>
    </div>
    
    <!-- (Alpha 27) Toast Message -->
    <div id="toast-message">Messaggio Toast</div>
    <div class="fixed-overlay-container">
        <div id="app-version-fixed">V0.0.0</div>
        <button id="theme-toggle-btn"><span>🌙</span></button>
    </div>
<nav class="bottom-nav-bar">
        <button class="nav-btn" id="nav-btn-home">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
            </svg>
            <span>Home</span>
        </button>
        <button class="nav-btn" id="nav-btn-chart">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h12A2.25 2.25 0 0 0 20.25 14.25V3M3.75 21h16.5M3.75 3h16.5M3.75 3v.007c0 .14.114.257.257.257H6.31a.257.257 0 0 0 .257-.257V3m0 3.75v.007c0 .14.114.257.257.257H6.31a.257.257 0 0 0 .257-.257V6.75m0 3.75v.007c0 .14.114.257.257.257H6.31a.257.257 0 0 0 .257-.257V10.5m-3.75 6.75h16.5c.621 0 1.125-.504 1.125-1.125V6.75c0-.621-.504-1.125-1.125-1.125H3.75c-.621 0-1.125.504-1.125 1.125v9.375c0 .621.504 1.125 1.125 1.125Z" />
            </svg>
            <span>Grafico</span>
        </button>
        <button class="nav-btn nav-btn-add-special" id="nav-btn-add">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
            </svg>
            <span>Aggiungi</span>
        </button>
        <button class="nav-btn" id="nav-btn-data">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
            </svg>
            <span>Dati</span>
        </button>
        <button class="nav-btn" id="nav-btn-manage">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h3m-3 12h3m-6-6h9" />
            </svg>

             <span>Gestisci</span>
        </button>

    </nav>
<script>
        // JAVASCRIPT: Tutta la logica dell'app (Versione v92 - Stabile)
        
        document.addEventListener('DOMContentLoaded', () => {
            Chart.register(ChartDataLabels); // Registra il plugin per le etichette

            // (Alpha 55) Aggiunte icone SVG
            const PRESET_ICONS = {
              'home': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                      fill="#20c997" stroke="#0f5132" stroke-width="1.5">
                <path d="M3 12l9-9 9 9v9a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1z"/>
              </svg>`,
            
              'car': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                      fill="#9333ea" stroke="#6b21a8" stroke-width="1.5">
                <path d="M3 13l2-5a2 2 0 0 1 1.9-1.3h10.2a2 2 0 0 1 1.9 1.3l2 5v6a1 1 0 0 1-1 1h-1a2 2 0 0 1-4 0H9a2 2 0 0 1-4 0H4a1 1 0 0 1-1-1v-6z"/>
                <circle cx="7.5" cy="18.5" r="1.5" fill="#1f2937"/>
                <circle cx="16.5" cy="18.5" r="1.5" fill="#1f2937"/>
              </svg>`,
            
              'phone': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                      fill="#fd7e14" stroke="#7c2d12" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" 
                      d="M2.25 6.75c0-1.243 1.007-2.25 2.25-2.25h2.25c.621 0 1.152.448 1.227 1.065l.348 2.784a1.125 1.125 0 01-.324.945l-1.26 1.26a16.5 16.5 0 007.29 7.29l1.26-1.26c.267-.267.66-.39 1.045-.324l2.784.348c.617.075 1.065.606 1.065 1.227V19.5c0 1.243-1.007 2.25-2.25 2.25h-1.5C8.268 21.75 2.25 15.732 2.25 8.25v-1.5z"/>
              </svg>`,
            
              'card': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                      fill="#4A69E2" stroke="#1e3a8a" stroke-width="1.5">
                <rect x="2" y="5" width="20" height="14" rx="2" ry="2"/>
                <line x1="2" y1="10" x2="22" y2="10" stroke="#fff" stroke-width="1.5"/>
              </svg>`,
            
              'euro': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                      fill="#ffc107" stroke="#b45309" stroke-width="1.5">
                <path d="M17 7a6 6 0 00-11.5 3H3m2.5 4A6 6 0 0017 17h1m-15-4h15"/>
              </svg>`
            };

            const ICON_KEYS = Object.keys(PRESET_ICONS);

            // Calcolo Versione        numero versione
            const buildNumber = 100; 
            const patch = buildNumber % 100; 
            const minor = Math.floor(buildNumber / 100) % 10; 
            const major = Math.floor(buildNumber / 1000); 
            const versionString = `V${major}.${minor}.${patch}`;
            
            // Seleziona tutti gli elementi DOM necessari
            const screens = {
                home: document.getElementById('home-screen'),
                addCategory: document.getElementById('add-expense-category-screen'),
                manageCategories: document.getElementById('manage-categories-screen'),
                addAmount: document.getElementById('add-expense-amount-screen'),
                viewExpenses: document.getElementById('view-expenses-screen'),
                categoryDetail: document.getElementById('category-detail-screen'), 
                editExpense: document.getElementById('edit-expense-screen'), 
                editCategory: document.getElementById('edit-category-screen'), 
                monthlyHistory: document.getElementById('monthly-history-screen'),
                weeklyDetail: document.getElementById('weekly-detail-screen'),
                weeklyCategoryDetail: document.getElementById('weekly-category-detail-screen'),
                chart: document.getElementById('chart-screen'),
                data: document.getElementById('data-screen'),
            };

            const elements = {
                mainContainer: document.getElementById('main-container'), 
                currentDate: document.getElementById('current-date'),
                weeklyTotal: document.getElementById('weekly-total'),
                monthlyTotal: document.getElementById('monthly-total'),
                weeklyDateRange: document.getElementById('weekly-date-range'), 
                monthlyName: document.getElementById('monthly-name'), 
                monthlyBudgetSummary: document.getElementById('monthly-budget-summary'), 
                fixedExpensesSummary: document.getElementById('fixed-expenses-summary'), 
                categorySelectionGrid: document.getElementById('category-selection-grid'),
                addAmountTitle: document.getElementById('add-amount-title'),
                expenseAmount: document.getElementById('expense-amount'),
                expenseNote: document.getElementById('expense-note'),
				expenseRecurring: document.getElementById('expense-recurring'),
                confirmExpenseBtn: document.getElementById('confirm-expense-btn'), 
                viewExpensesGrid: document.getElementById('view-expenses-grid'),
                newCategoryName: document.getElementById('new-category-name'),
                newCategoryIsPresetCheckbox: document.getElementById('new-category-is-preset'),
                newCategoryPresetValueGroup: document.getElementById('new-category-preset-value-group'),
                newCategoryPresetValueInput: document.getElementById('new-category-preset-value'),
                newCategoryIconSelectGroup: document.getElementById('new-category-icon-select-group'), 
                newCategoryIconSelect: document.getElementById('new-category-icon-select'), 
                newCategoryRecurring: document.getElementById('new-category-recurring'), 
                newCategoryBudgetFieldsDiv: document.getElementById('new-category-budget-fields'),
                newCategoryBudgetType: document.getElementById('new-category-budget-type'), 
                newCategoryBudgetValue: document.getElementById('new-category-budget-value'),
                saveCategoryBtn: document.getElementById('save-category-btn'),
                manageCategoryList: document.getElementById('manage-category-list'),
                noExpensesMessage: document.getElementById('no-expenses-message'), 
                weeklyBox: document.getElementById('weekly-box'),
                monthlyBox: document.getElementById('monthly-box'),
                monthlyHistoryTitle: document.getElementById('monthly-history-title'),
                monthlyHistoryGrid: document.getElementById('monthly-history-grid'),
                categoryDetailTitle: document.getElementById('category-detail-title'),
                expenseList: document.getElementById('expense-list'),
                editExpenseTitle: document.getElementById('edit-expense-title'),
                editExpenseAmount: document.getElementById('edit-expense-amount'),
                editExpenseNote: document.getElementById('edit-expense-note'),
                editExpenseCategorySelect: document.getElementById('edit-expense-category-select'), 
                confirmEditBtn: document.getElementById('confirm-edit-btn'),
                editCategoryTitle: document.getElementById('edit-category-title'),
                editCategoryName: document.getElementById('edit-category-name'),
                editCategoryIsPresetCheckbox: document.getElementById('edit-category-is-preset'),
                editCategoryPresetValueGroup: document.getElementById('edit-category-preset-value-group'),
                editCategoryPresetValueInput: document.getElementById('edit-category-preset-value'),
				editCategoryRecurring: document.getElementById('edit-category-recurring'),
                editCategoryIconSelectGroup: document.getElementById('edit-category-icon-select-group'), 
                editCategoryIconSelect: document.getElementById('edit-category-icon-select'), 
                editCategoryBudgetFieldsDiv: document.getElementById('edit-category-budget-fields'),
                editCategoryBudgetType: document.getElementById('edit-category-budget-type'), 
                editCategoryBudgetValue: document.getElementById('edit-category-budget-value'),
                confirmEditCategoryBtn: document.getElementById('confirm-edit-category-btn'), 
                importBtn: document.getElementById('import-btn'),
                exportBtn: document.getElementById('export-btn'),
                importFileInput: document.getElementById('import-file-input'),
                toastMessage: document.getElementById('toast-message'), 
                globalMonthlyBudgetInput: document.getElementById('global-monthly-budget'),
                saveGlobalBudgetBtn: document.getElementById('save-global-budget-btn'),
                chartCategorySelect: document.getElementById('chart-category-select'),
                historyMonthSelect: document.getElementById('history-month-select'),
                historyYearSelect: document.getElementById('history-year-select'),
                monthlyCategorySummaryList: document.getElementById('monthly-category-summary-list'), 
                weeklyDetailTitle: document.getElementById('weekly-detail-title'),
                weeklyDetailList: document.getElementById('weekly-detail-list'),
                weeklyCategoryDetailTitle: document.getElementById('weekly-category-detail-title'),
                weeklyCategoryDetailList: document.getElementById('weekly-category-detail-list'),
                manualExportShowBtn: document.getElementById('manual-export-show-btn'),
                manualImportProcessBtn: document.getElementById('manual-import-process-btn'),
                manualDataTextarea: document.getElementById('manual-data-textarea'),
                
                // (Alpha 94) Pulsanti Nuova Navigazione
                navBtnHome: document.getElementById('nav-btn-home'),
                navBtnChart: document.getElementById('nav-btn-chart'),
                navBtnAdd: document.getElementById('nav-btn-add'),
                navBtnData: document.getElementById('nav-btn-data'),
                navBtnManage: document.getElementById('nav-btn-manage'),
                appVersionFixed: document.getElementById('app-version-fixed'), // (Alpha 98)
                themeToggleBtn: document.getElementById('theme-toggle-btn') // (Alpha 98)
            }; 

            const backButtons = {
                backToHomeFromAdd: document.getElementById('back-to-home-from-add-btn'),
                backToHomeFromView: document.getElementById('back-to-home-from-view-btn'),
                cancelAddAmount: document.getElementById('cancel-add-amount-btn'),
                backToHomeFromManage: document.getElementById('back-to-home-from-manage-btn'), 
                backToViewFromDetail: document.getElementById('back-to-view-from-detail-btn'), 
                cancelEditBtn: document.getElementById('cancel-edit-btn'), 
                cancelEditCategory: document.getElementById('cancel-edit-category-btn'), 
                backToHomeFromMonthly: document.getElementById('back-to-home-from-monthly-btn'),
                backToHomeFromChart: document.getElementById('back-to-home-from-chart-btn'),
                backToHistoryFromWeeklyDetail: document.getElementById('back-to-history-from-weekly-detail-btn'),
                backToWeeklyDetailFromCat: document.getElementById('back-to-weekly-detail-from-cat-btn'),
                backToHomeFromData: document.getElementById('back-to-home-from-data-btn')
            };
            
            const modal = {
                overlay: document.getElementById('custom-modal'),
                title: document.getElementById('modal-title'),
                text: document.getElementById('modal-text'),
                cancelBtn: document.getElementById('modal-cancel-btn'),
                confirmBtn: document.getElementById('modal-confirm-btn'),
            };

            let state = {
                currentScreen: 'home',
                expenses: [], 
                categories: [], 
                globalMonthlyBudget: 0, 
                selectedCategory: null,
                selectedCategoryForDetail: null, 
                editingExpenseId: null, 
                editingCategoryId: null, 
                modalCallback: null, 
                toastTimeout: null, 
                selectedWeekForDetail: null, 
                selectedCategoryForWeeklyDetail: null, 
                expenseListReturnScreen: 'categoryDetail', 
                tempSelectedIcon: null, 
                viewingMonth: null, 
                viewingYear: null,
            };
            
            // --- GESTIONE DATI ---
            function loadData() {
                try {
                    const savedExpenses = localStorage.getItem('expenses');
                    const savedCategories = localStorage.getItem('categories');
                    const savedGlobalBudget = localStorage.getItem('globalMonthlyBudget'); 

                    state.expenses = savedExpenses ? JSON.parse(savedExpenses) : [];
                    state.globalMonthlyBudget = savedGlobalBudget ? parseFloat(savedGlobalBudget) : 0; 

                    if (savedCategories) {
                        state.categories = JSON.parse(savedCategories);
                        
                        let needsSave = false;
                        state.categories.forEach(cat => {
                            if (cat.budget !== undefined) { 
                                cat.budgetType = 'weekly';
                                cat.budgetValue = cat.budget;
                                delete cat.budget; 
                                needsSave = true;
                            }
                            if (!cat.budgetType) { 
                                cat.budgetType = 'none';
                                cat.budgetValue = null;
                                needsSave = true; 
                            }
                            if (cat.isSpecial === undefined) {
                                cat.isSpecial = false;
                                cat.presetValue = null;
                                needsSave = true;
                            }
                            if (cat.isSpecial && !cat.icon) {
                                cat.icon = 'euro';
                                needsSave = true;
                            }
                        });
                        if (needsSave) {
                            saveCategories(); 
                        }
                        
                    } else {
                        // Categorie di default
                        state.categories = [
                            { id: 1, name: 'Alimentari', budgetType: 'weekly', budgetValue: 100, isSpecial: false, presetValue: null, icon: null },
                            { id: 2, name: 'Benzina', budgetType: 'monthly', budgetValue: 200, isSpecial: false, presetValue: null, icon: null },
                            { id: 3, name: 'Ristorante', budgetType: 'weekly', budgetValue: 80, isSpecial: false, presetValue: null, icon: null },
                            { id: 4, name: 'Affitto', budgetType: 'none', budgetValue: null, isSpecial: true, presetValue: 500, icon: 'home' }, 
                            { id: 5, name: 'Caffè', budgetType: 'none', budgetValue: null, isSpecial: true, presetValue: 1.20, icon: 'euro' }, 
                        ];
                        saveCategories();
                    }
                } catch (e) {
                    console.error("Errore caricamento localStorage: ", e);
                    state.expenses = [];
                    state.categories = [];
                    state.globalMonthlyBudget = 0; 
                     showModal('Errore Dati', 'Impossibile caricare i dati. Modalità privata?', () => {});
                }
            }

            function saveExpenses() {
                try {
                    localStorage.setItem('expenses', JSON.stringify(state.expenses));
                } catch (e) { console.error("Errore salvataggio spese: ", e); showModal('Errore Salvataggio', 'Impossibile salvare le spese.', () => {}); }
            }
            
            function saveCategories() {
                 try {
                    localStorage.setItem('categories', JSON.stringify(state.categories));
                 } catch (e) { console.error("Errore salvataggio categorie: ", e); showModal('Errore Salvataggio', 'Impossibile salvare le categorie.', () => {}); }
            }

            function saveGlobalBudget() {
                 try {
                     localStorage.setItem('globalMonthlyBudget', state.globalMonthlyBudget.toString());
                 } catch (e) { console.error("Errore salvataggio budget globale: ", e); showModal('Errore Salvataggio', 'Impossibile salvare il budget mensile.', () => {}); }
            }
            // --- FINE GESTIONE DATI ---

            // --- LOGICA MODALE ---
           function showModal(title, text, onConfirm) {
              modal.title.textContent = title;
              modal.text.textContent = text;
              state.modalCallback = onConfirm;
              modal.overlay.classList.remove('hidden');
              requestAnimationFrame(() => {
                modal.overlay.classList.add('visible');
              });
            }

            function hideModal() {
              modal.overlay.classList.remove('visible');
              setTimeout(() => {
                if (!modal.overlay.classList.contains('visible')) {
                  modal.overlay.classList.add('hidden');
                  state.modalCallback = null;
                }
              }, 200); 
            }

            modal.cancelBtn.addEventListener('click', hideModal);
            modal.confirmBtn.addEventListener('click', () => {
                 if (state.modalCallback) {
                    state.modalCallback(); 
                }
                hideModal();
            });
            modal.overlay.addEventListener('click', (event) => {
                 if (event.target === modal.overlay) { 
                     hideModal();
                 }
            });

            // --- LOGICA TOAST ---
            function showToast(message) {
                 if (state.toastTimeout) {
                    clearTimeout(state.toastTimeout);
                    elements.toastMessage.classList.remove('visible'); 
                 }
                void elements.toastMessage.offsetWidth; 

                elements.toastMessage.textContent = message;
                elements.toastMessage.classList.add('visible');

                state.toastTimeout = setTimeout(() => {
                    elements.toastMessage.classList.remove('visible');
                    state.toastTimeout = null;
                }, 3000);
            }

            // --- UTILITY PER LE DATE ---
            function getWeekRange(date) {
                const today = new Date(date.getTime()); 
                const dayOfWeek = today.getDay(); 
                const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; 
                const monday = new Date(new Date(today).setDate(today.getDate() + diffToMonday));
                const sunday = new Date(new Date(monday).setDate(monday.getDate() + 6)); 
                const formatDate = (d) => d.toLocaleString('it-IT', { day: '2-digit', month: '2-digit' });
                return `Lun (${formatDate(monday)}) - Dom (${formatDate(sunday)})`;
             }
            function getWeekNumber(d) {
                if (!(d instanceof Date) || isNaN(d)) { return getWeekNumber(new Date()); }
                d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
                const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
                return weekNo;
             }
            function getWeekOfMonth(date) {
                if (!(date instanceof Date) || isNaN(date)) { date = new Date(); }
                const firstDayOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);
                const firstDayOfWeek = firstDayOfMonth.getDay() === 0 ? 6 : firstDayOfMonth.getDay() - 1; 
                const offset = (date.getDate() + firstDayOfWeek - 1);
                return Math.floor(offset / 7) + 1;
            }

            function isPresetExpense(expense) {
                const category = state.categories.find(c => c.id === expense.categoryId);
                return category && (category.isSpecial === true || category.isFixed === true);
            }

// --- NAVIGAZIONE ---
            function navigate(screenName) {
                // (Alpha 94) Aggiorna stato attivo Tab Bar
                const buttons = [
                    elements.navBtnHome, elements.navBtnChart, elements.navBtnAdd,
                    elements.navBtnData, elements.navBtnManage
                ];
                buttons.forEach(btn => btn.classList.remove('active'));

                // Associa la schermata al pulsante corretto
                if (screenName === 'home') elements.navBtnHome.classList.add('active');
                else if (screenName === 'chart') elements.navBtnChart.classList.add('active');
                else if (screenName === 'addCategory' || screenName === 'addAmount') elements.navBtnAdd.classList.add('active');
                else if (screenName === 'data') elements.navBtnData.classList.add('active');
                else if (screenName === 'manageCategories' || screenName === 'editCategory') elements.navBtnManage.classList.add('active');
                
                // Codice esistente...
                state.currentScreen = screenName;
                Object.values(screens).forEach(screen => screen.classList.add('hidden'));
                if (screens[screenName]) { 
                    screens[screenName].classList.remove('hidden');
                } else {
                    console.error(`Schermata non trovata: ${screenName}`);
                    screens.home.classList.remove('hidden'); // Fallback
                }
                 switch (screenName) {
                    case 'home': renderHomeScreen(); break; 
                    case 'addCategory': renderCategorySelectionScreen(); break; 
                    case 'manageCategories': renderManageCategoriesScreen(); break; 
                    case 'viewExpenses': renderViewExpensesScreen(); break; 
                    case 'categoryDetail': renderCategoryDetailScreen(); break; 
                    case 'editExpense': renderEditExpenseScreen(); break; 
                    case 'editCategory': renderEditCategoryScreen(); break; 
                    case 'monthlyHistory':
                        renderMonthlyHistoryScreen(); 
                        break;
                    case 'weeklyDetail': renderWeeklyDetailScreen(); break; 
                    case 'weeklyCategoryDetail': renderWeeklyCategoryDetailScreen(); break; 
                    case 'chart': renderChartScreen(); break; 
                    case 'data': break;
                }
            }
                function navigate(screenName) {
                // (Alpha 94) Aggiorna stato attivo Tab Bar
                const buttons = [
                    elements.navBtnHome, elements.navBtnChart, elements.navBtnAdd,
                    elements.navBtnData, elements.navBtnManage
                ];
                buttons.forEach(btn => btn.classList.remove('active'));

                // Associa la schermata al pulsante corretto
                if (screenName === 'home') elements.navBtnHome.classList.add('active');
                else if (screenName === 'chart') elements.navBtnChart.classList.add('active');
                else if (screenName === 'addCategory' || screenName === 'addAmount') elements.navBtnAdd.classList.add('active');
                else if (screenName === 'data') elements.navBtnData.classList.add('active');
                else if (screenName === 'manageCategories' || screenName === 'editCategory') elements.navBtnManage.classList.add('active');
                
                // Codice esistente...
                state.currentScreen = screenName;
                Object.values(screens).forEach(screen => screen.classList.add('hidden'));
                state.currentScreen = screenName;
                Object.values(screens).forEach(screen => screen.classList.add('hidden'));
                if (screens[screenName]) { 
                    screens[screenName].classList.remove('hidden');
                } else {
                    console.error(`Schermata non trovata: ${screenName}`);
                    screens.home.classList.remove('hidden'); // Fallback
                }
                 switch (screenName) {
                    case 'home': renderHomeScreen(); break; 
                    case 'addCategory': renderCategorySelectionScreen(); break; 
                    case 'manageCategories': renderManageCategoriesScreen(); break; 
                    case 'viewExpenses': renderViewExpensesScreen(); break; 
                    case 'categoryDetail': renderCategoryDetailScreen(); break; 
                    case 'editExpense': renderEditExpenseScreen(); break; 
                    case 'editCategory': renderEditCategoryScreen(); break; 
                    case 'monthlyHistory':
                        renderMonthlyHistoryScreen(); 
                        break;
                    case 'weeklyDetail': renderWeeklyDetailScreen(); break; 
                    case 'weeklyCategoryDetail': renderWeeklyCategoryDetailScreen(); break; 
                    case 'chart': renderChartScreen(); break; 
                    case 'data': break;
                }
            }

            // --- FUNZIONI DI VISUALIZZAZIONE ---
            
            function renderHomeScreen() {
                 const now = new Date();
                 const weekOfMonth = getWeekOfMonth(now);
                 const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0); 
                 const totalWeeksInMonth = getWeekOfMonth(lastDayOfMonth);
                 const dateString = now.toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                 const weekString = `Settimana ${weekOfMonth} su ${totalWeeksInMonth}`;
                 elements.currentDate.innerHTML = `${dateString}<br>${weekString}`;
                 
                 const weekRangeString = getWeekRange(now);
                 elements.weeklyDateRange.textContent = weekRangeString;
                 let monthName = now.toLocaleDateString('it-IT', { month: 'long' });
                 monthName = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                 elements.monthlyName.textContent = `(${monthName})`;
                 const currentWeek = getWeekNumber(now);
                 const currentMonth = now.getMonth();
                 const currentYear = now.getFullYear();

                 const weeklyExpenses = state.expenses.filter(e => {
                     try { 
                         const d = new Date(e.date); 
                         return !isNaN(d) && 
                                getWeekNumber(d) === currentWeek && 
                                d.getFullYear() === currentYear &&
                                !isPresetExpense(e); 
                    } catch(err){ return false; }
                 });
                 
                 const monthlyExpenses = state.expenses.filter(e => {
                     try { const d = new Date(e.date); return !isNaN(d) && d.getMonth() === currentMonth && d.getFullYear() === currentYear; } catch(err){ return false; }
                 });
                 
                 const weeklyTotal = weeklyExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
                 const monthlyTotal = monthlyExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
                 elements.weeklyTotal.textContent = `€${weeklyTotal.toFixed(2)}`;
                 elements.monthlyTotal.textContent = `€${monthlyTotal.toFixed(2)}`;

                 if (state.globalMonthlyBudget > 0) {
                     const remaining = state.globalMonthlyBudget - monthlyTotal;
                     elements.monthlyBudgetSummary.innerHTML = `
                        <h4>BUDGET RESIDUO:</h4>
                        <p class="remaining-budget">€${remaining.toFixed(2)}</p>
                     `;
                 } else {
                     elements.monthlyBudgetSummary.innerHTML = `
                        <h4>BUDGET RESIDUO:</h4>
                        <p class="remaining-budget" style="font-size: 11px; color: var(--secondary-text-color); font-weight: normal;">Non impostato</p>
                     `; 
                 }
                 
                 elements.fixedExpensesSummary.innerHTML = ''; 
                 const monthlyFixedExpenses = monthlyExpenses.filter(isPresetExpense);
                 const paidCategoryIds = new Set(monthlyFixedExpenses.map(e => e.categoryId));
                 
                 paidCategoryIds.forEach(catId => {
                    const category = state.categories.find(c => c.id === catId);
                    if (category && category.icon && PRESET_ICONS[category.icon]) {
                        const iconWrapper = document.createElement('div');
                        iconWrapper.className = 'summary-icon-item';
                        iconWrapper.title = category.name; 
                        iconWrapper.innerHTML = PRESET_ICONS[category.icon];
                        elements.fixedExpensesSummary.appendChild(iconWrapper);
                    }
                 });
             }
             
             function renderCategorySelectionScreen() { 
                 elements.categorySelectionGrid.innerHTML = ''; 
                 const sortedCategories = [...state.categories].sort((a, b) => a.name.localeCompare(b.name));
                 sortedCategories.forEach(cat => {
                    const item = document.createElement('div');
                    item.className = 'category-item';
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'category-name';
                    nameSpan.textContent = cat.name;
                    nameSpan.addEventListener('click', () => {
                        const clickedCategory = state.categories.find(c => c.id === cat.id); 
                        if (!clickedCategory) { console.error("Categoria non trovata:", cat.id); return; }

                        if (clickedCategory.isSpecial && clickedCategory.presetValue > 0) {
                             addPresetExpense(clickedCategory);
                        } else {
                            state.selectedCategory = clickedCategory.id;
                            elements.addAmountTitle.textContent = `Spesa per ${clickedCategory.name}`;
                            navigate('addAmount');
                        }
                    });
                    item.appendChild(nameSpan);
                    elements.categorySelectionGrid.appendChild(item);
                 });
             }
             
             function renderManageCategoriesScreen() {
                 elements.globalMonthlyBudgetInput.value = state.globalMonthlyBudget > 0 ? state.globalMonthlyBudget : '';
                 elements.manageCategoryList.innerHTML = '';
                 const sortedCategories = [...state.categories].sort((a, b) => a.name.localeCompare(b.name));
                 sortedCategories.forEach(cat => {
                     const item = document.createElement('div');
                     item.className = 'category-item';
                     const nameSpan = document.createElement('span');

                     nameSpan.className = 'category-name'; 
                     nameSpan.textContent = cat.name;
                     const currentCatId = cat.id; 
                     nameSpan.addEventListener('click', () => {
                        state.editingCategoryId = currentCatId; 
                        navigate('editCategory');
                     });
                     const deleteIcon = document.createElement('div');
                     deleteIcon.className = 'delete-icon';
                     deleteIcon.innerHTML = '&times;'; 
                     deleteIcon.addEventListener('click', () => {
                        showModal(
                            'Elimina Categoria', 
                            `Sei sicuro di voler eliminare la categoria "${cat.name}"? Verranno eliminate anche tutte le spese associate.`, 
                            () => deleteCategory(currentCatId) 
                        );
                     });
                     
                     if (cat.isSpecial && cat.icon && PRESET_ICONS[cat.icon]) {
                         const iconEl = document.createElement('div');
                         iconEl.style.color = 'var(--primary-color)';
                         iconEl.style.marginTop = '5px';
                         iconEl.innerHTML = PRESET_ICONS[cat.icon];
                         iconEl.querySelector('svg').style.width = '20px';
                         iconEl.querySelector('svg').style.height = '20px';
                         iconEl.querySelector('svg').style.margin = 'auto';
                         nameSpan.insertAdjacentElement('beforebegin', iconEl);
                     }
                     
                     item.appendChild(nameSpan);
                     item.appendChild(deleteIcon);
                     elements.manageCategoryList.appendChild(item);
                 });
                 
                 renderIconSelection('new-category-icon-select', 'euro'); 
                 state.tempSelectedIcon = 'euro'; 
             }
             
             function renderEditCategoryScreen() { 
                 const category = state.categories.find(c => c.id === state.editingCategoryId);
                 if (!category) { navigate('manageCategories'); return; }
                 elements.editCategoryTitle.textContent = `Modifica: ${category.name}`;
                 elements.editCategoryName.value = category.name;
                 elements.editCategoryIsPresetCheckbox.checked = category.isSpecial || false; 
                 
                 const selectedIcon = category.icon || 'euro'; 
                 state.tempSelectedIcon = selectedIcon; 
                 renderIconSelection('edit-category-icon-select', selectedIcon);
                 
                 handlePresetToggleEdit(); 
                 
                 if (category.isSpecial) { 
                    elements.editCategoryPresetValueInput.value = category.presetValue || '';
					elements.editCategoryRecurring.checked = !!category.recurring;
                 } else {
                    elements.editCategoryBudgetType.value = category.budgetType || 'none';
                    elements.editCategoryBudgetValue.value = (category.budgetValue && category.budgetValue > 0) ? category.budgetValue : '';
                 }
                 elements.editCategoryIsPresetCheckbox.removeEventListener('change', handlePresetToggleEdit); 
                 elements.editCategoryIsPresetCheckbox.addEventListener('change', handlePresetToggleEdit);
             }
             
             function renderIconSelection(containerId, selectedIconName) {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = '';
                
                ICON_KEYS.forEach(iconName => {
                    const item = document.createElement('div');
                    item.className = 'icon-select-item';
                    item.dataset.icon = iconName;
                    item.innerHTML = PRESET_ICONS[iconName];
                    
                    if (iconName === selectedIconName) {
                        item.classList.add('selected');
                    }
                    
                    item.addEventListener('click', () => {
                        state.tempSelectedIcon = iconName;
                        container.querySelectorAll('.icon-select-item').forEach(el => el.classList.remove('selected'));
                        item.classList.add('selected');
                    });
                    
                    container.appendChild(item);
                });
             }
             
             function renderViewExpensesScreen() { 
                 const now = new Date();
                 const currentWeek = getWeekNumber(now);
                 const currentYear = now.getFullYear();
                 const currentMonth = now.getMonth();

                 const weeklyExpenses = state.expenses.filter(e => {
                     try { 
                         const expenseDate = new Date(e.date); 
                         return !isNaN(expenseDate) && 
                                getWeekNumber(expenseDate) === currentWeek && 
                                expenseDate.getFullYear() === currentYear &&
                                !isPresetExpense(e); 
                    } catch(err) { return false; }
                 });
                 
                 if (weeklyExpenses.length === 0) {
                    elements.noExpensesMessage.classList.remove('hidden');
                    elements.viewExpensesGrid.classList.add('hidden');
                    return; 
                 }
                 elements.noExpensesMessage.classList.add('hidden');
                 elements.viewExpensesGrid.classList.remove('hidden');
                 
                 elements.viewExpensesGrid.innerHTML = ''; 
                 state.categories.forEach(cat => {
                    if (cat.isSpecial) return; 

                    const weeklyCategoryExpenses = weeklyExpenses.filter(e => e.categoryId === cat.id);
                    if (weeklyCategoryExpenses.length === 0) return; 
                    
                    const weeklyTotal = weeklyCategoryExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
                    
                    const monthlyCategoryExpenses = state.expenses.filter(e => {
                         try { 
                             const expenseDate = new Date(e.date); 
                             return !isNaN(expenseDate) && 
                                    e.categoryId === cat.id && 
                                    expenseDate.getMonth() === currentMonth && 
                                    expenseDate.getFullYear() === currentYear &&
                                    !isPresetExpense(e); 
                        } catch(err) { return false; }
                    });
                    const monthlyTotal = monthlyCategoryExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);

                    const item = document.createElement('div');
                    item.className = 'expense-category-item';
                    let percentage = 0;
                    let budgetHTML = '<p>Budget: N/D</p>';
                    
                    if (cat.budgetType === 'weekly' && cat.budgetValue > 0) {
                        percentage = (weeklyTotal / cat.budgetValue) * 100;
                        budgetHTML = `<p>Budget: €${cat.budgetValue.toFixed(2)} (Sett.)</p>`;
                    } else if (cat.budgetType === 'monthly' && cat.budgetValue > 0) {
                        percentage = (monthlyTotal / cat.budgetValue) * 100; 
                        budgetHTML = `<p>Budget: €${cat.budgetValue.toFixed(2)} (Mens.)</p>`;
                    }
                    
                    let colorClass = 'var(--green)'; 
                    if (percentage >= 33 && percentage < 66) colorClass = 'var(--yellow)';
                    else if (percentage >= 66 && percentage < 100) colorClass = 'var(--orange)';
                    else if (percentage >= 100) colorClass = 'var(--red)';
                    item.style.backgroundColor = colorClass; 
                    
                    item.innerHTML = `
                        <h4>${cat.name}</h4> 
                        ${budgetHTML} 
                        <div class="amount">€${weeklyTotal.toFixed(2)}</div>`;
                        
                    item.addEventListener('click', () => {
                        state.selectedCategoryForDetail = cat.id; 
                        navigate('categoryDetail'); 
                    });
                    elements.viewExpensesGrid.appendChild(item);
                 });
             }
             
            function renderMonthlyHistoryScreen() {
                const now = new Date();
                const currentMonth = state.viewingMonth; 
                const currentYear = state.viewingYear;

                const monthNames = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
                elements.historyMonthSelect.innerHTML = '';
                monthNames.forEach((name, index) => {
                    const option = document.createElement('option');
                    option.value = index; 
                    option.textContent = name;
                    if (index === currentMonth) option.selected = true;
                    elements.historyMonthSelect.appendChild(option);
                });

                let minYear = 2023;
                if (state.expenses.length > 0) {
                    const oldestExpense = state.expenses.reduce((oldest, e) => {
                        const d = new Date(e.date);
                        return d < oldest ? d : oldest;
                    }, new Date());
                    minYear = oldestExpense.getFullYear();
                }
                const maxYear = now.getFullYear();
                
                elements.historyYearSelect.innerHTML = '';
                for (let y = maxYear; y >= minYear; y--) {
                    const option = document.createElement('option');
                    option.value = y;
                    option.textContent = y;
                    if (y === currentYear) option.selected = true;
                    elements.historyYearSelect.appendChild(option);
                }

                elements.historyMonthSelect.onchange = () => {
                    state.viewingMonth = parseInt(elements.historyMonthSelect.value);
                    renderMonthlyHistoryScreen(); 
                };
                elements.historyYearSelect.onchange = () => {
                    state.viewingYear = parseInt(elements.historyYearSelect.value);
                    renderMonthlyHistoryScreen(); 
                };

                const selectedDate = new Date(currentYear, currentMonth, 1);
                elements.monthlyHistoryTitle.textContent = `Riepilogo: ${selectedDate.toLocaleDateString('it-IT', { month: 'long', year: 'numeric' })}`;
                 
                const monthlyExpenses = state.expenses.filter(e => {
                    try { 
                        const expenseDate = new Date(e.date); 
                        return !isNaN(expenseDate) && 
                               expenseDate.getMonth() === currentMonth && 
                               expenseDate.getFullYear() === currentYear;
                    } catch(err) { return false; }
                 });
                 
                elements.monthlyHistoryGrid.innerHTML = '';
                if (monthlyExpenses.length === 0) {
                    elements.monthlyHistoryGrid.innerHTML = '<p style="text-align:center; color: var(--secondary-text-color);">Nessuna spesa registrata per questo mese.</p>';
                    // Non fare return, dobbiamo mostrare il riepilogo categorie vuoto
                }
                 
                const expensesByWeek = {}; 
                monthlyExpenses.forEach(e => {
                     try { const expenseDate = new Date(e.date); if(isNaN(expenseDate)) throw new Error("Invalid date"); const weekOfMonth = getWeekOfMonth(expenseDate); if (!expensesByWeek[weekOfMonth]) expensesByWeek[weekOfMonth] = 0; expensesByWeek[weekOfMonth] += (e.amount || 0); } catch(err) { console.error("Error processing monthly history:", e, err); }
                 });
                 
                const sortedWeeks = Object.keys(expensesByWeek).sort((a, b) => parseInt(a) - parseInt(b));
                sortedWeeks.forEach(weekNum => {
                    const total = expensesByWeek[weekNum];
                    const item = document.createElement('div');
                    item.className = 'expense-category-item'; 
                    item.style.backgroundColor = 'var(--primary-color)'; 
                    item.innerHTML = `<h4>Settimana ${weekNum}</h4> <div class="amount">€${total.toFixed(2)}</div>`;
                    
                    item.addEventListener('click', () => {
                        state.selectedWeekForDetail = parseInt(weekNum);
                        navigate('weeklyDetail');
                    });

                    elements.monthlyHistoryGrid.appendChild(item);
                });
                
                elements.monthlyCategorySummaryList.innerHTML = ''; 
                
                const expensesByCategory = {};
                monthlyExpenses.forEach(e => {
                    if (!expensesByCategory[e.categoryId]) {
                        expensesByCategory[e.categoryId] = 0;
                    }
                    expensesByCategory[e.categoryId] += (e.amount || 0);
                });
                
                const sortedCategoryIds = Object.keys(expensesByCategory).sort((a, b) => expensesByCategory[b] - expensesByCategory[a]);

                if (sortedCategoryIds.length === 0 && monthlyExpenses.length > 0) {
                     elements.monthlyCategorySummaryList.innerHTML = '<p style="text-align:center; color: var(--secondary-text-color);">Errore nel raggruppamento categorie.</p>';
                     return;
                }

                sortedCategoryIds.forEach(catId => {
                    const category = state.categories.find(c => c.id == catId);
                    if (!category) return; 
                    
                    const categoryName = category.name;
                    const total = expensesByCategory[catId];
                    
                    const item = document.createElement('div');
                    item.className = 'category-summary-item'; 
                    item.style.cursor = 'default'; 
                    
                    item.innerHTML = `
                        <div class="details">${categoryName}</div>
                        <div class="amount">€${total.toFixed(2)}</div>
                    `;
                    elements.monthlyCategorySummaryList.appendChild(item);
                });
            }
             
             function renderCategoryDetailScreen() { 
                 const categoryId = state.selectedCategoryForDetail;
                 if (!categoryId) { navigate('viewExpenses'); return; }
                 const category = state.categories.find(c => c.id === categoryId);
                 if (!category) { navigate('viewExpenses'); return; }
                 elements.categoryDetailTitle.textContent = `Dettaglio: ${category.name}`;
                 elements.expenseList.innerHTML = ''; 
                 const now = new Date();
                 const currentMonth = now.getMonth();
                 const currentYear = now.getFullYear();
                 
                 const categoryMonthlyExpenses = state.expenses.filter(e => {
                    try { 
                        const expenseDate = new Date(e.date); 
                        return !isNaN(expenseDate) && 
                               e.categoryId === categoryId && 
                               expenseDate.getMonth() === currentMonth && 
                               expenseDate.getFullYear() === currentYear &&
                               !isPresetExpense(e); 
                    } catch(err) { return false; }
                 });

                 if (categoryMonthlyExpenses.length === 0) {
                    elements.expenseList.innerHTML = '<p style="text-align:center; color: var(--secondary-text-color);">Nessuna spesa variabile registrata per questa categoria questo mese.</p>';
                    return;
                 }
                 categoryMonthlyExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));
                 categoryMonthlyExpenses.forEach(e => {
                    const item = document.createElement('div');
                    item.className = 'expense-list-item';
                    const expenseDate = new Date(e.date);
                    const formattedDate = expenseDate.toLocaleDateString('it-IT', { day: '2-digit', month: 'short' });
                    const formattedTime = expenseDate.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                    
                    const deleteIcon = document.createElement('div');
                    deleteIcon.className = 'delete-icon';
                    deleteIcon.innerHTML = '&times;';
                    const expenseId = e.id; 
                    deleteIcon.addEventListener('click', (evt) => {
                        evt.stopPropagation(); 
                        handleDeleteExpense(expenseId, 'categoryDetail');
                    });

                    item.innerHTML = `<div class="details"> ${formattedDate} - ${formattedTime} ${e.note ? `<div class="note">${e.note}</div>` : ''} </div> <div class="amount">€${(e.amount || 0).toFixed(2)}</div>`;
                    
                    item.addEventListener('click', () => {
                        state.expenseListReturnScreen = 'categoryDetail'; 
                        state.editingExpenseId = e.id; 
                        navigate('editExpense'); 
                    });
                    
                    item.appendChild(deleteIcon); 
                    elements.expenseList.appendChild(item);
                 });
             }
             
            function renderWeeklyDetailScreen() {
                const weekNum = state.selectedWeekForDetail;
                const currentMonth = state.viewingMonth; 
                const currentYear = state.viewingYear;

                if (!weekNum || currentMonth === null || currentYear === null) { 
                    navigate('monthlyHistory'); 
                    return; 
                }

                elements.weeklyDetailTitle.textContent = `Dettaglio Spese: Settimana ${weekNum}`;
                elements.weeklyDetailList.innerHTML = ''; 
                
                const weeklyExpenses = state.expenses.filter(e => {
                    try { 
                        const expenseDate = new Date(e.date); 
                        return !isNaN(expenseDate) && 
                               expenseDate.getMonth() === currentMonth && 
                               expenseDate.getFullYear() === currentYear &&
                               getWeekOfMonth(expenseDate) === weekNum;
                    } catch(err) { return false; }
                 });

                 if (weeklyExpenses.length === 0) {
                    elements.weeklyDetailList.innerHTML = '<p style="text-align:center; color: var(--secondary-text-color);">Nessuna spesa registrata per questa settimana.</p>';
                    return;
                 }
                 
                 const expensesByCategory = {};
                 weeklyExpenses.forEach(e => {
                    if (!expensesByCategory[e.categoryId]) {
                        expensesByCategory[e.categoryId] = 0;
                    }
                    expensesByCategory[e.categoryId] += (e.amount || 0);
                 });
                 
                 const sortedCategoryIds = Object.keys(expensesByCategory).sort((a, b) => expensesByCategory[b] - expensesByCategory[a]);

                 sortedCategoryIds.forEach(catId => {
                    const category = state.categories.find(c => c.id == catId);
                    const categoryName = category ? category.name : "Sconosciuta";
                    const total = expensesByCategory[catId];
                    
                    const item = document.createElement('div');
                    item.className = 'category-summary-item'; 
                    item.innerHTML = `
                        <div class="details">${categoryName}</div>
                        <div class="amount">€${total.toFixed(2)}</div>
                    `;
                        
                    item.addEventListener('click', () => {
                        state.selectedCategoryForWeeklyDetail = catId; 
                        navigate('weeklyCategoryDetail'); 
                    });
                    elements.weeklyDetailList.appendChild(item);
                 });
            } 

             function renderWeeklyCategoryDetailScreen() {
                 const weekNum = state.selectedWeekForDetail;
                 const categoryId = state.selectedCategoryForWeeklyDetail;
                 const currentMonth = state.viewingMonth;
                 const currentYear = state.viewingYear;
                 
                 if (!weekNum || !categoryId || currentMonth === null || currentYear === null) { 
                     navigate('weeklyDetail'); 
                     return; 
                 }
                 
                 const category = state.categories.find(c => c.id == categoryId);
                 const categoryName = category ? category.name : "Sconosciuta";
                 elements.weeklyCategoryDetailTitle.textContent = `${categoryName} (Sett. ${weekNum})`;
                 elements.weeklyCategoryDetailList.innerHTML = '';
                 
                 const expenses = state.expenses.filter(e => {
                    try { 
                        const expenseDate = new Date(e.date); 
                        return !isNaN(expenseDate) && 
                               e.categoryId == categoryId && 
                               expenseDate.getMonth() === currentMonth && 
                               expenseDate.getFullYear() === currentYear &&
                               getWeekOfMonth(expenseDate) === weekNum;
                    } catch(err) { return false; }
                 });
                 
                 if (expenses.length === 0) {
                    elements.weeklyCategoryDetailList.innerHTML = '<p style="text-align:center; color: var(--secondary-text-color);">Nessuna spesa trovata.</p>';
                    return;
                 }
                 
                 expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
                 
                 expenses.forEach(e => {
                    const item = document.createElement('div');
                    item.className = 'expense-list-item';
                    const expenseDate = new Date(e.date);
                    const formattedDate = expenseDate.toLocaleDateString('it-IT', { day: '2-digit', month: 'short' });
                    const formattedTime = expenseDate.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                    
                    const deleteIcon = document.createElement('div');
                    deleteIcon.className = 'delete-icon';
                    deleteIcon.innerHTML = '&times;';
                    const expenseId = e.id; 
                    deleteIcon.addEventListener('click', (evt) => {
                        evt.stopPropagation(); 
                        handleDeleteExpense(expenseId, 'weeklyCategoryDetail');
                    });

                    item.innerHTML = `
                        <div class="details">
                            ${formattedDate} - ${formattedTime}
                            ${e.note ? `<div class="note">${e.note}</div>` : ''}
                        </div>
                        <div class="amount">€${(e.amount || 0).toFixed(2)}</div>`;
                        
                    item.addEventListener('click', () => {
                        state.expenseListReturnScreen = 'weeklyCategoryDetail'; 
                        state.editingExpenseId = e.id; 
                        navigate('editExpense'); 
                    });
                    
                    item.appendChild(deleteIcon); 
                    elements.weeklyCategoryDetailList.appendChild(item);
                 });
             }
             
             function renderEditExpenseScreen() { 
                 const expense = state.expenses.find(e => e.id === state.editingExpenseId);
                 if (!expense) { 
                     navigate(state.expenseListReturnScreen || 'home'); 
                     return; 
                 }
                 const category = state.categories.find(c => c.id === expense.categoryId);
                 elements.editExpenseTitle.textContent = `Modifica Spesa (${category ? category.name : 'Sconosciuta'})`;
                 elements.editExpenseAmount.value = expense.amount || 0;
                 elements.editExpenseNote.value = expense.note || '';
                 
                 const select = elements.editExpenseCategorySelect;
                 select.innerHTML = ''; 
                 
                 const variableCategories = state.categories.filter(cat => !cat.isSpecial);
                 
                 variableCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    select.appendChild(option);
                 });
                 
                 select.value = expense.categoryId;
                 
                 elements.confirmEditBtn.onclick = saveExpenseEdit;
                 backButtons.cancelEditBtn.onclick = () => {
                    state.editingExpenseId = null; 
                    navigate(state.expenseListReturnScreen || 'home'); 
                 };
             }

            function renderChartScreen() {
                elements.chartCategorySelect.innerHTML = '<option value="all">Tutte le categorie</option>';
                const sortedCategories = [...state.categories]
                    .filter(cat => !cat.isSpecial) 
                    .sort((a, b) => a.name.localeCompare(b.name));
                    
                sortedCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    elements.chartCategorySelect.appendChild(option);
                });
                
                document.getElementById('chart-period').onchange = updateCharts;
                elements.chartCategorySelect.onchange = updateCharts;
                
                updateCharts();
            }

			// --- (Alpha 68) NUOVA SEZIONE GRAFICI ---
            function getCssColor(variableName) {
                return getComputedStyle(document.body).getPropertyValue(variableName).trim();
            }
            
            let pieChartInstance = null;

            function getFilteredExpenses() {
                const period = document.getElementById('chart-period').value;
                const categoryId = elements.chartCategorySelect.value;
                const now = new Date();

                let startDate, endDate;
                
                if (period === 'week') {
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1));
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    endDate.setHours(23, 59, 59, 999);
                } else if (period === 'month') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    endDate.setHours(23, 59, 59, 999);
                } else { // 'year'
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31);
                    endDate.setHours(23, 59, 59, 999);
                }

                return state.expenses.filter(e => {
                    const cat = state.categories.find(c => c.id === e.categoryId);
                    if (!cat || cat.isSpecial) return false;
                    const d = new Date(e.date);
                    if (isNaN(d)) return false;
                    const inDateRange = d >= startDate && d <= endDate;
                    const inCategory = (categoryId === 'all' || e.categoryId == categoryId);
                    return inDateRange && inCategory;
                });
            }

            function updateCharts() {
                const filteredExpenses = getFilteredExpenses();
                drawPieChart(filteredExpenses);
            }

            function drawPieChart(expenses) {
                if (pieChartInstance) {
                    pieChartInstance.destroy();
                }

                const totalsByCategory = {};
                expenses.forEach(e => {
                    const cat = state.categories.find(c => c.id === e.categoryId);
                    const catName = (cat ? cat.name : 'Sconosciuta');
                    totalsByCategory[catName] = (totalsByCategory[catName] || 0) + e.amount;
                });

                const labels = Object.keys(totalsByCategory);
                const data = Object.values(totalsByCategory);

                const pieCanvas = document.getElementById('pie-chart');
                if (data.length === 0 || data.every(d => d === 0)) {
                    pieCanvas.style.display = 'none';
                    return;
                }
                pieCanvas.style.display = 'block';

                const ctx = pieCanvas.getContext('2d');
                pieChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels,
                        datasets: [{
                            data,
                            backgroundColor: [
                                getCssColor('--primary-color'), getCssColor('--green'), getCssColor('--yellow'),
                                getCssColor('--orange'), getCssColor('--red'), getCssColor('--secondary-text-color')
                            ],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' },
                            datalabels: {
                                color: '#fff',
                                font: { weight: 'bold' },
                                formatter: (value, context) => {
                                    const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = (value / total) * 100;
                                    return percentage > 5 ? percentage.toFixed(0) + '%' : ''; 
                                }
                            }
                        }
                    }
                });
            }
            // --- FINE SEZIONE GRAFICI ---

            // --- AZIONI UTENTE ---
            function addExpense() {
                const amount = parseFloat(elements.expenseAmount.value);
                const note = elements.expenseNote.value.trim();
                const isRecurring = elements.expenseRecurring.checked; 
                
                if (!isFinite(amount) || amount <= 0) {
                    showModal('Errore', 'Inserisci un importo valido.', () => {});
                    return;
                }
                if (!state.selectedCategory) {
                    showModal('Errore', 'Categoria non selezionata.', () => {});
                    navigate('addCategory');
                    return;
                }
                
                elements.confirmExpenseBtn.disabled = true;

                state.expenses.push({
                    id: Date.now(),
                    categoryId: state.selectedCategory,
                    amount: amount,
                    note: note,
                    recurring: isRecurring, 
                    date: new Date().toISOString()
                });
                saveExpenses();

                elements.expenseAmount.value = '';
                elements.expenseNote.value = '';
                elements.expenseRecurring.checked = false; 
                state.selectedCategory = null;

                setTimeout(() => {
                    elements.confirmExpenseBtn.disabled = false;
                    navigate('home');
                }, 300);
            }             
            
            function addCategory() { 
                const name = elements.newCategoryName.value.trim();
                const isSpecial = elements.newCategoryIsPresetCheckbox.checked; 
                const presetValue = parseFloat(elements.newCategoryPresetValueInput.value);
                const recurring = elements.newCategoryRecurring.checked; 
                const budgetType = elements.newCategoryBudgetType.value;
                const budgetValue = parseFloat(elements.newCategoryBudgetValue.value);
                const icon = state.tempSelectedIcon; 
                
                if (!name) { showModal('Errore', 'Inserisci un nome.', () => {}); return; }
                if (state.categories.length >= 50) { showModal('Limite Raggiunto', 'Massimo 50 categorie.', () => {}); return; }
                
                const newCategory = { id: Date.now(), name: name, isSpecial: isSpecial, presetValue: null, budgetType: 'none', budgetValue: null, icon: null, recurring: false }; 
                
                if (isSpecial) { 
                    if (!isNaN(presetValue) && presetValue > 0) { 
                        newCategory.presetValue = presetValue; 
                        newCategory.icon = icon || 'euro'; 
                        newCategory.recurring = recurring; 
                    } 
                    else { showModal('Errore', 'Importo fisso non valido.', () => {}); return; } 
                } else {
                     if (budgetType !== 'none' && !isNaN(budgetValue) && budgetValue > 0) { 
                        newCategory.budgetType = budgetType; 
                        newCategory.budgetValue = budgetValue; 
                    }
                }
                
                state.categories.push(newCategory); 
                saveCategories(); 
                
                elements.newCategoryName.value = ''; 
                elements.newCategoryIsPresetCheckbox.checked = false; 
                elements.newCategoryRecurring.checked = false; 
                handlePresetToggleAdd(); 
                elements.newCategoryPresetValueInput.value = ''; 
                elements.newCategoryBudgetType.value = 'none'; 
                elements.newCategoryBudgetValue.value = '';
                state.tempSelectedIcon = 'euro'; 
                renderIconSelection('new-category-icon-select', 'euro');
                
                renderManageCategoriesScreen(); 
            }
            
            function saveCategoryEdit() { 
                const newName = elements.editCategoryName.value.trim();
                const isSpecial = elements.editCategoryIsPresetCheckbox.checked; 
                const presetValue = parseFloat(elements.editCategoryPresetValueInput.value);
                const newBudgetType = elements.editCategoryBudgetType.value;
                const newBudgetValue = parseFloat(elements.editCategoryBudgetValue.value);
                const icon = state.tempSelectedIcon; 
                
                if (!newName) { showModal('Errore', 'Nome non valido.', () => {}); return; }
                if (!state.editingCategoryId) { showModal('Errore', 'ID non valido.', () => {}); return; }
                
                const categoryIndex = state.categories.findIndex(c => c.id === state.editingCategoryId);
                if (categoryIndex === -1) { navigate('manageCategories'); return; }
                
                state.categories[categoryIndex].name = newName; 
                state.categories[categoryIndex].isSpecial = isSpecial; 
                
                if (isSpecial) { 
                     if (!isNaN(presetValue) && presetValue > 0) { 
                        state.categories[categoryIndex].presetValue = presetValue;
						state.categories[categoryIndex].recurring = elements.editCategoryRecurring.checked;
						state.categories[categoryIndex].budgetType = 'none'; 
                        state.categories[categoryIndex].budgetValue = null;
                        state.categories[categoryIndex].icon = icon || 'euro'; 
                    } 
                     else { showModal('Errore', 'Importo fisso non valido.', () => {}); return; } 
                } else {
                    state.categories[categoryIndex].presetValue = null;
                    state.categories[categoryIndex].icon = null; 
                    if (newBudgetType !== 'none' && !isNaN(newBudgetValue) && newBudgetValue > 0) { 
                        state.categories[categoryIndex].budgetType = newBudgetType; 
                        state.categories[categoryIndex].budgetValue = newBudgetValue; 
                    } 
                    else { 
                        state.categories[categoryIndex].budgetType = 'none'; 
                        state.categories[categoryIndex].budgetValue = null; 
                    }
                }
                saveCategories(); 
                state.editingCategoryId = null; 
                state.tempSelectedIcon = 'euro'; 
                navigate('manageCategories');
            }
            
            function saveExpenseEdit() { 
                const newAmount = parseFloat(elements.editExpenseAmount.value);
                const newNote = elements.editExpenseNote.value.trim();
                const newCategoryId = parseInt(elements.editExpenseCategorySelect.value); 
                if (!newAmount || newAmount <= 0 || isNaN(newAmount)) { showModal('Errore', 'Importo non valido.', () => {}); return; }
                if (!state.editingExpenseId) { showModal('Errore', 'ID Spesa non valido.', () => {}); return; }
                const expenseIndex = state.expenses.findIndex(e => e.id === state.editingExpenseId);
                if (expenseIndex === -1) { navigate(state.expenseListReturnScreen || 'home'); return; } 
                state.expenses[expenseIndex].amount = newAmount; 
                state.expenses[expenseIndex].note = newNote;
                state.expenses[expenseIndex].categoryId = newCategoryId; 
                saveExpenses(); 
                state.editingExpenseId = null; 
                navigate(state.expenseListReturnScreen || 'home'); 
             }
             
            function deleteCategory(categoryId) { 
                state.categories = state.categories.filter(cat => cat.id !== categoryId); saveCategories();
                state.expenses = state.expenses.filter(expense => expense.categoryId !== categoryId); saveExpenses();
                renderManageCategoriesScreen(); 
            }
            
            function handleDeleteExpense(expenseId, returnScreen) {
              const expense = state.expenses.find(e => e.id === expenseId);
              if (!expense) return;
            
              showModal('Elimina Spesa', `Vuoi eliminare la spesa da €${expense.amount.toFixed(2)}?`, () => {
                state.expenses = state.expenses.filter(e => e.id !== expenseId);
                saveExpenses();
            
                elements.toastMessage.innerHTML = `Spesa eliminata 
                  <button id="undo-btn" style="margin-left:10px; color:yellow; background:none; border:none; cursor:pointer;">
                    Annulla
                  </button>`;
                elements.toastMessage.classList.add('visible');
            
                const undoBtn = document.getElementById('undo-btn');
                undoBtn.addEventListener('click', () => {
                  state.expenses.push(expense);
                  saveExpenses();
                  showToast('Eliminazione annullata');
                });
            
                setTimeout(() => elements.toastMessage.classList.remove('visible'), 4000);
                navigate(returnScreen || 'home');
              });
            }

            function deleteExpense() { 
                if (!state.editingExpenseId) { 
                    console.warn("deleteExpense chiamato senza editingExpenseId");
                    return; 
                }
                handleDeleteExpense(state.editingExpenseId, state.expenseListReturnScreen);
            }
            
            function addPresetExpense(category) { 
                 state.expenses.push({ id: Date.now(), categoryId: category.id, amount: category.presetValue, note: '', date: new Date().toISOString() });
                 const addedExpenseId = state.expenses[state.expenses.length - 1].id; saveExpenses(); 
                 const note = prompt(`Spesa di €${category.presetValue.toFixed(2)} per "${category.name}" aggiunta.\nNota (opzionale)?`);
                 if (note !== null && note.trim() !== '') {
                    const expenseIndex = state.expenses.findIndex(e => e.id === addedExpenseId);
                    if (expenseIndex !== -1) { state.expenses[expenseIndex].note = note.trim(); saveExpenses(); }
                 }
                 navigate('home'); 
            }
            
           function handlePresetToggleAdd() { 
                const isChecked = elements.newCategoryIsPresetCheckbox.checked; 
                elements.newCategoryPresetValueGroup.classList.toggle('hidden', !isChecked); 
                elements.newCategoryIconSelectGroup.classList.toggle('hidden', !isChecked); 
                document.getElementById('new-category-recurring-group').classList.toggle('hidden', !isChecked); 
                elements.newCategoryBudgetFieldsDiv.classList.toggle('hidden', isChecked); 
             }
             
            function handlePresetToggleEdit() { 
                 if (elements.editCategoryIsPresetCheckbox.checked) { 
                    elements.editCategoryPresetValueGroup.classList.remove('hidden'); 
                    elements.editCategoryIconSelectGroup.classList.remove('hidden'); 
                    elements.editCategoryBudgetFieldsDiv.classList.add('hidden'); 
                } 
                 else { 
                    elements.editCategoryPresetValueGroup.classList.add('hidden'); 
                    elements.editCategoryIconSelectGroup.classList.add('hidden'); 
                    elements.editCategoryBudgetFieldsDiv.classList.remove('hidden'); 
                }
            }
            
             function handleSaveGlobalBudget() { 
                 const budgetValue = parseFloat(elements.globalMonthlyBudgetInput.value);
                 if (!isNaN(budgetValue) && budgetValue >= 0) { state.globalMonthlyBudget = budgetValue; saveGlobalBudget(); showToast('Budget mensile salvato!'); renderHomeScreen(); } 
                 else { showModal('Errore', 'Valore budget non valido.', () => {}); }
             }

            // --- FUNZIONI IMPORT/EXPORT ---
            function exportData() { 
                try {
                    showToast("Preparazione file...");
                    const dataToExport = { categories: state.categories, expenses: state.expenses, globalMonthlyBudget: state.globalMonthlyBudget, appVersion: versionString, exportedAt: new Date().toISOString() };
                    const dataString = JSON.stringify(dataToExport, null, 2); 
                    const blob = new Blob([dataString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `spese_backup_${new Date().toISOString().split('T')[0]}.json`; 
                    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); 
                    setTimeout(() => showToast("File pronto! Controlla i Download o scegli 'Salva su File'."), 500); 
                } catch (error) { console.error("Errore esportazione:", error); showModal('Errore Esportazione', 'Problema during l\'esportazione.', () => {}); }
            }
            
            function importData() { elements.importFileInput.click(); }
            
            function handleFileImport(event) { 
                const file = event.target.files[0];
                if (!file) { return; }
                showToast("Lettura file..."); 
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (importedData && typeof importedData === 'object' && Array.isArray(importedData.categories) && Array.isArray(importedData.expenses)) {
                            showModal('Conferma Importazione', `Sovrascrivere i dati con ${importedData.categories.length} cat. e ${importedData.expenses.length} spese?`, () => {
                                state.categories = importedData.categories || []; 
                                state.expenses = importedData.expenses || []; 
                                state.globalMonthlyBudget = importedData.globalMonthlyBudget || 0; 
                                let needsSave = false;
                                state.categories.forEach(cat => {
                                    if (cat.budget !== undefined) { cat.budgetType = 'weekly'; cat.budgetValue = cat.budget; delete cat.budget; needsSave = true; }
                                    if (!cat.budgetType) { cat.budgetType = 'none'; cat.budgetValue = null; needsSave = true; }
                                    if (cat.isSpecial === undefined) { 
                                        cat.isSpecial = false; 
                                        cat.presetValue = null; 
                                        needsSave = true; 
                                    }
                                    if (cat.isSpecial && !cat.icon) {
                                        cat.icon = 'euro'; 
                                        needsSave = true;
                                    }
                                });
                                saveCategories(); saveExpenses(); saveGlobalBudget(); 
                                elements.importFileInput.value = null; 
                                showToast('Dati importati!'); 
                                navigate('home'); 
                            });
                        } else { showModal('Errore File', 'Struttura file non valida.', () => {}); }
                    } catch (error) { console.error("Errore parsing JSON:", error); showModal('Errore File', 'Impossibile leggere il file JSON.', () => {}); }
                    elements.importFileInput.value = null; 
                };
                reader.onerror = () => { showModal('Errore File', 'Impossibile leggere il file.', () => {}); elements.importFileInput.value = null; };
                reader.readAsText(file); 
            }
            
            function showManualExportData() {
                try {
                    const dataToExport = {
                        categories: state.categories,
                        expenses: state.expenses,
                        globalMonthlyBudget: state.globalMonthlyBudget,
                        appVersion: versionString,
                        exportedAt: new Date().toISOString()
                    };
                    const dataString = JSON.stringify(dataToExport);
                    elements.manualDataTextarea.value = dataString;
                    showToast("Dati pronti! Fai 'Seleziona Tutto' e 'Copia'.");
                    elements.manualDataTextarea.focus();
                    elements.manualDataTextarea.select();
                } catch (error) {
                    console.error("Errore esportazione manuale:", error);
                    showModal('Errore Esportazione', 'Problema during la preparazione dei dati.', () => {});
                }
            }
            
            function processManualImport() {
                const dataString = elements.manualDataTextarea.value;
                if (!dataString || dataString.trim() === '') {
                    showModal('Errore', 'Nessun dato incollato nel box.', () => {});
                    return;
                }
                showToast("Lettura dati...");
                try {
                    const importedData = JSON.parse(dataString);
                    if (importedData && typeof importedData === 'object' && Array.isArray(importedData.categories) && Array.isArray(importedData.expenses)) {
                        showModal('Conferma Importazione', `Stai per sovrascrivere i dati con ${importedData.categories.length} cat. e ${importedData.expenses.length} spese. Continuare?`, () => {
                            state.categories = importedData.categories || [];
                            state.expenses = importedData.expenses || [];
                            state.globalMonthlyBudget = importedData.globalMonthlyBudget || 0;
                            
                            let needsSave = false;
                            state.categories.forEach(cat => {
                                if (cat.budget !== undefined) { cat.budgetType = 'weekly'; cat.budgetValue = cat.budget; delete cat.budget; needsSave = true; }
                                if (!cat.budgetType) { cat.budgetType = 'none'; cat.budgetValue = null; needsSave = true; }
                                if (cat.isSpecial === undefined) { cat.isSpecial = false; cat.presetValue = null; needsSave = true; }
                                if (cat.isSpecial && !cat.icon) { cat.icon = 'euro'; needsSave = true; }
                            });
                            
                            saveCategories();
                            saveExpenses();
                            saveGlobalBudget();
                            elements.manualDataTextarea.value = ''; 
                            showToast('Dati importati con successo!');
                            navigate('home'); 
                        });
                    } else {
                        showModal('Errore Dati', 'La struttura dei dati incollati non è valida.', () => {});
                    }
                } catch (error) {
                    console.error("Errore parsing JSON manuale:", error);
                    showModal('Errore Dati', 'Impossibile leggere il testo. Assicurati di aver copiato tutto.', () => {});
                }
            }
            // --- FINE FUNZIONI IMPORT/EXPORT ---

            // --- (Alpha 94) COLLEGAMENTO PULSANTI (Nuova Navigazione) ---
            
            // 1. Pulsanti della Tab Bar
            elements.navBtnHome.addEventListener('click', () => navigate('home'));
            elements.navBtnChart.addEventListener('click', () => navigate('chart'));
            elements.navBtnAdd.addEventListener('click', () => navigate('addCategory')); // Il pulsante "Aggiungi" porta alla selezione categoria
            elements.navBtnData.addEventListener('click', () => navigate('data'));
            elements.navBtnManage.addEventListener('click', () => navigate('manageCategories'));
            
            // 2. Pulsanti interni
            elements.confirmExpenseBtn.addEventListener('click', addExpense); 
            elements.saveCategoryBtn.addEventListener('click', addCategory); 
			
            backButtons.backToHomeFromAdd.addEventListener('click', () => navigate('home'));
            backButtons.backToHomeFromView.addEventListener('click', () => navigate('home'));
            backButtons.cancelAddAmount.addEventListener('click', () => navigate('addCategory')); 
            backButtons.backToHomeFromManage.addEventListener('click', () => navigate('home'));
            backButtons.backToViewFromDetail.addEventListener('click', () => navigate('viewExpenses'));                       
            
            backButtons.backToHomeFromMonthly.addEventListener('click', () => navigate('home')); 
            backButtons.cancelEditCategory.addEventListener('click', () => { 
                state.editingCategoryId = null; 
                state.tempSelectedIcon = 'euro'; 
                navigate('manageCategories'); 
            });
            elements.weeklyBox.addEventListener('click', () => navigate('viewExpenses'));
            elements.monthlyBox.addEventListener('click', () => {
                const now = new Date();
                state.viewingMonth = now.getMonth();
                state.viewingYear = now.getFullYear();
                navigate('monthlyHistory');
            });
            elements.newCategoryIsPresetCheckbox.addEventListener('change', handlePresetToggleAdd);
            elements.confirmEditCategoryBtn.addEventListener('click', saveCategoryEdit); 
            
            // 3. Pulsanti Dati/Backup
            elements.exportBtn.addEventListener('click', exportData);
            elements.importBtn.addEventListener('click', importData);
            elements.importFileInput.addEventListener('change', handleFileImport);
            elements.manualExportShowBtn.addEventListener('click', showManualExportData);
            elements.manualImportProcessBtn.addEventListener('click', processManualImport);
            
            // 4. Altri pulsanti
            elements.saveGlobalBudgetBtn.addEventListener('click', handleSaveGlobalBudget); 
            backButtons.backToHomeFromChart.addEventListener('click', () => navigate('home'));
            backButtons.backToHomeFromData.addEventListener('click', () => navigate('home')); 
            backButtons.backToHistoryFromWeeklyDetail.addEventListener('click', () => navigate('monthlyHistory'));
            backButtons.backToWeeklyDetailFromCat.addEventListener('click', () => navigate('weeklyDetail'));
            // --- INIZIALIZZAZIONE ---
			
            function applyRecurringExpenses() {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                const recurringCategories = state.categories.filter(c => c.recurring === true);
                if (recurringCategories.length === 0) return; 

                // (v93) Crea prima un Set di ID delle categorie che ci interessano
                const recurringCategoryIds = new Set(recurringCategories.map(c => c.id));

                // (v93) Cerca TUTTE le spese (indipendentemente dal flag 'recurring')
                // che appartengono a quelle categorie e sono di questo mese
                const addedThisMonth = new Set(
                    state.expenses
                        .filter(e => recurringCategoryIds.has(e.categoryId)) // Filtra solo per le categorie giuste
                        .filter(e => {
                            try {
                                const d = new Date(e.date);
                                return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                            } catch (err) { return false; }
                        })
                        .map(e => e.categoryId) 
                );

                let expensesAdded = false;

                recurringCategories.forEach(cat => {
                    if (!addedThisMonth.has(cat.id)) {
                        state.expenses.push({
                            id: Date.now() + Math.floor(Math.random() * 1000), 
                            categoryId: cat.id,
                            amount: cat.presetValue || 0,
                            note: 'Spesa ricorrente automatica',
                            date: new Date().toISOString(),
                            recurring: true 
                        });
                        expensesAdded = true;
                    }
                });

                if (expensesAdded) {
                    saveExpenses();
                }
            }
            
            // --- GESTIONE TEMI ---
            const allThemeClasses = [
                'theme-pro-light', 'theme-pro-dark',
                'theme-dark' 
            ];

            function applyTheme(themeName) {

                document.body.classList.remove(...allThemeClasses);
                document.body.classList.add(themeName);

                if (themeName.includes('dark')) {
                    document.body.classList.add('theme-dark');
                    if(elements.themeToggleBtn) elements.themeToggleBtn.innerHTML = '<span>☀️</span>';
                } else {
                    if(elements.themeToggleBtn) elements.themeToggleBtn.innerHTML = '<span>🌙</span>';
                }

                try {
                    localStorage.setItem('app-theme', themeName);
                } catch (e) {
                    console.error("Impossibile salvare il tema:", e);
                }
                
                if (state.currentScreen === 'chart') {
                    setTimeout(updateCharts, 50); 
                }
            } 

            function loadTheme() {

                let savedTheme = null;
                try {
                    savedTheme = localStorage.getItem('app-theme');
                } catch (e) {
                    console.error("Impossibile caricare il tema:", e);
                }

                if (!savedTheme) {
                    try {
                        const oldDarkMode = localStorage.getItem('dark-mode');
                        if (oldDarkMode === 'true') {
                            savedTheme = 'theme-pro-dark'; 
                            localStorage.removeItem('dark-mode'); 
                        } else if (oldDarkMode === 'false') {
                            savedTheme = 'theme-pro-light'; 
                            localStorage.removeItem('dark-mode'); 
                        }
                    } catch (e) { /* ignora */ }
                }
                
                applyTheme(savedTheme || 'theme-pro-light');
            }
            // --- FINE GESTIONE TEMI ---

            function init() {
                elements.appVersionFixed.textContent = versionString; 
                loadData(); 
                loadTheme(); 
				applyRecurringExpenses(); 
                navigate('home'); 
            }

            init(); // Avvia l'inizializzazione

            // (Alpha 98) Listener per il nuovo Toggle Icon
            if (elements.themeToggleBtn) {
                elements.themeToggleBtn.addEventListener('click', () => {
                    // Controlla il tema attuale leggendo la classe del body
                    const currentThemeIsDark = document.body.classList.contains('theme-pro-dark');
                    if (currentThemeIsDark) {
                        applyTheme('theme-pro-light');
                    } else {
                        applyTheme('theme-pro-dark');
                    }
                });
            }
        });
    </script>
    
</body>
</html>