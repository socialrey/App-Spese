<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <!-- (Alpha 1) Viewport per PWA e mobile -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Gestione Spese</title>
    
    <!-- (Alpha 1) Meta tag per PWA iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Spese">
    
    <!-- (Alpha 1) Icona PWA (SVG in base64) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBmaWxsPSIjNDE2OWUxIiBkPSJNMCAwaDEwMHYxMDBIMHoiLz48ZyBmaWxsPSIjZmZmIj48cGF0aCBkPSJNNzkuNDEgMjguNzJhMS44MyAxLjgzIDAgMCAwLTEuNTYtMS4wM2gtOS4zOWMtMS4wMSAwLTEuODMuNzYtMS44MyAxLjcydjMuNThoLTQuMDV2LTMuNThjMC0xLS44Mi0xLjcyLTEuODMtMS43MmgtOS4zOWMtMS4wMSAwLTEuODMuNzYtMS44MyAxLjcydjMuNThoLTMuODZ2LTMuNThjMC0xLS44Mi0xLjcyLTEuODMtMS43MmgtOS4zOWMtMS4wMSAwLTEuODMuNzYtMS44MyAxLjcydi42N2MwIDEgLjgyIDEuNzIgMS44MyAxLjcyaDcuMDd2My41OGgtNy4wN2MtMS4wMSAwLTEuODMuNzYtMS44MyAxLjcydi42N2MwIDEgLjgyIDEuNzIgMS44MyAxLjcyaDcuMDd2My41OGgtNy4wN2MtMS4wMSAwLTEuODMuNzYtMS44MyAxLjcydi42N2MwIDEgLjgyIDEuNzIgMS44MyAxLjcyaDcuMDd2My45N2gtNy4wN2MtMS4wMSAwLTEuODMuNzctMS44MyAxLjcydi42N2MwIDEgLjgyIDEuNzIgMS44MyAxLjcyaDguMTZ2MTEuNjRjMCAxIC44MiAxLjcyIDEuODMgMS43MnMxLjgzLS43NiAxLjgzLTEuNzJWNTguOTdoMS41OXYxMS4xMmMwIDEgLjgyIDEuNzIgMS44MyAxLjcMnMxLjgzLS43NiAxLjgzLTEuNzJWNTguOTdoMS42MXYxMS4xMmMwIDEgLjgyIDEuNzIgMS44MyAxLjcMnMxLjgzLS43NiAxLjgzLTEuNzJWNTguOTdoMS4yM2w4LjE2IDBjMS4wMSAwIDEuODMtLjc3IDEuODMtMS43MnYtMS4xMmMwLS45NS0uODItMS43Mi0xLjgzLTEuNzJoLTcuMDd2LTMuOTdoNy4wN2MxLjAxIDAgMS44My0uNzcgMS44My0xLjcydi0uNjdjMC0uOTUtLjgyLTEuNzItMS44My0xLjcyaC03LjA3di0zLjU4aDcuMDdjMS4wMSAwIDEuODMtLjcYIDEuODMtMS43MnYtLjY3YzAtLjk1LS44Mi0xLjcyLTEuODMtMS43MmgtNy4wN3YtMy41OGgxLjYxdjMuNThaTTgwLjY2IDM0LjM0di0zLjU4aDEuNjF2My41OGgtMS42MVptLTExLjIyIDBoLTEuNTl2LTMuNThoMS41OXYzLjU4Wm0tMTEuMDMgMGgtMS42MXYtMy41OGgxLjYxdjMuNThabTIyLjI1IDUuMTZoLTEuNjF2LTMuNThoMS42MXYzLjU4Wm0tMTEuMjIgMGgtMS41OXYtMy41OGgxLjU5djMuNThabS0xMS4wMyAwaC0xLjYxdi0zLjU4aDEuNjF2My41OFptNS41MSA4Ljc0YzAgMSAuODIgMS43MiAxLjgzIDEuNzJzMS44My0uNzYgMS44My0xLjc3VjU4Ljk3aC0zLjY2djYuNDFaIi8+PC9nPjwvc3ZnPg==">
    
    <!-- (Alpha 36) Aggiunta libreria Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>


    <style>
        /* CSS: Stile dell'app */
/* --- (Alpha 65) GESTIONE TEMI --- */

        /* TEMA 1: Pastello (Chiaro) - Default */
        :root, body.theme-light-default {
            --bg-color: #fdf6f0;
            --card-bg: #ffffff;
            --primary-color: #a78bfa; /* lilla pastello */
            --primary-dark: #7c3aed;
            --text-color: #3b3b3b;
            --secondary-text-color: #7a7a7a;
            --input-bg: #fefefe;
            --border-color: #e0dede;
            --monthly-icon-bg: #ede9fe;
            --monthly-icon-color: #7c3aed;
            --weekly-icon-bg: #e0f2fe;
            --weekly-icon-color: #0284c7;
            --green: #20c997;
            --yellow: #ffc107;
            --orange: #fd7e14;
            --red: #dc3545;
            --toast-bg: rgba(0, 0, 0, 0.8);
        }

        /* TEMA 2: Pastello (Scuro) */
        body.theme-dark-default {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --primary-color: #a78bfa; /* lilla in dark */
            --primary-dark: #7c3aed;
            --text-color: #f1f1f1;
            --secondary-text-color: #bbbbbb;
            --input-bg: #1a1a1a;
            --border-color: #333;
            --monthly-icon-bg: #3b3b3b;
            --monthly-icon-color: #a78bfa;
            --weekly-icon-bg: #3b3b3b;
            --weekly-icon-color: #0284c7;
            --green: #20c997;
            --yellow: #ffc107;
            --orange: #fd7e14;
            --red: #dc3545;
            --toast-bg: rgba(255, 255, 255, 0.9);
        }
        
        /* TEMA 3: Corporate (Chiaro) */
        body.theme-light-corporate {
            --bg-color: #f4f7fa; /* Grigio chiaro */
            --card-bg: #ffffff;
            --primary-color: #007bff; /* Blu Corporate */
            --primary-dark: #0056b3;
            --text-color: #212529;
            --secondary-text-color: #6c757d;
            --input-bg: #ffffff;
            --border-color: #dee2e6;
            --monthly-icon-bg: #e6f2ff;
            --monthly-icon-color: #007bff;
            --weekly-icon-bg: #e6f2ff;
            --weekly-icon-color: #0056b3;
            --green: #28a745;
            --yellow: #ffc107;
            --orange: #fd7e14;
            --red: #dc3545;
            --toast-bg: rgba(0, 0, 0, 0.8);
        }

        /* TEMA 4: Corporate (Scuro) */
        body.theme-dark-corporate {
            --bg-color: #1a202c; /* Blu scuro */
            --card-bg: #2d3748;
            --primary-color: #4299e1; /* Blu chiaro */
            --primary-dark: #2b6cb0;
            --text-color: #edf2f7;
            --secondary-text-color: #a0aec0;
            --input-bg: #2d3748;
            --border-color: #4a5568;
            --monthly-icon-bg: #4a5568;
            --monthly-icon-color: #4299e1;
            --weekly-icon-bg: #4a5568;
            --weekly-icon-color: #2b6cb0;
            --green: #38a169;
            --yellow: #ecc94b;
            --orange: #ed8936;
            --red: #e53e3e;
            --toast-bg: rgba(255, 255, 255, 0.9);
        }

        /* --- (Alpha 66) Nuovi Temi --- */
        
        /* TEMA 5: Laser (Chiaro) */
        body.theme-light-laser {
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --primary-color: #00e0e0; /* Ciano brillante */
            --primary-dark: #00b3b3;
            --text-color: #1a1a1a;
            --secondary-text-color: #555;
            --input-bg: #ffffff;
            --border-color: #d0d0d0;
            --monthly-icon-bg: #d6fcfc;
            --monthly-icon-color: #00b3b3;
            --weekly-icon-bg: #e0f2fe; /* Manteniamo un blu/ciano leggero qui */
            --weekly-icon-color: #0284c7;
            --green: #00ff00; /* Verde Lime */
            --yellow: #ffff00; /* Giallo brillante */
            --orange: #ff8800;
            --red: #ff0055; /* Magenta/Rosso */
            --toast-bg: rgba(0, 0, 0, 0.8);
        }

        /* TEMA 6: Laser (Scuro) */
        body.theme-dark-laser {
            --bg-color: #000000; /* Nero puro */
            --card-bg: #0b0b0b; /* Quasi nero */
            --primary-color: #00ffff; /* Ciano Neon */
            --primary-dark: #00b3b3;
            --text-color: #ffffff;
            --secondary-text-color: #aaaaaa;
            --input-bg: #111111;
            --border-color: #333333;
            --monthly-icon-bg: #1a2e2c;
            --monthly-icon-color: #00ffff;
            --weekly-icon-bg: #1a2e2c;
            --weekly-icon-color: #00ffff;
            --green: #00ff00; /* Verde Lime */
            --yellow: #ffff00; /* Giallo brillante */
            --orange: #ff8800;
            --red: #ff00ff; /* Magenta Neon */
            --toast-bg: rgba(230, 230, 230, 0.9);
        }

        /* TEMA 7: Synthwave (Chiaro) */
        body.theme-light-synth {
            --bg-color: #fff0f5; /* Rosa pallido */
            --card-bg: #ffffff;
            --primary-color: #ff00aa; /* Rosa Neon */
            --primary-dark: #c40084;
            --text-color: #331a38;
            --secondary-text-color: #5a3a63;
            --input-bg: #ffffff;
            --border-color: #f0d9e5;
            --monthly-icon-bg: #ffe6f5;
            --monthly-icon-color: #ff00aa;
            --weekly-icon-bg: #e0f2fe;
            --weekly-icon-color: #0284c7;
            --green: #00f0e0; /* Teal/Ciano */
            --yellow: #f59e0b;
            --orange: #f97316;
            --red: #ef4444;
            --toast-bg: rgba(0, 0, 0, 0.8);
        }

        /* TEMA 8: Synthwave (Scuro) */
        body.theme-dark-synth {
            --bg-color: #1a0c3b; /* Indaco scuro */
            --card-bg: #2b1d4f;
            --primary-color: #ff00aa; /* Rosa Neon */
            --primary-dark: #c40084;
            --text-color: #f0e6f7;
            --secondary-text-color: #b0a0c4;
            --input-bg: #2b1d4f;
            --border-color: #4a3a6f;
            --monthly-icon-bg: #4a3a6f;
            --monthly-icon-color: #ff00aa;
            --weekly-icon-bg: #4a3a6f;
            --weekly-icon-color: #00f0e0; /* Teal/Ciano */
            --green: #00f0e0;
            --yellow: #f59e0b;
            --orange: #f97316;
            --red: #ef4444;
            --toast-bg: rgba(255, 255, 255, 0.9);
        }
        
        /* TEMA 9: Graphite (Chiaro) */
        body.theme-light-graphite {
            --bg-color: #f5f5f5; /* Grigio chiarissimo */
            --card-bg: #ffffff;
            --primary-color: #f97316; /* Arancione */
            --primary-dark: #ea580c;
            --text-color: #262626;
            --secondary-text-color: #737373;
            --input-bg: #ffffff;
            --border-color: #e5e5e5;
            --monthly-icon-bg: #fff7ed;
            --monthly-icon-color: #f97316;
            --weekly-icon-bg: #f3f4f6;
            --weekly-icon-color: #4b5563;
            --green: #22c55e;
            --yellow: #eab308;
            --orange: #f97316;
            --red: #ef4444;
            --toast-bg: rgba(0, 0, 0, 0.8);
        }

        /* TEMA 10: Graphite (Scuro) */
        body.theme-dark-graphite {
            --bg-color: #171717; /* Grigio scuro */
            --card-bg: #262626;
            --primary-color: #f97316; /* Arancione */
            --primary-dark: #ea580c;
            --text-color: #f5f5f5;
            --secondary-text-color: #a3a3a3;
            --input-bg: #262626;
            --border-color: #404040;
            --monthly-icon-bg: #404040;
            --monthly-icon-color: #f97316;
            --weekly-icon-bg: #404040;
            --weekly-icon-color: #e5e7eb;
            --green: #22c55e;
            --yellow: #eab308;
            --orange: #f97316;
            --red: #ef4444;
            --toast-bg: rgba(255, 255, 255, 0.9);
        }
        /* --- FINE GESTIONE TEMI --- */
		/* Dark mode Style */

body.theme-dark select,
body.theme-dark option,
body.theme-dark label {
  color: var(--text-color);
  background-color: var(--input-bg);
}



        body {
		transition: background-color 0.3s ease, color 0.3s ease;

            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-color); /* (Alpha 41) */
            color: var(--text-color);
            -webkit-user-select: none; /* Disabilita selezione testo */
            user-select: none;
            -webkit-tap-highlight-color: transparent; /* Rimuove flash al tocco */
        }

        .container {
            padding: 15px;
            padding-bottom: 80px; /* Spazio per la barra home di iOS */
            max-width: 600px;
            margin: 0 auto;
        }

        .hidden {
            display: none !important;
        }

        /* (Alpha 41) Header ridisegnato con gradiente */
        .header {
            /* (Alpha 55) Modificato per layout icone */
            display: grid;
            grid-template-columns: 1fr auto; /* Colonna sinistra (titolo/data), colonna destra (icone/budget) */
            grid-template-rows: auto auto;    
            align-items: start; 

            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 20px 15px 30px 15px;
            border-radius: 0 0 24px 24px; /* Angoli arrotondati solo in basso */
            margin: -15px -15px 0 -15px; /* Si estende ai lati */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* (Alpha 55) Rimosso .header-top */

        .header h1 {
            grid-column: 1 / 2; 
            grid-row: 1 / 2;
            font-size: 24px;
            margin: 0;
            color: white; /* (Alpha 41) */
            text-align: left; 
        }

        .header p {
            grid-column: 1 / 2; 
            grid-row: 2 / 3;
            text-align: left; 
            margin: 0; /* (Alpha 41) Rimosso margine superiore */
            color: rgba(255, 255, 255, 0.8); /* (Alpha 41) */
            font-size: 14px;
            line-height: 1.4; 
        }
        
        /* (Alpha 55) Riquadro icone spese fisse */
        #fixed-expenses-summary {
            grid-column: 2 / 3;
            grid-row: 1 / 2; /* Sopra il budget */
            display: flex;
            flex-direction: row-reverse; /* Allinea a destra */
            gap: 8px;
            padding-bottom: 5px;
            align-items: center;
            justify-content: flex-start; /* Inizia da destra */
            min-height: 30px; /* Altezza minima */
        }
        .summary-icon-item {
            width: 24px;
            height: 24px;
            padding: 4px;
            border-radius: 50%;
            background-color: var(--card-bg);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .summary-icon-item svg {
            width: 16px;
            height: 16px;
            color: var(--primary-color);
        }

        /* (Alpha 55) Budget spostato sotto */
        #monthly-budget-summary {
            grid-column: 2 / 3;  
            grid-row: 2 / 3;     /* Sotto le icone */
            justify-self: end; 
            align-self: center; 
            font-size: 10px; 
            color: rgba(255, 255, 255, 0.8); /* (Alpha 41) */
            padding: 0 5px 0 0; 
            white-space: nowrap; 
            text-align: right; 
            line-height: 1.3; 
        }
        #monthly-budget-summary h4 {
            margin: 0;
            font-weight: normal; 
            text-transform: uppercase; 
        }
         #monthly-budget-summary .remaining-budget {
            font-weight: bold; 
            font-size: 14px; 
            color: white; /* (Alpha 41) */
            display: block; 
         }


        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow); /* (Alpha 40) Ombra moderna */
            border: none; /* (Alpha 40) Rimuove bordi predefiniti */
        }
        
        /* (Alpha 41) Riquadri home spostati in su */
        .summary-cards {
            display: grid;
            grid-template-columns: 1fr; 
            gap: 15px; 
            margin-bottom: 20px; 
            margin-top: -20px; /* (Alpha 41) Sovrapposizione header */
            position: relative;
            z-index: 10;
        }
        
        /* (Alpha 41) Stile riquadri home con icone */
        .summary-cards .total-box {
            background-color: var(--card-bg); /* (Alpha 41) Sfondo bianco */
            padding: 16px; 
            border-radius: 12px;
            box-shadow: var(--card-shadow); 
            margin-bottom: 0; 
            border: none; 
            display: flex; /* (Alpha 41) Layout Flex */
            align-items: center; /* (Alpha 41) */
            gap: 15px; /* (Alpha 41) Spazio tra icona e testo */
        }

        /* (Alpha 41) Stili icone */
        .total-box-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; /* Evita che l'icona si rimpicciolisca */
        }
        .total-box-icon svg {
            width: 24px;
            height: 24px;
        }
        #monthly-icon-bg {
            background-color: var(--monthly-icon-bg);
            color: var(--monthly-icon-color);
        }
        #weekly-icon-bg {
            background-color: var(--weekly-icon-bg);
            color: var(--weekly-icon-color);
        }
        .total-box-text {
            text-align: left; /* (Alpha 41) Testo allineato a sx */
        }
        /* Rimossi sfondi gradiente da ID */
        /* #monthly-box.total-box { ... } */
        /* #weekly-box.total-box { ... } */

        .total-box {
            cursor: pointer;
            transition: transform 0.2s;
        }

        .total-box:active {
            transform: scale(0.97);
        }

        .total-box h3 {
            margin: 0 0 5px;
            font-size: 16px; /* (Alpha 41) Ridotto per nuovo layout */
            color: var(--secondary-text-color); 
            font-weight: 500;
        }

        .total-box p {
            margin: 0;
            font-size: 24px; /* (Alpha 41) Ridotto per nuovo layout */
            font-weight: 600;
            color: var(--text-color); /* (Alpha 41) */
        }

        /* Stile per il range date (Alpha 2) */
        .total-box .date-range {
            font-size: 12px; 
            color: var(--secondary-text-color); 
            margin-top: 4px; /* (Alpha 41) Aggiunto spazio sopra */
            display: block;
        }

        /* (Alpha 67) Stile Pulsante Primario (Reso Thematic) */
        .btn {
          display: block;
          width: 100%;
          padding: 14px;
          /* USA LE VARIABILI DI TEMA */
          background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
          background-size: 200% 200%;
          animation: gradientMove 4s ease infinite;
          color: white; /* Il testo resta bianco, va bene con tutti i temi primari */
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          text-align: center;
          position: relative;
          overflow: hidden;
          /* Sostituiamo la shadow "rotta" con una generica */
          box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.2);
          transition: transform 0.2s, box-shadow 0.2s, filter 0.2s;
        }

        @keyframes gradientMove {
          0% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
          100% { background-position: 0% 50%; }
        }

        .btn:active {
            /* Scurisce il gradiente del tema attivo invece di usare un colore fisso */
            filter: brightness(0.9); 
            transform: translateY(1px); 
            box-shadow: 0 2px 6px -1px rgba(0, 0, 0, 0.2); 
        }
        
        /* (Alpha 40 / 41) Stile Pulsante Secondario (Filled) */
        .btn-secondary {
            background-color: var(--card-bg); /* (Alpha 41) Sfondo bianco */
            color: var(--text-color); /* (Alpha 41) Testo scuro */
            border: 1px solid var(--border-color); /* (Alpha 41) Bordo leggero */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); /* (Alpha 41) Ombra leggera */
        }
        
        .btn-secondary:active {
            background-color: #f7f8fc; /* (Alpha 40) Sfondo leggero al tocco */
            transform: none;
            box-shadow: none;
            border-color: #d0d2d6; /* (Alpha 41) */
        }

        .btn-danger {
            background-color: var(--red);
            box-shadow: 0 4px 12px -2px rgba(250, 56, 62, 0.4); /* (Alpha 40) Ombra rossa */
        }

        .btn-danger:active {
            background-color: #d92e33;
            box-shadow: 0 2px 6px -1px rgba(250, 56, 62, 0.4); /* (Alpha 40) */
            transform: translateY(1px);
        }

        .actions {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            /* (Alpha 17) Aggiungi spazio sotto i pulsanti per la versione */
            margin-bottom: 20px;
        }

        /* (Alpha 17) Stile per la versione */
        #app-version {
            text-align: left;
            font-size: 11px;
            color: var(--secondary-text-color);
            opacity: 0.7;
            padding-left: 5px; /* Piccolo padding a sinistra */
        }

        /* Griglia Categorie */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
        }

        .category-item {
            background-color: var(--card-bg); /* (Alpha 18) */
            border: 1px solid var(--border-color); /* (Alpha 18) */
            padding: 15px 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            transition: transform 0.1s, box-shadow 0.2s;
            position: relative;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06); /* (Alpha 40) Ombra più definita */
        }

        .category-item:active {
            transform: scale(0.96);
        }
        
        /* Icona elimina per la gestione categorie (Alpha 1) */
        .category-item .delete-icon {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background-color: var(--red);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            border: 2px solid white;
        }

        /* (Alpha 8) Stile per il nome della categoria (per renderlo cliccabile) */
        .category-item .category-name {
            cursor: pointer;
            display: block;
            padding: 5px; /* Aumenta l'area cliccabile */
            transition: background-color 0.2s;
            border-radius: 5px;
        }
        .category-item .category-name:active {
            background-color: #e0e2e7;
        }


        .category-item .budget-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            background-color: var(--green);
            border-radius: 0 0 8px 8px;
        }
        
        /* Stile per i riquadri in "Visualizza Spese" (Alpha 1) */
        .expense-category-item {
            padding: 12px;
            border-radius: 8px;
            color: white;
            cursor: pointer; /* Aggiunto per mostrare che è cliccabile */
            transition: transform 0.1s;
        }
        
        .expense-category-item:active {
            transform: scale(0.97); /* Feedback al tocco */
        }

        .expense-category-item h4 {
            margin: 0 0 4px;
            font-size: 16px;
        }

        .expense-category-item p {
            margin: 0 0 4px 0; /* (Alpha 12) Aggiunto margin-bottom */
            font-size: 12px;
            opacity: 0.9;
        }

        .expense-category-item .amount {
            font-size: 22px;
            font-weight: 600;
            margin-top: 8px;
        }
        
        /* (Alpha 36) Rendi cliccabili anche i box in #monthly-history-grid */
        #monthly-history-grid .expense-category-item {
             cursor: pointer;
             transition: transform 0.1s; /* (Alpha 37) Aggiunto */
        }
         #monthly-history-grid .expense-category-item:active {
             transform: scale(0.97);
         }


        /* (Alpha 40) Stile Form di input "Filled" */
       .input-group {
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}


        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        /* (Alpha 22) Checkbox stile */
        .input-group label input[type="checkbox"] {
            margin-right: 8px;
            vertical-align: middle;
        }

        .input-group input, .input-group textarea, .input-group select { 
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color); /* (Alpha 40) Bordo leggero */
            background-color: var(--input-bg); /* (Alpha 41) Sfondo "pieno" */
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box; 
        }
        
        .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
             background-color: var(--card-bg);
             border-color: var(--primary-color);
             outline: none;
             box-shadow: 0 0 0 2px rgba(74, 105, 226, 0.2); /* (Alpha 41) */
        }
        
        textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        /* (Alpha 55) Griglia selezione icone */
        .icon-select-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 10px;
            padding-top: 5px;
        }
        .icon-select-item {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .icon-select-item svg {
            width: 20px;
            height: 20px;
            color: var(--secondary-text-color);
            transition: color 0.2s;
        }
        .icon-select-item.selected {
            border-color: var(--primary-color);
            background-color: #f0f5ff;
        }
        .icon-select-item.selected svg {
            color: var(--primary-color);
        }

        /* Modale di conferma personalizzato (Alpha 1 / Alpha 27) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            pointer-events: none; /* (Alpha 27) Ignora click su overlay */
            opacity: 0; /* (Alpha 27) Nascosto per transizione */
            transition: opacity 0.2s ease-in-out;
        }
         /* (Alpha 27) Stile per mostrare il modale */
        .modal-overlay.visible {
  opacity: 1;
  pointer-events: auto;
  backdrop-filter: blur(6px);
  background-color: rgba(0, 0, 0, 0.4);
}
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            width: 85%;
            max-width: 300px;
            text-align: center;
            transform: scale(0.9); /* (Alpha 27) Per animazione */
            transition: transform 0.2s ease-in-out;
        }
        /* (Alpha 27) Stile per mostrare il contenuto del modale */
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        
        .modal-content h3 {
            margin-top: 0;
        }

        .modal-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Messaggio "Nessuna spesa" (Alpha 1) */
        #no-expenses-message {
            text-align: center;
            padding: 30px;
            color: var(--secondary-text-color);
        }
        
        /* Stili per la schermata di dettaglio (Alpha 1) */
        .expense-list-item {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer; /* Aggiunto per renderlo cliccabile */
            transition: background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05); /* (Alpha 40) */
            position: relative; /* (Alpha 53) Aggiunto per icona delete */
            padding-right: 40px; /* (Alpha 53) Spazio per icona delete */
        }
        .expense-list-item:active {
            background-color: #f0f2f5; /* Feedback al tocco */
            box-shadow: none; /* (Alpha 40) */
            transform: scale(0.99); /* (Alpha 40) */
        }
        .expense-list-item .details {
            font-size: 15px;
        }
        .expense-list-item .details .note {
            font-size: 13px;
            color: var(--secondary-text-color);
            margin-top: 4px;
        }
        .expense-list-item .amount {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        /* (Alpha 53) Icona elimina per le spese */
        .expense-list-item .delete-icon {
            position: absolute;
            top: 50%;
            right: 8px;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            background-color: var(--red);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .expense-list-item:hover .delete-icon {
             opacity: 1;
        }
        .expense-list-item .delete-icon:active {
            transform: translateY(-50%) scale(0.9);
            opacity: 1;
        }

        
        /* (Alpha 37) Stile per i riquadri di riepilogo categoria */
        .category-summary-item {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s; /* (Alpha 40) */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05); /* (Alpha 40) */
        }
        .category-summary-item:active {
            background-color: #f0f2f5;
            box-shadow: none; /* (Alpha 40) */
            transform: scale(0.99); /* (Alpha 40) */
        }
        .category-summary-item .details {
            font-size: 16px;
            font-weight: 500;
        }
        .category-summary-item .amount {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }


        /* (Alpha 26) Stili per Import/Export */
        .import-export-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        .import-export-section h3 {
            text-align: center;
            color: var(--secondary-text-color);
            margin-bottom: 15px;
        }
        .import-export-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        /* Nascondi l'input file, useremo il bottone per attivarlo */
        #import-file-input {
            display: none;
        }

         /* (Alpha 27) Stile Toast */
        #toast-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--toast-bg);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        #toast-message.visible {
            opacity: 1;
        }
        
        /* (Alpha 36) Stile per il contenitore del grafico */
        #chart-container {
            width: 100%;
            max-width: 600px; /* Consistente col container */
            margin: 20px 0;
            padding: 10px;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: var(--card-shadow); /* (Alpha 40) */
            border: none; /* (Alpha 40) */
        }
        #expense-chart {
            max-height: 400px; /* Limita altezza su mobile */
        }
		@keyframes fadeSlide {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.total-box,
.expense-category-item,
.category-summary-item {
  animation: fadeSlide 0.4s ease-out;
}

.category-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

/* Modal: usa variabili (sfondo scuro + testo chiaro) */
body.theme-dark .modal-content {
  background-color: var(--card-bg);    /* evita sfondo bianco fisso */
  color: var(--text-color);            /* testo leggibile */
  border: 1px solid var(--border-color);
}

/* Pulsanti secondari: stato active più scuro in dark mode */
body.theme-dark .btn-secondary:active {
  background-color: rgba(255,255,255,0.04); /* leggero contrasto sul card-bg */
  border-color: var(--border-color);
  box-shadow: none;
}

/* Rimuove sfondi chiari hardcoded su item attivi */
body.theme-dark .expense-list-item:active,
body.theme-dark .category-summary-item:active,
body.theme-dark .category-item .category-name:active {
  background-color: rgba(255,255,255,0.02); /* contrasto leggero compatibile */
  color: var(--text-color);
  box-shadow: none;
}

/* Toast: testo scuro su sfondo chiaro era già gestito; forziamo contrasto opposto se necessario */
body.theme-dark #toast-message {
  background-color: var(--toast-bg);
  color: var(--text-color);
}

/* Forza svg / icone a rispettare il colore del testo (currentColor) in dark mode
   Serve per le SVG che hanno fill/stroke fissi: li sovrascrive quando possibile. */
body.theme-dark .summary-icon-item svg,
body.theme-dark .icon-select-item svg,
body.theme-dark .total-box-icon svg,
body.theme-dark .manage-category-list svg,
body.theme-dark .category-item svg {
  fill: currentColor !important;
  stroke: currentColor !important;
}

/* Imposta il colore corrente per gli elementi icona in dark mode (scegli il colore desiderato) */
body.theme-dark .summary-icon-item,
body.theme-dark .icon-select-item,
body.theme-dark .total-box-icon,
body.theme-dark .category-item {
  color: var(--text-color); /* le svg con currentColor erediteranno questo colore */
}

/* Se ci sono SVG inline con fill hardcoded (es. #1f2937), questo fallback cerca di sovrascrivere */
body.theme-dark svg [fill="#1f2937"],
body.theme-dark svg [stroke="#1f2937"] {
  fill: currentColor !important;
  stroke: currentColor !important;
}

/* Input/label/select già gestiti; assicuriamoci che il testo del modal di conferma (bottoni) sia leggibile */
body.theme-dark .modal-actions .btn,
body.theme-dark .modal-actions .btn-secondary,
body.theme-dark .modal-actions .btn-danger {
  color: white;
}
/* Fix testo invisibile in dark mode */
body.theme-dark input,
body.theme-dark textarea,
body.theme-dark select,
body.theme-dark .category-name,
body.theme-dark .expense-list-item,
body.theme-dark .expense-category-item,
body.theme-dark .category-summary-item {
  color: var(--text-color) !important;
}

/* Sfondo dei control form per contrasto in dark mode */
body.theme-dark input,
body.theme-dark textarea,
body.theme-dark select {
  background-color: var(--input-bg) !important;
  border-color: var(--border-color) !important;
}

/* Placeholder leggibile */
body.theme-dark input::placeholder,
body.theme-dark textarea::placeholder {
  color: rgba(241,241,241,0.6) !important; /* usa --text-color chiaro se vuoi */
}

/* Forza colore dei bottoni/testo dentro modali e toast */
body.theme-dark .modal-content,
body.theme-dark .modal-content input,
body.theme-dark .modal-content textarea,
body.theme-dark #toast-message {
  color: var(--text-color) !important;
}

/* Sicurezza: sovrascrive eventuali fill/stroke scuri nelle SVG inline */
body.theme-dark svg [fill],
body.theme-dark svg [stroke] {
  fill: currentColor !important;
  stroke: currentColor !important;
}

    </style>
    
</head>

<body>
    
    <!-- Contenitore Principale -->
    <div class="container" id="main-container"> 
        
        <!-- Schermata Home -->
        <div id="home-screen">
            <div class="header">
                 <!-- (Alpha 41) Layout header modificato -->
                 <h1>Gestione Spese</h1>
                 <p id="current-date"></p>
                 <!-- (Alpha 55) Nuovo riquadro icone spese fisse -->
                 <div id="fixed-expenses-summary">
                     <!-- Icone caricate da JS -->
                 </div>
                 <div id="monthly-budget-summary">
                      <h4>BUDGET RESIDUO:</h4>
                      <p class="remaining-budget">€0.00</p>
                 </div>
            </div>

            <!-- Riquadri Totali (Alpha 4 / Alpha 11 / Alpha 13 / Alpha 19 / Alpha 41) -->
            <div class="summary-cards">
                <!-- (Alpha 19) Ordine invertito: Mese prima, Settimana dopo -->
                <div class="total-box" id="monthly-box">
                    <!-- (Alpha 41) Icona Mese -->
                    <div class="total-box-icon" id="monthly-icon-bg">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0h18M9 12.75h6m-6 3h6" />
                        </svg>
                    </div>
                    <div class="total-box-text">
                        <h3>Questo Mese</h3>
                        <span id="monthly-name" class="date-range"></span> <!-- (Alpha 11) -->
                        <p id="monthly-total">€0.00</p>
                    </div>
                </div>
                
                <div class="total-box" id="weekly-box">
                    <!-- (Alpha 41) Icona Settimana -->
                    <div class="total-box-icon" id="weekly-icon-bg">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 3v2.25M16.5 3v2.25m-12 5.25h15m-15 0a2.25 2.25 0 0 1-2.25-2.25V6.75A2.25 2.25 0 0 1 6.75 4.5h10.5a2.25 2.25 0 0 1 2.25 2.25v3.75c0 1.242-.993 2.25-2.25 2.25h-10.5a2.25 2.25 0 0 1-2.25-2.25Zm0 0h15m-15 0v6.75A2.25 2.25 0 0 0 6.75 21h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75m0 0h15" />
                        </svg>
                    </div>
                    <div class="total-box-text">
                        <h3>Questa Settimana</h3>
                        <span id="weekly-date-range" class="date-range"></span> <!-- (Alpha 2) -->
                        <p id="weekly-total">€0.00</p>
                    </div>
                </div>
            </div>
            
            <!-- Pulsanti Azione (Alpha 3 / Alpha 4 / Alpha 36) -->
            <div class="actions">
                <button class="btn" id="add-expense-btn">Aggiungi Spesa</button>
                <button class="btn btn-secondary" id="manage-categories-btn-home">Gestione Categorie</button> <!-- (Alpha 4) -->
                <!-- (Alpha 36) Nuovo Pulsante Grafico -->
                <button class="btn btn-secondary" id="view-chart-btn">Grafico Spese</button>
            </div>
            
            <!-- (Alpha 65) Versione App -->
		<div class="input-group" style="align-items: center; gap: 10px; margin-bottom: 10px;">
          <label for="theme-selector" style="margin: 0; font-weight: 500;">Tema:</label>
          <select id="theme-selector" style="width: auto; flex-grow: 1; padding: 8px; font-size: 14px;">
            <option value="theme-light-default">Tema Principale (Chiaro)</option>
            <option value="theme-dark-default">Tema Principale (Scuro)</option>
            <option value="theme-light-corporate">Tema Corporate (Chiaro)</option>
            <option value="theme-dark-corporate">Tema Corporate (Scuro)</option>
            <option value="theme-light-laser">Tema Laser (Chiaro)</option>
            <option value="theme-dark-laser">Tema Laser (Scuro)</option>
            <option value="theme-light-synth">Synthwave (Chiaro)</option>
            <option value="theme-dark-synth">Synthwave (Scuro)</option>
            <option value="theme-light-graphite">Graphite (Chiaro)</option>
            <option value="theme-dark-graphite">Graphite (Scuro)</option>
          </select>
          <span id="theme-icon" style="font-size: 20px; margin-left: 5px;">🎨</span>
        </div>

		<div id="app-version">V0.0.0</div>
            
        </div>

        <!-- Schermata Aggiungi Spesa (Scelta Categoria) -->
        <div id="add-expense-category-screen" class="hidden">
            <div class="header">
                 <!-- (Alpha 41) Header semplice per schermate secondarie -->
                 <div class="header-top">
                    <div>
                        <h1>Scegli Categoria</h1>
                        <p>Tocca una categoria per aggiungere una spesa.</p>
                    </div>
                 </div>
            </div>
            <div class="category-grid" id="category-selection-grid">
                <!-- Categorie caricate da JS -->
            </div>
            <div class="actions" style="margin-top: 20px;">
                 <!-- (Alpha 4) Pulsante Gestisci rimosso -->
                 <button class="btn btn-danger" id="back-to-home-from-add-btn">Annulla</button>
            </div>
        </div>
        
        <!-- Schermata Gestione Categorie (Alpha 1 / Alpha 16) -->
        <div id="manage-categories-screen" class="hidden">
            <div class="header">
                <!-- (Alpha 41) Header semplice per schermate secondarie -->
                 <div class="header-top">
                    <div>
                        <h1>Gestisci Categorie</h1>
                        <p>Aggiungi, rimuovi o modifica le tue categorie.</p>
                    </div>
                 </div>
            </div>

            <!-- (Alpha 28) Sezione Budget Mensile Totale -->
            <div class="card">
                 <h3>Budget Mensile Totale</h3>
                 <div class="input-group">
                     <label for="global-monthly-budget">Imposta Budget (€)</label>
                     <input type="number" id="global-monthly-budget" placeholder="Es. 500" step="0.01">
                 </div>
                 <button class="btn" id="save-global-budget-btn">Salva Budget</button>
            </div>
            <!-- Fine Sezione Budget -->

            <div class="card">
                 <h3>Aggiungi Nuova Categoria</h3>
                <div class="input-group">
                    <label for="new-category-name">Nuova Categoria</label>
                    <input type="text" id="new-category-name" placeholder="Es. Benzina">
                </div>
                <!-- --- (Alpha 16) Aggiunta Scelta Tipo Budget --- -->
                <!-- --- (Alpha 22) Modificato per Categoria Predefinita --- -->
                <div class="input-group">
                     <label>
                        <!-- (Alpha 39) Testo modificato -->
                        <input type="checkbox" id="new-category-is-preset"> Spesa Fissa?
                    </label>
                </div>
                 <div class="input-group hidden" id="new-category-preset-value-group">
                     <!-- (Alpha 39) Testo modificato -->
                    <label for="new-category-preset-value">Importo Fisso (€)</label>
                    <input type="number" id="new-category-preset-value" placeholder="Es. 10" step="0.01">
                </div>
                <!-- (Alpha 55) Selettore Icone -->
                <div class="input-group hidden" id="new-category-icon-select-group">
                    <label>Icona</label>
                    <div class="icon-select-grid" id="new-category-icon-select">
                        <!-- Icone caricate da JS -->
                    </div>
                </div>
                <div id="new-category-budget-fields">
                    <div class="input-group">
                        <label for="new-category-budget-type">Tipo Budget Categoria</label>
                        <select id="new-category-budget-type">
                            <option value="none" selected>Nessuno</option>
                            <option value="weekly">Settimanale</option>
                            <option value="monthly">Mensile</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="new-category-budget-value">Valore Budget Categoria (Opz.)</label>
                        <input type="number" id="new-category-budget-value" placeholder="Es. 50" step="0.01">
                    </div>
                </div>
                <!-- --- Fine Modifica --- -->
                <button class="btn" id="save-category-btn">Aggiungi Categoria</button>
            </div>
             <h3>Categorie Esistenti</h3>
             <div class="category-grid" id="manage-category-list">
                <!-- Lista categorie modificabili caricata da JS -->
            </div>
            
            <!-- (Alpha 26) Sezione Import/Export -->
            <div class="import-export-section">
                <h3>Backup Dati</h3>
                <div class="import-export-actions">
                    <button class="btn btn-secondary" id="import-btn">Importa Dati</button>
                    <button class="btn btn-secondary" id="export-btn">Esporta Dati</button>
                    <input type="file" id="import-file-input" accept=".json">
                </div>
            </div>
            
            <div class="actions" style="margin-top: 20px;">
                <button class="btn btn-secondary" id="back-to-home-from-manage-btn">Torna alla Home</button> <!-- (Alpha 5) Corretto pulsante indietro -->
            </div>
        </div>
        
        <!-- (Alpha 5) Nuova Schermata Modifica Categoria (Alpha 16) -->
        <div id="edit-category-screen" class="hidden">
             <div class="header">
                 <!-- (Alpha 41) Header semplice per schermate secondarie -->
                 <div class="header-top">
                    <div>
                        <h1 id="edit-category-title">Modifica Categoria</h1>
                    </div>
                 </div>
            </div>
            <div class="card">
                <div class="input-group">
                    <label for="edit-category-name">Nome Categoria</label>
                    <input type="text" id="edit-category-name">
                </div>
                <!-- --- (Alpha 16) Aggiunta Scelta Tipo Budget --- -->
                 <!-- --- (Alpha 22) Modificato per Categoria Predefinita --- -->
                <div class="input-group">
                     <label>
                        <!-- (Alpha 39) Testo modificato -->
                        <input type="checkbox" id="edit-category-is-preset"> Spesa Fissa?
                    </label>
                </div>
                 <div class="input-group hidden" id="edit-category-preset-value-group">
                     <!-- (Alpha 39) Testo modificato -->
                    <label for="edit-category-preset-value">Importo Fisso (€)</label>
                    <input type="number" id="edit-category-preset-value" placeholder="Es. 10" step="0.01">
                </div>
				<div class="input-group">
  <label>
    <input type="checkbox" id="edit-category-recurring"> Spesa Ricorrente (ogni mese)
  </label>
</div>
                 <!-- (Alpha 55) Selettore Icone -->
                <div class="input-group hidden" id="edit-category-icon-select-group">
                    <label>Icona</label>
                    <div class="icon-select-grid" id="edit-category-icon-select">
                        <!-- Icone caricate da JS -->
                    </div>
                </div>
                <div id="edit-category-budget-fields">
                    <div class="input-group">
                        <label for="edit-category-budget-type">Tipo Budget Categoria</label>
                        <select id="edit-category-budget-type">
                            <option value="none">Nessuno</option>
                            <option value="weekly">Settimanale</option>
                            <option value="monthly">Mensile</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="edit-category-budget-value">Valore Budget Categoria (Opz.)</label>
                        <input type="number" id="edit-category-budget-value" placeholder="Es. 50" step="0.01">
                    </div>
                 </div>
                <!-- --- Fine Modifica --- -->
            </div>
            <div class="actions" style="grid-template-columns: 1fr 1fr; gap: 12px;">
                <button class="btn btn-danger" id="cancel-edit-category-btn">Annulla</button>
                <button class="btn" id="confirm-edit-category-btn">Salva Modifiche</button>
            </div>
        </div>

        <!-- Schermata Aggiungi Spesa (Importo) (Alpha 1) -->
        <div id="add-expense-amount-screen" class="hidden">
            <div class="header">
                 <!-- (Alpha 41) Header semplice per schermate secondarie -->
                 <div class="header-top">
                    <div>
                        <h1 id="add-amount-title">Aggiungi Spesa</h1>
                    </div>
                 </div>
            </div>
            <div class="card">
                <div class="input-group">
                    <label for="expense-amount">Importo (€)</label>
                    <input type="number" id="expense-amount" placeholder="0.00" step="0.01">
                </div>
                <div class="input-group">
                    <label for="expense-note">Nota (opzionale)</label>
					<div class="input-group">
  <label>
    <input type="checkbox" id="expense-recurring"> Spesa Ricorrente (ogni mese)
  </label>
</div>
                    <textarea id="expense-note" placeholder="Es. Spesa settimanale"></textarea>
                </div>
            </div>
            <div class="actions" style="grid-template-columns: 1fr 1fr; gap: 12px;">
                <button class="btn btn-danger" id="cancel-add-amount-btn">Annulla</button>
                <button class="btn" id="confirm-expense-btn">Conferma</button>
            </div>
        </div>

        <!-- Schermata Visualizza Spese (Settimanali per Categoria) (Alpha 1) -->
        <div id="view-expenses-screen" class="hidden">
            <div class="header">
                 <!-- (Alpha 41) Header semplice per schermate secondarie -->
                 <div class="header-top">
                    <div>
                        <h1>Spese della Settimana</h1>
                        <p>Riepilogo per categoria (solo spese variabili).</p>
                    </div>
                 </div>
            </div>
            
            <!-- Messaggio "Nessuna spesa" (Alpha 1) -->
            <div id="no-expenses-message" class="hidden">
                <h3>Nessuna spesa questa settimana</h3>
                <p>Inizia aggiungendo una nuova spesa dalla Home.</p>
            </div>
            <div class="category-grid" id="view-expenses-grid">
                <!-- Riepiloghi spese caricati da JS -->
            </div>
            <div class="actions" style="margin-top: 20px;">
                <button class="btn btn-secondary" id="back-to-home-from-view-btn">Torna alla Home</button>
            </div>
			
        </div>

        <!-- Schermata Dettaglio Categoria (Elenco Spese) (Alpha 1) -->
        <div id="category-detail-screen" class="hidden">
            <div class="header">
                 <!-- (Alpha 41) Header semplice per schermate secondarie -->
                 <div class="header-top">
                    <div>
                        <h1 id="category-detail-title">Dettaglio Spese Categoria</h1>
                        <p>Elenco delle spese mensili variabili per questa categoria.</p>
                    </div>
                 </div>
            </div>
            
            <div id="expense-list">
                <!-- Elenco spese caricato da JS -->
            </div>

            <div class="actions" style="margin-top: 20px;">
                <button class="btn btn-secondary" id="back-to-view-from-detail-btn">Torna Indietro</button>
            </div>
        </div>
        
        <!-- (Alpha 3) Nuova Schermata Storico Mensile -->
        <div id="monthly-history-screen" class="hidden">
            <div class="header">
                 <!-- (Alpha 41) Header semplice per schermate secondarie -->
                 <div class="header-top">
                    <div>
                        <h1 id="monthly-history-title">Riepilogo del Mese</h1>
                        <!-- (Alpha 39) Testo modificato -->
                        <p>Totali per settimana (TUTTE LE SPESE). Clicca per i dettagli.</p>
                    </div>
                 </div>
            </div>
            
            <div class="category-grid" id="monthly-history-grid">
                 <!-- Totali settimanali caricati da JS -->
            </div>

              <!-- ALPHA 71 FILTRO MESE/ANNO -->  
            <div class="actions" style="margin-top: 20px;">
                <div class="input-group" style="grid-template-columns: 1fr 1fr; gap: 10px; display: grid; margin-bottom: 12px;">
                    <select id="history-month-select" style="padding: 12px; font-size: 16px; text-align: center; border-radius: 8px;">
                        </select>
                    <select id="history-year-select" style="padding: 12px; font-size: 16px; text-align: center; border-radius: 8px;">
                        </select>
                </div>
                <button class="btn btn-secondary" id="back-to-home-from-monthly-btn">Torna alla Home</button>
            </div>
        </div>
        
        <!-- (Alpha 36 / Alpha 37) Nuova Schermata Dettaglio Settimana (da Storico Mese) -->
        <div id="weekly-detail-screen" class="hidden">
            <div class="header">
                 <!-- (Alpha 41) Header semplice per schermate secondarie -->
                 <div class="header-top">
                    <div>
                        <h1 id="weekly-detail-title">Dettaglio Settimana</h1>
                        <!-- (Alpha 39) Testo modificato -->
                        <p>Riepilogo per categoria (TUTTE LE SPESE). Clicca per i dettagli.</p> <!-- (Alpha 37) Modificato -->
                    </div>
                 </div>
            </div>
            
             <!-- (Alpha 37) Modificato: ora è un elenco di riepiloghi, non spese -->
            <div id="weekly-detail-list">
                <!-- Riepilogo per categorie caricato da JS -->
            </div>

            <div class="actions" style="margin-top: 20px;">
                <button class="btn btn-secondary" id="back-to-history-from-weekly-detail-btn">Torna al Mese</button>
            </div>
        </div>
        
        <!-- (Alpha 37) Nuova Schermata Dettaglio Categoria Settimanale -->
         <div id="weekly-category-detail-screen" class="hidden">
            <div class="header">
                 <!-- (Alpha 41) Header semplice per schermate secondarie -->
                 <div class="header-top">
                    <div>
                        <h1 id="weekly-category-detail-title">Dettaglio Categoria</h1>
                        <p>Elenco delle spese per la settimana e categoria selezionate.</p>
                    </div>
                 </div>
            </div>
            
            <div id="weekly-category-detail-list">
                <!-- Elenco spese caricato da JS -->
            </div>

            <div class="actions" style="margin-top: 20px;">
                <button class="btn btn-secondary" id="back-to-weekly-detail-from-cat-btn">Torna alla Settimana</button>
            </div>
        </div>


        <!-- Schermata Modifica Spesa (Alpha 1) -->
        <div id="edit-expense-screen" class="hidden">
            <div class="header">
                 <!-- (Alpha 41) Header semplice per schermate secondarie -->
                 <div class="header-top">
                    <div>
                        <h1 id="edit-expense-title">Modifica Spesa</h1>
                    </div>
                 </div>
            </div>
            <div class="card">
                <div class="input-group">
                    <label for="edit-expense-amount">Importo (€)</label>
                    <input type="number" id="edit-expense-amount" placeholder="0.00" step="0.01">
                </div>
                <div class="input-group">
                    <label for="edit-expense-note">Nota (opzionale)</label>
                    <textarea id="edit-expense-note" placeholder="Es. Spesa settimanale"></textarea>
                </div>
            </div>
            <div class="actions" style="grid-template-columns: 1fr 1fr; gap: 12px;">
                <button class="btn btn-danger" id="cancel-edit-btn">Annulla</button>
                <button class="btn" id="confirm-edit-btn">Salva Modifiche</button>
            </div>
            <!-- (Alpha 53) Pulsante Elimina Spesa RIMOSSO da qui -->
            <!--
            <div class="actions" style="margin-top: 20px;">
                <button class="btn btn-danger" id="delete-expense-btn">Elimina Spesa</button>
            </div>
            -->
        </div>
        
        <!-- (Alpha 36) Nuova Schermata Grafico Spese -->
        <div id="chart-screen" class="hidden">
            <div class="header">
                 <!-- (Alpha 41) Header semplice per schermate secondarie -->
                 <div class="header-top">
                    <div>
                        <h1>Grafico Spese</h1>
                        <p>Analisi delle spese settimanali (solo spese variabili).</p>
                    </div>
                 </div>
            </div>
            
            <div class="card">
                <div class="input-group" style="margin-bottom: 0;">
                    <label for="chart-category-select">Scegli Categoria</label>
                    <select id="chart-category-select">
                        <!-- Opzioni caricate da JS -->
                    </select>
					<div class="input-group" style="margin-top: 15px;">
  <label for="chart-period">Periodo</label>
  <select id="chart-period">
    <option value="week">Settimana in corso</option>
    <option value="month" selected>Mese in corso</option>
    <option value="year">Anno in corso</option>
  </select>
</div>

                </div>
            </div>
            
            <div id="chart-container">
                <canvas id="expense-chart"></canvas>
				<canvas id="pie-chart" style="margin-top:20px; max-height:400px;"></canvas>			
            </div>

            <div class="actions" style="margin-top: 20px;">
                <button class="btn btn-secondary" id="back-to-home-from-chart-btn">Torna alla Home</button>
            </div>
        </div>

    </div>
    
    <!-- Modale di Conferma Personalizzato (Alpha 1 / Alpha 27) -->
    <div id="custom-modal" class="modal-overlay hidden"> <!-- Modificato per animazione -->
        <div class="modal-content">
            <h3 id="modal-title">Sei sicuro?</h3>
            <p id="modal-text">Questa azione è irreversibile.</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="modal-cancel-btn">Annulla</button>
                <button class="btn btn-danger" id="modal-confirm-btn">Conferma</button>
            </div>
        </div>
    </div>
    
    <!-- (Alpha 27) Toast Message -->
    <div id="toast-message">Messaggio Toast</div>

    <script>
        // JAVASCRIPT: Tutta la logica dell'app (versione localStorage)
        
        document.addEventListener('DOMContentLoaded', () => {
		Chart.register(ChartDataLabels);

            // (Alpha 48) Blocco Service Worker completamente Rimosso per evitare errori.
            
            // (Alpha 55) Aggiunte icone SVG
            const PRESET_ICONS = {
  'home': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
          fill="#20c997" stroke="#0f5132" stroke-width="1.5">
    <path d="M3 12l9-9 9 9v9a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1z"/>
  </svg>`,

  'car': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
          fill="#9333ea" stroke="#6b21a8" stroke-width="1.5">
    <path d="M3 13l2-5a2 2 0 0 1 1.9-1.3h10.2a2 2 0 0 1 1.9 1.3l2 5v6a1 1 0 0 1-1 1h-1a2 2 0 0 1-4 0H9a2 2 0 0 1-4 0H4a1 1 0 0 1-1-1v-6z"/>
    <circle cx="7.5" cy="18.5" r="1.5" fill="#1f2937"/>
    <circle cx="16.5" cy="18.5" r="1.5" fill="#1f2937"/>
  </svg>`,

  'phone': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
          fill="#fd7e14" stroke="#7c2d12" stroke-width="1.5">
    <path stroke-linecap="round" stroke-linejoin="round" 
          d="M2.25 6.75c0-1.243 1.007-2.25 2.25-2.25h2.25c.621 0 1.152.448 1.227 1.065l.348 2.784a1.125 1.125 0 01-.324.945l-1.26 1.26a16.5 16.5 0 007.29 7.29l1.26-1.26c.267-.267.66-.39 1.045-.324l2.784.348c.617.075 1.065.606 1.065 1.227V19.5c0 1.243-1.007 2.25-2.25 2.25h-1.5C8.268 21.75 2.25 15.732 2.25 8.25v-1.5z"/>
  </svg>`,

  'card': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
          fill="#4A69E2" stroke="#1e3a8a" stroke-width="1.5">
    <rect x="2" y="5" width="20" height="14" rx="2" ry="2"/>
    <line x1="2" y1="10" x2="22" y2="10" stroke="#fff" stroke-width="1.5"/>
  </svg>`,

  'euro': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
          fill="#ffc107" stroke="#b45309" stroke-width="1.5">
    <path d="M17 7a6 6 0 00-11.5 3H3m2.5 4A6 6 0 0017 17h1m-15-4h15"/>
  </svg>`
};

            const ICON_KEYS = Object.keys(PRESET_ICONS);

            // (Alpha 17 / Alpha 71) Calcolo Versione
            const buildNumber = 71; // (Alpha 71) Aggiornato build		(numero versione)
            const patch = buildNumber % 100; 
            const minor = Math.floor(buildNumber / 100) % 10; 
            const major = Math.floor(buildNumber / 1000); 
            const versionString = `V${major}.${minor}.${patch}`;
            // Fine Calcolo Versione

            // Seleziona tutti gli elementi DOM necessari
            const screens = {
                home: document.getElementById('home-screen'),
                addCategory: document.getElementById('add-expense-category-screen'),
                manageCategories: document.getElementById('manage-categories-screen'),
                addAmount: document.getElementById('add-expense-amount-screen'),
                viewExpenses: document.getElementById('view-expenses-screen'),
                categoryDetail: document.getElementById('category-detail-screen'), 
                editExpense: document.getElementById('edit-expense-screen'), 
                editCategory: document.getElementById('edit-category-screen'), 
                monthlyHistory: document.getElementById('monthly-history-screen'),
                weeklyDetail: document.getElementById('weekly-detail-screen'), // (Alpha 36)
                weeklyCategoryDetail: document.getElementById('weekly-category-detail-screen'), // (Alpha 37)
                chart: document.getElementById('chart-screen'), // (Alpha 36)
            };

            const elements = {
                mainContainer: document.getElementById('main-container'), 
                currentDate: document.getElementById('current-date'),
                weeklyTotal: document.getElementById('weekly-total'),
                monthlyTotal: document.getElementById('monthly-total'),
                weeklyDateRange: document.getElementById('weekly-date-range'), 
                monthlyName: document.getElementById('monthly-name'), 
                monthlyBudgetSummary: document.getElementById('monthly-budget-summary'), // (Alpha 28)
                fixedExpensesSummary: document.getElementById('fixed-expenses-summary'), // (Alpha 55)
                addExpenseBtn: document.getElementById('add-expense-btn'),
                categorySelectionGrid: document.getElementById('category-selection-grid'),
                addAmountTitle: document.getElementById('add-amount-title'),
                expenseAmount: document.getElementById('expense-amount'),
                expenseNote: document.getElementById('expense-note'),
				expenseRecurring: document.getElementById('expense-recurring'),
                confirmExpenseBtn: document.getElementById('confirm-expense-btn'), 
                viewExpensesGrid: document.getElementById('view-expenses-grid'),
                newCategoryName: document.getElementById('new-category-name'),
                newCategoryIsPresetCheckbox: document.getElementById('new-category-is-preset'),
                newCategoryPresetValueGroup: document.getElementById('new-category-preset-value-group'),
                newCategoryPresetValueInput: document.getElementById('new-category-preset-value'),
                newCategoryIconSelectGroup: document.getElementById('new-category-icon-select-group'), // (Alpha 55)
                newCategoryIconSelect: document.getElementById('new-category-icon-select'), // (Alpha 55)
                newCategoryBudgetFieldsDiv: document.getElementById('new-category-budget-fields'),
                newCategoryBudgetType: document.getElementById('new-category-budget-type'), 
                newCategoryBudgetValue: document.getElementById('new-category-budget-value'),
                saveCategoryBtn: document.getElementById('save-category-btn'),
                manageCategoryList: document.getElementById('manage-category-list'),
                noExpensesMessage: document.getElementById('no-expenses-message'), 
                weeklyBox: document.getElementById('weekly-box'),
                monthlyBox: document.getElementById('monthly-box'),
                monthlyHistoryTitle: document.getElementById('monthly-history-title'),
                monthlyHistoryGrid: document.getElementById('monthly-history-grid'),
                manageCategoriesBtnHome: document.getElementById('manage-categories-btn-home'), 
                categoryDetailTitle: document.getElementById('category-detail-title'),
                expenseList: document.getElementById('expense-list'),
                editExpenseTitle: document.getElementById('edit-expense-title'),
                editExpenseAmount: document.getElementById('edit-expense-amount'),
                editExpenseNote: document.getElementById('edit-expense-note'),
                confirmEditBtn: document.getElementById('confirm-edit-btn'),
                // (Alpha 54) Riferimento rimosso
                // deleteExpenseBtn: document.getElementById('delete-expense-btn'), 
                editCategoryTitle: document.getElementById('edit-category-title'),
                editCategoryName: document.getElementById('edit-category-name'),
                editCategoryIsPresetCheckbox: document.getElementById('edit-category-is-preset'),
                editCategoryPresetValueGroup: document.getElementById('edit-category-preset-value-group'),
                editCategoryPresetValueInput: document.getElementById('edit-category-preset-value'),
				editCategoryRecurring: document.getElementById('edit-category-recurring'),
                editCategoryIconSelectGroup: document.getElementById('edit-category-icon-select-group'), // (Alpha 55)
                editCategoryIconSelect: document.getElementById('edit-category-icon-select'), // (Alpha 55)
                editCategoryBudgetFieldsDiv: document.getElementById('edit-category-budget-fields'),
                editCategoryBudgetType: document.getElementById('edit-category-budget-type'), 
                editCategoryBudgetValue: document.getElementById('edit-category-budget-value'),
                confirmEditCategoryBtn: document.getElementById('confirm-edit-category-btn'),
                appVersion: document.getElementById('app-version'), 
                importBtn: document.getElementById('import-btn'),
                exportBtn: document.getElementById('export-btn'),
                importFileInput: document.getElementById('import-file-input'),
                toastMessage: document.getElementById('toast-message'), 
                globalMonthlyBudgetInput: document.getElementById('global-monthly-budget'),
                saveGlobalBudgetBtn: document.getElementById('save-global-budget-btn'),
                // (Alpha 36) Nuovi elementi
                viewChartBtn: document.getElementById('view-chart-btn'),
                chartCategorySelect: document.getElementById('chart-category-select'),
                expenseChartCanvas: document.getElementById('expense-chart'),
                // ...
                expenseChartCanvas: document.getElementById('expense-chart'),
                // (Alpha 72) Aggiunti selettori storico
                historyMonthSelect: document.getElementById('history-month-select'),
                historyYearSelect: document.getElementById('history-year-select'),
                // ...
                weeklyDetailTitle: document.getElementById('weekly-detail-title'),
                weeklyDetailList: document.getElementById('weekly-detail-list'),
                // (Alpha 37) Nuovi elementi
                weeklyCategoryDetailTitle: document.getElementById('weekly-category-detail-title'),
                weeklyCategoryDetailList: document.getElementById('weekly-category-detail-list'),
            };

            const backButtons = {
                backToHomeFromAdd: document.getElementById('back-to-home-from-add-btn'),
                backToHomeFromView: document.getElementById('back-to-home-from-view-btn'),
                cancelAddAmount: document.getElementById('cancel-add-amount-btn'),
                backToHomeFromManage: document.getElementById('back-to-home-from-manage-btn'), 
                backToViewFromDetail: document.getElementById('back-to-view-from-detail-btn'), 
                cancelEditBtn: document.getElementById('cancel-edit-btn'), 
                cancelEditCategory: document.getElementById('cancel-edit-category-btn'), 
                backToHomeFromMonthly: document.getElementById('back-to-home-from-monthly-btn'),
                backToHomeFromChart: document.getElementById('back-to-home-from-chart-btn'), // (Alpha 36)
                backToHistoryFromWeeklyDetail: document.getElementById('back-to-history-from-weekly-detail-btn'), // (Alpha 36)
                backToWeeklyDetailFromCat: document.getElementById('back-to-weekly-detail-from-cat-btn'), // (Alpha 37)
            };
            
            const modal = {
                overlay: document.getElementById('custom-modal'),
                title: document.getElementById('modal-title'),
                text: document.getElementById('modal-text'),
                cancelBtn: document.getElementById('modal-cancel-btn'),
                confirmBtn: document.getElementById('modal-confirm-btn'),
            };

            let state = {
                currentScreen: 'home',
                expenses: [], 
                categories: [], 
                globalMonthlyBudget: 0, 
                selectedCategory: null,
                selectedCategoryForDetail: null, 
                editingExpenseId: null, 
                editingCategoryId: null, 
                modalCallback: null, 
                toastTimeout: null, 
                selectedWeekForDetail: null, // (Alpha 36)
                selectedCategoryForWeeklyDetail: null, // (Alpha 37)
                expenseListReturnScreen: 'categoryDetail', // (Alpha 36)
                tempSelectedIcon: null, // (Alpha 55)
                // ...
                tempSelectedIcon: null, // (Alpha 55)
                // (Alpha 72) Aggiunti per storico
                viewingMonth: null, // 0-11
                viewingYear: null,
            };
            
            // --- GESTIONE DATI con localStorage ---
            function loadData() {
                try {
                    const savedExpenses = localStorage.getItem('expenses');
                    const savedCategories = localStorage.getItem('categories');
                    const savedGlobalBudget = localStorage.getItem('globalMonthlyBudget'); 

                    state.expenses = savedExpenses ? JSON.parse(savedExpenses) : [];
                    state.globalMonthlyBudget = savedGlobalBudget ? parseFloat(savedGlobalBudget) : 0; 

                    if (savedCategories) {
                        state.categories = JSON.parse(savedCategories);
                        
                        // Migrazione Dati 
                        let needsSave = false;
                        state.categories.forEach(cat => {
                            if (cat.budget !== undefined) { 
                                cat.budgetType = 'weekly';
                                cat.budgetValue = cat.budget;
                                delete cat.budget; 
                                needsSave = true;
                            }
                            if (!cat.budgetType) { 
                                cat.budgetType = 'none';
                                cat.budgetValue = null;
                                needsSave = true; 
                            }
                            if (cat.isSpecial === undefined) {
                                cat.isSpecial = false;
                                cat.presetValue = null;
                                needsSave = true;
                            }
                            // (Alpha 55) Migrazione Icone
                            if (cat.isSpecial && !cat.icon) {
                                cat.icon = 'euro'; // Icona di default
                                needsSave = true;
                            }
                        });
                        if (needsSave) {
                            saveCategories(); 
                        }
                        
                    } else {
                        // Categorie di default
                        state.categories = [
                            { id: 1, name: 'Alimentari', budgetType: 'weekly', budgetValue: 100, isSpecial: false, presetValue: null, icon: null },
                            { id: 2, name: 'Benzina', budgetType: 'monthly', budgetValue: 200, isSpecial: false, presetValue: null, icon: null },
                            { id: 3, name: 'Ristorante', budgetType: 'weekly', budgetValue: 80, isSpecial: false, presetValue: null, icon: null },
                            { id: 4, name: 'Affitto', budgetType: 'none', budgetValue: null, isSpecial: true, presetValue: 500, icon: 'home' }, 
                            { id: 5, name: 'Caffè', budgetType: 'none', budgetValue: null, isSpecial: true, presetValue: 1.20, icon: 'euro' }, 
                        ];
                        saveCategories();
                    }
                } catch (e) {
                    console.error("Errore caricamento localStorage: ", e);
                    state.expenses = [];
                    state.categories = [];
                    state.globalMonthlyBudget = 0; 
                     showModal('Errore Dati', 'Impossibile caricare i dati. Modalità privata?', () => {});
                }
            }

            function saveExpenses() {
                try {
                    localStorage.setItem('expenses', JSON.stringify(state.expenses));
                } catch (e) { console.error("Errore salvataggio spese: ", e); showModal('Errore Salvataggio', 'Impossibile salvare le spese.', () => {}); }
            }
            
            function saveCategories() {
                 try {
                    localStorage.setItem('categories', JSON.stringify(state.categories));
                 } catch (e) { console.error("Errore salvataggio categorie: ", e); showModal('Errore Salvataggio', 'Impossibile salvare le categorie.', () => {}); }
            }

             // (Alpha 28) Funzione per salvare il budget globale
            function saveGlobalBudget() {
                 try {
                     localStorage.setItem('globalMonthlyBudget', state.globalMonthlyBudget.toString());
                 } catch (e) { console.error("Errore salvataggio budget globale: ", e); showModal('Errore Salvataggio', 'Impossibile salvare il budget mensile.', () => {}); }
            }
            // --- FINE GESTIONE DATI localStorage ---

            // --- LOGICA MODALE (Invariata) ---
           function showModal(title, text, onConfirm) {
  modal.title.textContent = title;
  modal.text.textContent = text;
  state.modalCallback = onConfirm;

  // Rimuovi la classe hidden per rendere il modale visibile
  modal.overlay.classList.remove('hidden');

  // Usa il frame successivo per applicare la classe visible (transizione)
  requestAnimationFrame(() => {
    modal.overlay.classList.add('visible');
  });
}

function hideModal() {
  // Rimuovi la classe visible per avviare la transizione di chiusura
  modal.overlay.classList.remove('visible');

  // Dopo la transizione, ri-nascondi completamente l'overlay
  setTimeout(() => {
    if (!modal.overlay.classList.contains('visible')) {
      modal.overlay.classList.add('hidden');
      state.modalCallback = null;
    }
  }, 200); // stesso valore della transition CSS
}

            modal.cancelBtn.addEventListener('click', hideModal);
            modal.confirmBtn.addEventListener('click', () => {
                 if (state.modalCallback) {
                    state.modalCallback(); 
                }
                hideModal();
            });
            modal.overlay.addEventListener('click', (event) => {
                 if (event.target === modal.overlay) { 
                     hideModal();
                 }
            });

            // --- LOGICA TOAST (Invariata) ---
            function showToast(message) {
                 if (state.toastTimeout) {
                    clearTimeout(state.toastTimeout);
                    elements.toastMessage.classList.remove('visible'); 
                 }
                // Forza reflow per riavviare l'animazione se il toast era già visibile
                void elements.toastMessage.offsetWidth; 

                elements.toastMessage.textContent = message;
                elements.toastMessage.classList.add('visible');

                state.toastTimeout = setTimeout(() => {
                    elements.toastMessage.classList.remove('visible');
                    state.toastTimeout = null;
                }, 3000); // Nasconde dopo 3 secondi
            }

            // --- UTILITY PER LE DATE (Invariate) ---
            function getWeekRange(date) {
                const today = new Date(date.getTime()); 
                const dayOfWeek = today.getDay(); 
                const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; 
                const monday = new Date(new Date(today).setDate(today.getDate() + diffToMonday));
                const sunday = new Date(new Date(monday).setDate(monday.getDate() + 6)); 
                const formatDate = (d) => d.toLocaleString('it-IT', { day: '2-digit', month: '2-digit' });
                return `Lun (${formatDate(monday)}) - Dom (${formatDate(sunday)})`;
             }
            function getWeekNumber(d) {
                if (!(d instanceof Date) || isNaN(d)) { return getWeekNumber(new Date()); }
                d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
                const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
                return weekNo;
             }
            function getWeekOfMonth(date) {
                if (!(date instanceof Date) || isNaN(date)) { date = new Date(); }
                const firstDayOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);
                const firstDayOfWeek = firstDayOfMonth.getDay() === 0 ? 6 : firstDayOfMonth.getDay() - 1; 
                const offset = (date.getDate() + firstDayOfWeek - 1);
                return Math.floor(offset / 7) + 1;
            }

            // --- (Alpha 38) HELPER PER FILTRO PREDEFINITE ---
            /**
             * Controlla se una spesa appartiene a una categoria predefinita.
             * @param {object} expense - L'oggetto spesa.
             * @returns {boolean} - True se la spesa è predefinita, altrimenti false.
             */
            function isPresetExpense(expense) {
                // (Alpha 39) Rinomina "isSpecial" in "isFixed" (Spesa Fissa)
                // Controllo robusto per compatibilità
                const category = state.categories.find(c => c.id === expense.categoryId);
                return category && (category.isSpecial === true || category.isFixed === true);
            }


            // --- NAVIGAZIONE TRA SCHERMATE (Invariata) ---
            function navigate(screenName) {
                state.currentScreen = screenName;
                Object.values(screens).forEach(screen => screen.classList.add('hidden'));
                if (screens[screenName]) { 
                    screens[screenName].classList.remove('hidden');
                } else {
                    console.error(`Schermata non trovata: ${screenName}`);
                    screens.home.classList.remove('hidden'); // Fallback alla home
                }
                 // Aggiorna UI
                 switch (screenName) {
                    case 'home': renderHomeScreen(); break; 
                    case 'addCategory': renderCategorySelectionScreen(); break; 
                    case 'manageCategories': renderManageCategoriesScreen(); break; 
                    case 'viewExpenses': renderViewExpensesScreen(); break; 
                    case 'categoryDetail': renderCategoryDetailScreen(); break; 
                    case 'editExpense': renderEditExpenseScreen(); break; 
                    case 'editCategory': renderEditCategoryScreen(); break; 
                    case 'monthlyHistory':
                        // (Alpha 72) Imposta il mese/anno corrente all'ingresso
                        const now = new Date();
                        state.viewingMonth = now.getMonth(); // 0-11
                        state.viewingYear = now.getFullYear();
                        renderMonthlyHistoryScreen(); 
                        break;
                    case 'weeklyDetail': renderWeeklyDetailScreen(); break; // (Alpha 36)
                    case 'weeklyCategoryDetail': renderWeeklyCategoryDetailScreen(); break; // (Alpha 37)
                    case 'chart': renderChartScreen(); break; // (Alpha 36)
                }
            }

            // --- FUNZIONI DI VISUALIZZAZIONE ---
            
            // (Alpha 38 / 55) MODIFICATA
            function renderHomeScreen() {
                 const now = new Date();
                 const weekOfMonth = getWeekOfMonth(now);
                 const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0); 
                 const totalWeeksInMonth = getWeekOfMonth(lastDayOfMonth);
                 // (Alpha 35) Modificato per andare a capo
                 const dateString = now.toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                 const weekString = `Settimana ${weekOfMonth} su ${totalWeeksInMonth}`;
                 elements.currentDate.innerHTML = `${dateString}<br>${weekString}`;
                 
                 const weekRangeString = getWeekRange(now);
                 elements.weeklyDateRange.textContent = weekRangeString;
                 let monthName = now.toLocaleDateString('it-IT', { month: 'long' });
                 monthName = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                 elements.monthlyName.textContent = `(${monthName})`;
                 const currentWeek = getWeekNumber(now);
                 const currentMonth = now.getMonth();
                 const currentYear = now.getFullYear();

                 // (Alpha 38) Filtra spese settimanali (SOLO VARIABILI)
                 const weeklyExpenses = state.expenses.filter(e => {
                     try { 
                         const d = new Date(e.date); 
                         return !isNaN(d) && 
                                getWeekNumber(d) === currentWeek && 
                                d.getFullYear() === currentYear &&
                                !isPresetExpense(e); // <<<< FILTRO MANTENUTO
                    } catch(err){ return false; }
                 });
                 
                 // (Alpha 38) Filtra spese mensili (TUTTE) - Invariato
                 const monthlyExpenses = state.expenses.filter(e => {
                     try { const d = new Date(e.date); return !isNaN(d) && d.getMonth() === currentMonth && d.getFullYear() === currentYear; } catch(err){ return false; }
                 });
                 
                 const weeklyTotal = weeklyExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
                 const monthlyTotal = monthlyExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
                 elements.weeklyTotal.textContent = `€${weeklyTotal.toFixed(2)}`;
                 elements.monthlyTotal.textContent = `€${monthlyTotal.toFixed(2)}`;

                 // (Alpha 28) Visualizza Budget Rimanente (basato sul totale mensile completo)
                 if (state.globalMonthlyBudget > 0) {
                     const remaining = state.globalMonthlyBudget - monthlyTotal;
                     elements.monthlyBudgetSummary.innerHTML = `
                        <h4>BUDGET RESIDUO:</h4>
                        <p class="remaining-budget">€${remaining.toFixed(2)}</p>
                     `;
                 } else {
                     elements.monthlyBudgetSummary.innerHTML = `
                        <h4>BUDGET RESIDUO:</h4>
                        <p class="remaining-budget" style="font-size: 11px; color: var(--secondary-text-color); font-weight: normal;">Non impostato</p>
                     `; 
                 }
                 
                 // (Alpha 55) Popola icone spese fisse
                 elements.fixedExpensesSummary.innerHTML = ''; // Pulisci
                 const monthlyFixedExpenses = monthlyExpenses.filter(isPresetExpense);
                 const paidCategoryIds = new Set(monthlyFixedExpenses.map(e => e.categoryId));
                 
                 paidCategoryIds.forEach(catId => {
                    const category = state.categories.find(c => c.id === catId);
                    if (category && category.icon && PRESET_ICONS[category.icon]) {
                        const iconWrapper = document.createElement('div');
                        iconWrapper.className = 'summary-icon-item';
                        iconWrapper.title = category.name; // Tooltip
                        iconWrapper.innerHTML = PRESET_ICONS[category.icon];
                        elements.fixedExpensesSummary.appendChild(iconWrapper);
                    }
                 });
             }
             
             // Invariata
             function renderCategorySelectionScreen() { 
                 elements.categorySelectionGrid.innerHTML = ''; 
                 const sortedCategories = [...state.categories].sort((a, b) => a.name.localeCompare(b.name));
                 sortedCategories.forEach(cat => {
                    const item = document.createElement('div');
                    item.className = 'category-item';
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'category-name';
                    nameSpan.textContent = cat.name;
                    nameSpan.addEventListener('click', () => {
                        const clickedCategory = state.categories.find(c => c.id === cat.id); 
                        if (!clickedCategory) { console.error("Categoria non trovata:", cat.id); return; }

                        // (Alpha 39) Rinomina 'isSpecial' in 'isFixed'
                        if (clickedCategory.isSpecial && clickedCategory.presetValue > 0) {
                             addPresetExpense(clickedCategory);
                        } else {
                            state.selectedCategory = clickedCategory.id;
                            elements.addAmountTitle.textContent = `Spesa per ${clickedCategory.name}`;
                            navigate('addAmount');
                        }
                    });
                    item.appendChild(nameSpan);
                    elements.categorySelectionGrid.appendChild(item);
                 });
             }
             
             // (Alpha 55) MODIFICATA
             function renderManageCategoriesScreen() {
                 elements.globalMonthlyBudgetInput.value = state.globalMonthlyBudget > 0 ? state.globalMonthlyBudget : '';
                 elements.manageCategoryList.innerHTML = '';
                 const sortedCategories = [...state.categories].sort((a, b) => a.name.localeCompare(b.name));
                 sortedCategories.forEach(cat => {
                     const item = document.createElement('div');
                     item.className = 'category-item';
                     const nameSpan = document.createElement('span');

                     nameSpan.className = 'category-name'; 
                     nameSpan.textContent = cat.name;
                     const currentCatId = cat.id; 
                     nameSpan.addEventListener('click', () => {
                        state.editingCategoryId = currentCatId; 
                        navigate('editCategory');
                     });
                     const deleteIcon = document.createElement('div');
                     deleteIcon.className = 'delete-icon';
                     deleteIcon.innerHTML = '&times;'; 
                     deleteIcon.addEventListener('click', () => {
                        showModal(
                            'Elimina Categoria', 
                            `Sei sicuro di voler eliminare la categoria "${cat.name}"? Verranno eliminate anche tutte le spese associate.`, 
                            () => deleteCategory(currentCatId) 
                        );
                     });
                     
                     // (Alpha 55) Aggiungi icona se è spesa fissa
                     if (cat.isSpecial && cat.icon && PRESET_ICONS[cat.icon]) {
                         const iconEl = document.createElement('div');
                         iconEl.style.color = 'var(--primary-color)';
                         iconEl.style.marginTop = '5px';
                         iconEl.innerHTML = PRESET_ICONS[cat.icon];
                         iconEl.querySelector('svg').style.width = '20px';
                         iconEl.querySelector('svg').style.height = '20px';
                         iconEl.querySelector('svg').style.margin = 'auto';
                         nameSpan.insertAdjacentElement('beforebegin', iconEl);
                     }
                     
                     item.appendChild(nameSpan);
                     item.appendChild(deleteIcon);
                     elements.manageCategoryList.appendChild(item);
                 });
                 
                 // Renderizza la griglia icone per AGGIUNGI
                 renderIconSelection('new-category-icon-select', 'euro'); // 'euro' è il default
                 state.tempSelectedIcon = 'euro'; // Imposta default
             }
             
             // (Alpha 55) MODIFICATA
             function renderEditCategoryScreen() { 
                 const category = state.categories.find(c => c.id === state.editingCategoryId);
                 if (!category) { navigate('manageCategories'); return; }
                 elements.editCategoryTitle.textContent = `Modifica: ${category.name}`;
                 elements.editCategoryName.value = category.name;
                 elements.editCategoryIsPresetCheckbox.checked = category.isSpecial || false; 
                 
                 const selectedIcon = category.icon || 'euro'; // Default a 'euro'
                 state.tempSelectedIcon = selectedIcon; // Imposta icona attuale
                 renderIconSelection('edit-category-icon-select', selectedIcon);
                 
                 handlePresetToggleEdit(); // Chiama dopo aver impostato l'icona
                 
                 if (category.isSpecial) { 
                    elements.editCategoryPresetValueInput.value = category.presetValue || '';
					elements.editCategoryRecurring.checked = !!category.recurring;
                 } else {
                    elements.editCategoryBudgetType.value = category.budgetType || 'none';
                    elements.editCategoryBudgetValue.value = (category.budgetValue && category.budgetValue > 0) ? category.budgetValue : '';
                 }
                 elements.editCategoryIsPresetCheckbox.removeEventListener('change', handlePresetToggleEdit); 
                 elements.editCategoryIsPresetCheckbox.addEventListener('change', handlePresetToggleEdit);
             }
             
             // (Alpha 55) NUOVA FUNZIONE
             function renderIconSelection(containerId, selectedIconName) {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = '';
                
                ICON_KEYS.forEach(iconName => {
                    const item = document.createElement('div');
                    item.className = 'icon-select-item';
                    item.dataset.icon = iconName;
                    item.innerHTML = PRESET_ICONS[iconName];
                    
                    if (iconName === selectedIconName) {
                        item.classList.add('selected');
                    }
                    
                    item.addEventListener('click', () => {
                        // Aggiorna stato temporaneo
                        state.tempSelectedIcon = iconName;
                        // Aggiorna UI
                        container.querySelectorAll('.icon-select-item').forEach(el => el.classList.remove('selected'));
                        item.classList.add('selected');
                    });
                    
                    container.appendChild(item);
                });
             }
             
             // (Alpha 38) Mantenuta SOLO VARIABILI
             function renderViewExpensesScreen() { 
                 const now = new Date();
                 const currentWeek = getWeekNumber(now);
                 const currentYear = now.getFullYear();
                 const currentMonth = now.getMonth();

                 // (Alpha 38) Filtra spese settimanali (SOLO VARIABILI)
                 const weeklyExpenses = state.expenses.filter(e => {
                     try { 
                         const expenseDate = new Date(e.date); 
                         return !isNaN(expenseDate) && 
                                getWeekNumber(expenseDate) === currentWeek && 
                                expenseDate.getFullYear() === currentYear &&
                                !isPresetExpense(e); // <<<< FILTRO MANTENUTO
                    } catch(err) { return false; }
                 });
                 
                 if (weeklyExpenses.length === 0) {
                    elements.noExpensesMessage.classList.remove('hidden');
                    elements.viewExpensesGrid.classList.add('hidden');
                    return; 
                 }
                 elements.noExpensesMessage.classList.add('hidden');
                 elements.viewExpensesGrid.classList.remove('hidden');
                 
                 elements.viewExpensesGrid.innerHTML = ''; 
                 state.categories.forEach(cat => {
                    // (Alpha 38) Ignora categorie fisse in questa vista
                    if (cat.isSpecial) return; 

                    const weeklyCategoryExpenses = weeklyExpenses.filter(e => e.categoryId === cat.id);
                    if (weeklyCategoryExpenses.length === 0) return; 
                    
                    const weeklyTotal = weeklyCategoryExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
                    
                    // (Alpha 38) Calcolo Mese (SOLO VARIABILI) per coerenza
                    const monthlyCategoryExpenses = state.expenses.filter(e => {
                         try { 
                             const expenseDate = new Date(e.date); 
                             return !isNaN(expenseDate) && 
                                    e.categoryId === cat.id && 
                                    expenseDate.getMonth() === currentMonth && 
                                    expenseDate.getFullYear() === currentYear &&
                                    !isPresetExpense(e); // <<<< FILTRO MANTENUTO
                        } catch(err) { return false; }
                    });
                    const monthlyTotal = monthlyCategoryExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);

                    const item = document.createElement('div');
                    item.className = 'expense-category-item';
                    let percentage = 0;
                    let budgetHTML = '<p>Budget: N/D</p>';
                    
                    if (cat.budgetType === 'weekly' && cat.budgetValue > 0) {
                        percentage = (weeklyTotal / cat.budgetValue) * 100;
                        budgetHTML = `<p>Budget: €${cat.budgetValue.toFixed(2)} (Sett.)</p>`;
                    } else if (cat.budgetType === 'monthly' && cat.budgetValue > 0) {
                        percentage = (monthlyTotal / cat.budgetValue) * 100; 
                        budgetHTML = `<p>Budget: €${cat.budgetValue.toFixed(2)} (Mens.)</p>`;
                    }
                    
                    let colorClass = 'var(--green)'; 
                    if (percentage >= 33 && percentage < 66) colorClass = 'var(--yellow)';
                    else if (percentage >= 66 && percentage < 100) colorClass = 'var(--orange)';
                    else if (percentage >= 100) colorClass = 'var(--red)';
                    item.style.backgroundColor = colorClass; 
                    
                    item.innerHTML = `
                        <h4>${cat.name}</h4> 
                        ${budgetHTML} 
                        <div class="amount">€${weeklyTotal.toFixed(2)}</div>`;
                        
                    item.addEventListener('click', () => {
                        state.selectedCategoryForDetail = cat.id; 
                        navigate('categoryDetail'); 
                    });
                    elements.viewExpensesGrid.appendChild(item);
                 });
             }
             
             // (Alpha 72) MODIFICATA per usare viewingMonth/Year e selettori
            function renderMonthlyHistoryScreen() {
                const now = new Date();
                const currentMonth = state.viewingMonth; // 0-11
                const currentYear = state.viewingYear;

                // --- 1. Popola i selettori ---
                const monthNames = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
                elements.historyMonthSelect.innerHTML = '';
                monthNames.forEach((name, index) => {
                    const option = document.createElement('option');
                    option.value = index; // 0-11
                    option.textContent = name;
                    if (index === currentMonth) option.selected = true;
                    elements.historyMonthSelect.appendChild(option);
                });

                // Popola Anni (dal 2023 all'anno corrente + 1, o dall'anno della spesa più vecchia)
                let minYear = 2023;
                if (state.expenses.length > 0) {
                    const oldestExpense = state.expenses.reduce((oldest, e) => {
                        const d = new Date(e.date);
                        return d < oldest ? d : oldest;
                    }, new Date());
                    minYear = oldestExpense.getFullYear();
                }
                const maxYear = now.getFullYear();
                
                elements.historyYearSelect.innerHTML = '';
                for (let y = maxYear; y >= minYear; y--) {
                    const option = document.createElement('option');
                    option.value = y;
                    option.textContent = y;
                    if (y === currentYear) option.selected = true;
                    elements.historyYearSelect.appendChild(option);
                }

                // --- 2. Aggancia i listener (usando .onchange per evitare duplicati) ---
                elements.historyMonthSelect.onchange = () => {
                    state.viewingMonth = parseInt(elements.historyMonthSelect.value);
                    renderMonthlyHistoryScreen(); // Ridisegna
                };
                elements.historyYearSelect.onchange = () => {
                    state.viewingYear = parseInt(elements.historyYearSelect.value);
                    renderMonthlyHistoryScreen(); // Ridisegna
                };

                // --- 3. Filtra e disegna i dati ---
                const selectedDate = new Date(currentYear, currentMonth, 1);
                elements.monthlyHistoryTitle.textContent = `Riepilogo: ${selectedDate.toLocaleDateString('it-IT', { month: 'long', year: 'numeric' })}`;
                 
                const monthlyExpenses = state.expenses.filter(e => {
                    try { 
                        const expenseDate = new Date(e.date); 
                        return !isNaN(expenseDate) && 
                               expenseDate.getMonth() === currentMonth && 
                               expenseDate.getFullYear() === currentYear;
                    } catch(err) { return false; }
                 });
                 
                elements.monthlyHistoryGrid.innerHTML = '';
                if (monthlyExpenses.length === 0) {
                    elements.monthlyHistoryGrid.innerHTML = '<p style="text-align:center; color: var(--secondary-text-color);">Nessuna spesa registrata per questo mese.</p>';
                    return;
                }
                 
                const expensesByWeek = {}; 
                monthlyExpenses.forEach(e => {
                     try { const expenseDate = new Date(e.date); if(isNaN(expenseDate)) throw new Error("Invalid date"); const weekOfMonth = getWeekOfMonth(expenseDate); if (!expensesByWeek[weekOfMonth]) expensesByWeek[weekOfMonth] = 0; expensesByWeek[weekOfMonth] += (e.amount || 0); } catch(err) { console.error("Error processing monthly history:", e, err); }
                 });
                 
                const sortedWeeks = Object.keys(expensesByWeek).sort((a, b) => parseInt(a) - parseInt(b));
                sortedWeeks.forEach(weekNum => {
                    const total = expensesByWeek[weekNum];
                    const item = document.createElement('div');
                    item.className = 'expense-category-item'; 
                    item.style.backgroundColor = 'var(--primary-color)'; 
                    item.innerHTML = `<h4>Settimana ${weekNum}</h4> <div class="amount">€${total.toFixed(2)}</div>`;
                    
                    item.addEventListener('click', () => {
                        state.selectedWeekForDetail = parseInt(weekNum);
                        // NOTA: viewingMonth e viewingYear sono già nello state
                        navigate('weeklyDetail');
                    });

                    elements.monthlyHistoryGrid.appendChild(item);
                });
            }            
             // (Alpha 53) MODIFICATA - Aggiunge X
             function renderCategoryDetailScreen() { 
                 const categoryId = state.selectedCategoryForDetail;
                 if (!categoryId) { navigate('viewExpenses'); return; }
                 const category = state.categories.find(c => c.id === categoryId);
                 if (!category) { navigate('viewExpenses'); return; }
                 elements.categoryDetailTitle.textContent = `Dettaglio: ${category.name}`;
                 elements.expenseList.innerHTML = ''; 
                 const now = new Date();
                 const currentMonth = now.getMonth();
                 const currentYear = now.getFullYear();
                 
                 // (Alpha 38) Filtra spese (SOLO VARIABILI)
                 const categoryMonthlyExpenses = state.expenses.filter(e => {
                    try { 
                        const expenseDate = new Date(e.date); 
                        return !isNaN(expenseDate) && 
                               e.categoryId === categoryId && 
                               expenseDate.getMonth() === currentMonth && 
                               expenseDate.getFullYear() === currentYear &&
                               !isPresetExpense(e); // <<<< FILTRO MANTENUTO
                    } catch(err) { return false; }
                 });

                 if (categoryMonthlyExpenses.length === 0) {
                    elements.expenseList.innerHTML = '<p style="text-align:center; color: var(--secondary-text-color);">Nessuna spesa variabile registrata per questa categoria questo mese.</p>';
                    return;
                 }
                 categoryMonthlyExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));
                 categoryMonthlyExpenses.forEach(e => {
                    const item = document.createElement('div');
                    item.className = 'expense-list-item';
                    const expenseDate = new Date(e.date);
                    const formattedDate = expenseDate.toLocaleDateString('it-IT', { day: '2-digit', month: 'short' });
                    const formattedTime = expenseDate.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                    
                    // (Alpha 53) Aggiunta icona X
                    const deleteIcon = document.createElement('div');
                    deleteIcon.className = 'delete-icon';
                    deleteIcon.innerHTML = '&times;';
                    const expenseId = e.id; // Salva ID
                    deleteIcon.addEventListener('click', (evt) => {
                        evt.stopPropagation(); // Evita di triggerare il click sull'item
                        handleDeleteExpense(expenseId, 'categoryDetail');
                    });

                    item.innerHTML = `<div class="details"> ${formattedDate} - ${formattedTime} ${e.note ? `<div class="note">${e.note}</div>` : ''} </div> <div class="amount">€${(e.amount || 0).toFixed(2)}</div>`;
                    
                    // (Alpha 53) Rendi cliccabile l'item per MODIFICARE
                    item.addEventListener('click', () => {
                        state.expenseListReturnScreen = 'categoryDetail'; 
                        state.editingExpenseId = e.id; 
                        navigate('editExpense'); 
                    });
                    
                    item.appendChild(deleteIcon); // (Alpha 53) Aggiungi l'icona
                    elements.expenseList.appendChild(item);
                 });
             }
             
           // (Alpha 72) MODIFICATA per usare viewingMonth/Year
            function renderWeeklyDetailScreen() {
                const weekNum = state.selectedWeekForDetail;
                // (Alpha 72) Usa il mese/anno in visualizzazione
                const currentMonth = state.viewingMonth; 
                const currentYear = state.viewingYear;

                if (!weekNum || currentMonth === null || currentYear === null) { 
                    navigate('monthlyHistory'); 
                    return; 
                }

                elements.weeklyDetailTitle.textContent = `Dettaglio Spese: Settimana ${weekNum}`;
                elements.weeklyDetailList.innerHTML = ''; 
                
                const weeklyExpenses = state.expenses.filter(e => {
                    try { 
                        const expenseDate = new Date(e.date); 
                        return !isNaN(expenseDate) && 
                               expenseDate.getMonth() === currentMonth && 
                               expenseDate.getFullYear() === currentYear &&
                               getWeekOfMonth(expenseDate) === weekNum;
                    } catch(err) { return false; }
                 });

                 if (weeklyExpenses.length === 0) {
                    elements.weeklyDetailList.innerHTML = '<p style="text-align:center; color: var(--secondary-text-color);">Nessuna spesa registrata per questa settimana.</p>';
                    return;
                 }
                 
                 const expensesByCategory = {};
                 weeklyExpenses.forEach(e => {
                    if (!expensesByCategory[e.categoryId]) {
                        expensesByCategory[e.categoryId] = 0;
                    }
                    expensesByCategory[e.categoryId] += (e.amount || 0);
                 });
                 
                 const sortedCategoryIds = Object.keys(expensesByCategory).sort((a, b) => expensesByCategory[b] - expensesByCategory[a]);

                 sortedCategoryIds.forEach(catId => {
                    const category = state.categories.find(c => c.id == catId);
                    const categoryName = category ? category.name : "Sconosciuta";
                    const total = expensesByCategory[catId];
                    
                    const item = document.createElement('div');
                    item.className = 'category-summary-item'; 
                    item.innerHTML = `
                        <div class="details">${categoryName}</div>
                        <div class="amount">€${total.toFixed(2)}</div>
                    `;
                        
                    item.addEventListener('click', () => {
                        state.selectedCategoryForWeeklyDetail = catId; 
                        // NOTA: weekNum, viewingMonth, viewingYear sono già nello state
                        navigate('weeklyCategoryDetail'); 
                    });
                    elements.weeklyDetailList.appendChild(item);
                 });
            } 
            // (Alpha 72) MODIFICATA per usare viewingMonth/Year
             function renderWeeklyCategoryDetailScreen() {
                 const weekNum = state.selectedWeekForDetail;
                 const categoryId = state.selectedCategoryForWeeklyDetail;
                 // (Alpha 72) Usa il mese/anno in visualizzazione
                 const currentMonth = state.viewingMonth;
                 const currentYear = state.viewingYear;
                 
                 if (!weekNum || !categoryId || currentMonth === null || currentYear === null) { 
                     navigate('weeklyDetail'); 
                     return; 
                 }
                 
                 const category = state.categories.find(c => c.id == categoryId);
                 const categoryName = category ? category.name : "Sconosciuta";
                 elements.weeklyCategoryDetailTitle.textContent = `${categoryName} (Sett. ${weekNum})`;
                 elements.weeklyCategoryDetailList.innerHTML = '';
                 
                 const expenses = state.expenses.filter(e => {
                    try { 
                        const expenseDate = new Date(e.date); 
                        return !isNaN(expenseDate) && 
                               e.categoryId == categoryId && 
                               expenseDate.getMonth() === currentMonth && 
                               expenseDate.getFullYear() === currentYear &&
                               getWeekOfMonth(expenseDate) === weekNum;
                    } catch(err) { return false; }
                 });
                 
                 if (expenses.length === 0) {
                    elements.weeklyCategoryDetailList.innerHTML = '<p style="text-align:center; color: var(--secondary-text-color);">Nessuna spesa trovata.</p>';
                    return;
                 }
                 
                 expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
                 
                 expenses.forEach(e => {
                    const item = document.createElement('div');
                    item.className = 'expense-list-item';
                    const expenseDate = new Date(e.date);
                    const formattedDate = expenseDate.toLocaleDateString('it-IT', { day: '2-digit', month: 'short' });
                    const formattedTime = expenseDate.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                    
                    const deleteIcon = document.createElement('div');
                    deleteIcon.className = 'delete-icon';
                    deleteIcon.innerHTML = '&times;';
                    const expenseId = e.id; 
                    deleteIcon.addEventListener('click', (evt) => {
                        evt.stopPropagation(); 
                        handleDeleteExpense(expenseId, 'weeklyCategoryDetail');
                    });

                    item.innerHTML = `
                        <div class="details">
                            ${formattedDate} - ${formattedTime}
                            ${e.note ? `<div class="note">${e.note}</div>` : ''}
                        </div>
                        <div class="amount">€${(e.amount || 0).toFixed(2)}</div>`;
                        
                    item.addEventListener('click', () => {
                        state.expenseListReturnScreen = 'weeklyCategoryDetail'; 
                        state.editingExpenseId = e.id; 
                        navigate('editExpense'); 
                    });
                    
                    item.appendChild(deleteIcon); 
                    elements.weeklyCategoryDetailList.appendChild(item);
                 });
             }
             // (Alpha 53) MODIFICATA: Rimosso collegamento .onclick a deleteExpenseBtn
             function renderEditExpenseScreen() { 
                 const expense = state.expenses.find(e => e.id === state.editingExpenseId);
                 if (!expense) { 
                     navigate(state.expenseListReturnScreen || 'home'); 
                     return; 
                 }
                 const category = state.categories.find(c => c.id === expense.categoryId);
                 elements.editExpenseTitle.textContent = `Modifica Spesa (${category ? category.name : 'Sconosciuta'})`;
                 elements.editExpenseAmount.value = expense.amount || 0;
                 elements.editExpenseNote.value = expense.note || '';
                 
                 // (Alpha 52) FIX: Aggiungi listener .onclick qui
                 // Questo sovrascrive qualsiasi listener precedente e garantisce il funzionamento
                 elements.confirmEditBtn.onclick = saveExpenseEdit;
                 // (Alpha 53) Rimosso: il pulsante non esiste più
                 // elements.deleteExpenseBtn.onclick = deleteExpense; 
                 backButtons.cancelEditBtn.onclick = () => {
                    state.editingExpenseId = null; // Resetta l'ID
                    navigate(state.expenseListReturnScreen || 'home'); 
                 };
             }

            // (Alpha 38) Mantenuta SOLO VARIABILI
           // (Alpha 68) Sostituita per unificare i listener
            function renderChartScreen() {
                elements.chartCategorySelect.innerHTML = '<option value="all">Tutte le categorie</option>';
                 // (Alpha 38) Filtra via le categorie fisse dal select
                const sortedCategories = [...state.categories]
                    .filter(cat => !cat.isSpecial) // (Alpha 39) Usa 'isSpecial'
                    .sort((a, b) => a.name.localeCompare(b.name));
                    
                sortedCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    elements.chartCategorySelect.appendChild(option);
                });
                
                // Assicurati che i listener siano agganciati
                // Usiamo .onchange per sovrascrivere eventuali listener vecchi
                document.getElementById('chart-period').onchange = updateCharts;
                elements.chartCategorySelect.onchange = updateCharts;

                // Disegna i grafici
                updateCharts();
            }
			// --- (Alpha 68) NUOVA SEZIONE GRAFICI ---
// --- (Alpha 69) Helper per leggere i colori del Tema ---
            function getCssColor(variableName) {
                // variableName deve essere tipo '--primary-color'
                return getComputedStyle(document.body).getPropertyValue(variableName).trim();
            }
            // Variabili globali per i grafici (al posto di state.pieInstance)
            let mainChartInstance = null;
            let pieChartInstance = null;

            /**
             * Funzione helper per filtrare le spese in base ai selettori
             * @returns {Array} Spese filtrate (solo VARIABILI)
             */
            function getFilteredExpenses() {
                const period = document.getElementById('chart-period').value;
                const categoryId = elements.chartCategorySelect.value;
                const now = new Date();

                let startDate, endDate;
                
                if (period === 'week') {
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1));
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    endDate.setHours(23, 59, 59, 999);
                } else if (period === 'month') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    endDate.setHours(23, 59, 59, 999);
                } else { // 'year'
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31);
                    endDate.setHours(23, 59, 59, 999);
                }

                // Filtra solo spese VARIABILI (non fisse/preset)
                return state.expenses.filter(e => {
                    const cat = state.categories.find(c => c.id === e.categoryId);
                    if (!cat || cat.isSpecial) return false;

                    const d = new Date(e.date);
                    if (isNaN(d)) return false;

                    const inDateRange = d >= startDate && d <= endDate;
                    const inCategory = (categoryId === 'all' || e.categoryId == categoryId);
                    
                    return inDateRange && inCategory;
                });
            }

            /**
             * Master function chiamata dai listener per aggiornare entrambi i grafici
             */
            function updateCharts() {
                const filteredExpenses = getFilteredExpenses();
                const period = document.getElementById('chart-period').value;
                
                drawMainChart(filteredExpenses, period);
                drawPieChart(filteredExpenses);
            }

            /**
             * Disegna il grafico principale (Barra)
             * Questo ora mostra dati utili in base al periodo
             */
            function drawMainChart(expenses, period) {
                if (mainChartInstance) {
                    mainChartInstance.destroy();
                }

                let labels = [];
                let data = [];
                const now = new Date();

                if (period === 'week') {
                    // Raggruppa per giorno (Lun, Mar, ...)
                    labels = ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'];
                    data = Array(7).fill(0);
                    expenses.forEach(e => {
                        const day = new Date(e.date).getDay(); // Dom=0, Lun=1
                        const index = (day === 0) ? 6 : day - 1;
                        data[index] += e.amount;
                    });
                } else if (period === 'month') {
                    // Raggruppa per giorno del mese
                    const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                    labels = Array.from({ length: daysInMonth }, (_, i) => i + 1);
                    data = Array(daysInMonth).fill(0);
                    expenses.forEach(e => {
                        const dayIndex = new Date(e.date).getDate() - 1;
                        data[dayIndex] += e.amount;
                    });
                } else { // 'year'
                    // Raggruppa per mese (Gen, Feb, ...)
                    labels = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
                    data = Array(12).fill(0);
                    expenses.forEach(e => {
                        const monthIndex = new Date(e.date).getMonth();
                        data[monthIndex] += e.amount;
                    });
                }

                const ctx = elements.expenseChartCanvas.getContext('2d');
                mainChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Spese Variabili',
                            data: data,
                            // (Alpha 69) Usa la funzione helper per "tradurre" i colori
                            backgroundColor: getCssColor('--primary-color'),
                            borderColor: getCssColor('--primary-dark'),
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } },
                        plugins: {
                            legend: { display: false },
                            datalabels: { display: false } // Nasconde le etichette per pulizia
                        }
                    }
                });
            }

            /**
             * Disegna il Grafico a Torta (ora corretto)
             */
            function drawPieChart(expenses) {
                if (pieChartInstance) {
                    pieChartInstance.destroy();
                }

                const totalsByCategory = {};
                expenses.forEach(e => {
                    const cat = state.categories.find(c => c.id === e.categoryId);
                    const catName = (cat ? cat.name : 'Sconosciuta');
                    totalsByCategory[catName] = (totalsByCategory[catName] || 0) + e.amount;
                });

                const labels = Object.keys(totalsByCategory);
                const data = Object.values(totalsByCategory);

                // Nascondi il grafico se non ci sono dati
                const pieCanvas = document.getElementById('pie-chart');
                if (data.length === 0 || data.every(d => d === 0)) {
                    pieCanvas.style.display = 'none';
                    return;
                }
                pieCanvas.style.display = 'block';


                const ctx = pieCanvas.getContext('2d');
                pieChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels,
                        datasets: [{
                            data,
                            // (Alpha 69) Usa la funzione helper per "tradurre" i colori
                            backgroundColor: [
                                getCssColor('--primary-color'), getCssColor('--green'), getCssColor('--yellow'),
                                getCssColor('--orange'), getCssColor('--red'), getCssColor('--secondary-text-color')
                            ],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' },
                            datalabels: {
                                color: '#fff',
                                font: { weight: 'bold' },
                                formatter: (value, context) => {
                                    const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = (value / total) * 100;
                                    return percentage > 5 ? percentage.toFixed(0) + '%' : ''; // Mostra solo se > 5%
                                }
                            }
                        }
                    }
                });
            }

            // --- FINE (Alpha 68) NUOVA SEZIONE GRAFICI ---
// (Alpha 70) FIX: Funzione addExpense ripristinata
            function addExpense() {
                const amount = parseFloat(elements.expenseAmount.value);
                const note = elements.expenseNote.value.trim();
                const isRecurring = elements.expenseRecurring.checked; // (Alpha 70) Aggiunto recurring
                
                if (!isFinite(amount) || amount <= 0) {
                    showModal('Errore', 'Inserisci un importo valido.', () => {});
                    return;
                }
                if (!state.selectedCategory) {
                    showModal('Errore', 'Categoria non selezionata.', () => {});
                    navigate('addCategory');
                    return;
                }
                
                // Disabilita per evitare doppio click
                elements.confirmExpenseBtn.disabled = true;

                state.expenses.push({
                    id: Date.now(),
                    categoryId: state.selectedCategory,
                    amount: amount,
                    note: note,
                    recurring: isRecurring, // (Alpha 70) Aggiunto recurring
                    date: new Date().toISOString()
                });
                saveExpenses();

                // Pulisci i campi
                elements.expenseAmount.value = '';
                elements.expenseNote.value = '';
                elements.expenseRecurring.checked = false; // (Alpha 70) Aggiunto recurring
                state.selectedCategory = null;

                // Ri-abilita e naviga
                setTimeout(() => {
                    elements.confirmExpenseBtn.disabled = false;
                    navigate('home');
                }, 300); // Piccolo ritardo per feedback
            }             
            // (Alpha 55) MODIFICATA
            function addCategory() { 
                const name = elements.newCategoryName.value.trim();
                const isSpecial = elements.newCategoryIsPresetCheckbox.checked; // (Alpha 39) 'isSpecial'
                const presetValue = parseFloat(elements.newCategoryPresetValueInput.value);
                const budgetType = elements.newCategoryBudgetType.value;
                const budgetValue = parseFloat(elements.newCategoryBudgetValue.value);
                const icon = state.tempSelectedIcon; // (Alpha 55)
                
                if (!name) { showModal('Errore', 'Inserisci un nome.', () => {}); return; }
                if (state.categories.length >= 50) { showModal('Limite Raggiunto', 'Massimo 50 categorie.', () => {}); return; }
                
                const newCategory = { id: Date.now(), name: name, isSpecial: isSpecial, presetValue: null, budgetType: 'none', budgetValue: null, icon: null }; // (Alpha 39) 'isSpecial'
                
                if (isSpecial) { // (Alpha 39) 'isSpecial'
                    if (!isNaN(presetValue) && presetValue > 0) { 
                        newCategory.presetValue = presetValue; 
                        newCategory.icon = icon || 'euro'; // (Alpha 55)
                    } 
                    else { showModal('Errore', 'Importo fisso non valido.', () => {}); return; } // (Alpha 39) Testo modificato
                } else {
                     if (budgetType !== 'none' && !isNaN(budgetValue) && budgetValue > 0) { 
                        newCategory.budgetType = budgetType; 
                        newCategory.budgetValue = budgetValue; 
                    }
                }
                
                state.categories.push(newCategory); 
                saveCategories(); 
                
                elements.newCategoryName.value = ''; 
                elements.newCategoryIsPresetCheckbox.checked = false; 
                handlePresetToggleAdd(); 
                elements.newCategoryPresetValueInput.value = ''; 
                elements.newCategoryBudgetType.value = 'none'; 
                elements.newCategoryBudgetValue.value = '';
                state.tempSelectedIcon = 'euro'; // Resetta default
                renderIconSelection('new-category-icon-select', 'euro');
                
                renderManageCategoriesScreen(); 
            }
            
            // (Alpha 55) MODIFICATA
            function saveCategoryEdit() { 
                const newName = elements.editCategoryName.value.trim();
                const isSpecial = elements.editCategoryIsPresetCheckbox.checked; // (Alpha 39) 'isSpecial'
                const presetValue = parseFloat(elements.editCategoryPresetValueInput.value);
                const newBudgetType = elements.editCategoryBudgetType.value;
                const newBudgetValue = parseFloat(elements.editCategoryBudgetValue.value);
                const icon = state.tempSelectedIcon; // (Alpha 55)
                
                if (!newName) { showModal('Errore', 'Nome non valido.', () => {}); return; }
                if (!state.editingCategoryId) { showModal('Errore', 'ID non valido.', () => {}); return; }
                
                const categoryIndex = state.categories.findIndex(c => c.id === state.editingCategoryId);
                if (categoryIndex === -1) { navigate('manageCategories'); return; }
                
                state.categories[categoryIndex].name = newName; 
                state.categories[categoryIndex].isSpecial = isSpecial; // (Alpha 39) 'isSpecial'
                
                if (isSpecial) { // (Alpha 39) 'isSpecial'
                     if (!isNaN(presetValue) && presetValue > 0) { 
                        state.categories[categoryIndex].presetValue = presetValue;
						state.categories[categoryIndex].recurring = elements.editCategoryRecurring.checked;
						state.categories[categoryIndex].budgetType = 'none'; 
                        state.categories[categoryIndex].budgetValue = null;
                        state.categories[categoryIndex].icon = icon || 'euro'; // (Alpha 55)
                    } 
                     else { showModal('Errore', 'Importo fisso non valido.', () => {}); return; } // (Alpha 39) Testo modificato
                } else {
                    state.categories[categoryIndex].presetValue = null;
                    state.categories[categoryIndex].icon = null; // (Alpha 55)
                    if (newBudgetType !== 'none' && !isNaN(newBudgetValue) && newBudgetValue > 0) { 
                        state.categories[categoryIndex].budgetType = newBudgetType; 
                        state.categories[categoryIndex].budgetValue = newBudgetValue; 
                    } 
                    else { 
                        state.categories[categoryIndex].budgetType = 'none'; 
                        state.categories[categoryIndex].budgetValue = null; 
                    }
                }
                saveCategories(); 
                state.editingCategoryId = null; 
                state.tempSelectedIcon = 'euro'; // Resetta
                navigate('manageCategories');
            }
            
            function saveExpenseEdit() { 
                const newAmount = parseFloat(elements.editExpenseAmount.value);
                const newNote = elements.editExpenseNote.value.trim();
                if (!newAmount || newAmount <= 0 || isNaN(newAmount)) { showModal('Errore', 'Importo non valido.', () => {}); return; }
                if (!state.editingExpenseId) { showModal('Errore', 'ID Spesa non valido.', () => {}); return; }
                const expenseIndex = state.expenses.findIndex(e => e.id === state.editingExpenseId);
                if (expenseIndex === -1) { navigate(state.expenseListReturnScreen || 'home'); return; } 
                state.expenses[expenseIndex].amount = newAmount; 
                state.expenses[expenseIndex].note = newNote;
                saveExpenses(); 
                state.editingExpenseId = null; 
                navigate(state.expenseListReturnScreen || 'home'); 
             }
             
            function deleteCategory(categoryId) { 
                state.categories = state.categories.filter(cat => cat.id !== categoryId); saveCategories();
                state.expenses = state.expenses.filter(expense => expense.categoryId !== categoryId); saveExpenses();
                renderManageCategoriesScreen(); 
            }
            
            // (Alpha 53) Nuova funzione helper
            /**
             * Avvia il processo di eliminazione di una spesa specifica e aggiorna la UI.
             * @param {number} expenseId - L'ID della spesa da eliminare.
             * @param {string} returnScreen - La schermata a cui tornare dopo l'eliminazione.
             */
            function handleDeleteExpense(expenseId, returnScreen) {
  const expense = state.expenses.find(e => e.id === expenseId);
  if (!expense) return;

  showModal('Elimina Spesa', `Vuoi eliminare la spesa da €${expense.amount.toFixed(2)}?`, () => {
    state.expenses = state.expenses.filter(e => e.id !== expenseId);
    saveExpenses();

    elements.toastMessage.innerHTML = `Spesa eliminata 
      <button id="undo-btn" style="margin-left:10px; color:yellow; background:none; border:none; cursor:pointer;">
        Annulla
      </button>`;
    elements.toastMessage.classList.add('visible');

    const undoBtn = document.getElementById('undo-btn');
    undoBtn.addEventListener('click', () => {
      state.expenses.push(expense);
      saveExpenses();
      showToast('Eliminazione annullata');
    });

    setTimeout(() => elements.toastMessage.classList.remove('visible'), 4000);
    navigate(returnScreen || 'home');
  });
}


            // (Alpha 53) Funzione deleteExpense ora è un helper
            function deleteExpense() { 
                // Questa funzione ora viene chiamata solo dall'icona X tramite handleDeleteExpense
                // o dal vecchio pulsante (se esistesse).
                // La lasciamo per sicurezza, ma la logica principale è in handleDeleteExpense.
                if (!state.editingExpenseId) { 
                    console.warn("deleteExpense chiamato senza editingExpenseId");
                    return; 
                }
                handleDeleteExpense(state.editingExpenseId, state.expenseListReturnScreen);
            }
            
            function addPresetExpense(category) { 
                 state.expenses.push({ id: Date.now(), categoryId: category.id, amount: category.presetValue, note: '', date: new Date().toISOString() });
                 const addedExpenseId = state.expenses[state.expenses.length - 1].id; saveExpenses(); 
                 const note = prompt(`Spesa di €${category.presetValue.toFixed(2)} per "${category.name}" aggiunta.\nNota (opzionale)?`);
                 if (note !== null && note.trim() !== '') {
                    const expenseIndex = state.expenses.findIndex(e => e.id === addedExpenseId);
                    if (expenseIndex !== -1) { state.expenses[expenseIndex].note = note.trim(); saveExpenses(); }
                 }
                 navigate('home'); 
            }
            
            // (Alpha 55) MODIFICATA
            function handlePresetToggleAdd() { 
                if (elements.newCategoryIsPresetCheckbox.checked) { 
                    elements.newCategoryPresetValueGroup.classList.remove('hidden'); 
                    elements.newCategoryIconSelectGroup.classList.remove('hidden'); // Mostra icone
                    elements.newCategoryBudgetFieldsDiv.classList.add('hidden'); 
                } 
                else { 
                    elements.newCategoryPresetValueGroup.classList.add('hidden'); 
                    elements.newCategoryIconSelectGroup.classList.add('hidden'); // Nascondi icone
                    elements.newCategoryBudgetFieldsDiv.classList.remove('hidden'); 
                }
             }
             
            // (Alpha 55) MODIFICATA
            function handlePresetToggleEdit() { 
                 if (elements.editCategoryIsPresetCheckbox.checked) { 
                    elements.editCategoryPresetValueGroup.classList.remove('hidden'); 
                    elements.editCategoryIconSelectGroup.classList.remove('hidden'); // Mostra icone
                    elements.editCategoryBudgetFieldsDiv.classList.add('hidden'); 
                } 
                 else { 
                    elements.editCategoryPresetValueGroup.classList.add('hidden'); 
                    elements.editCategoryIconSelectGroup.classList.add('hidden'); // Nascondi icone
                    elements.editCategoryBudgetFieldsDiv.classList.remove('hidden'); 
                }
            }
            
             function handleSaveGlobalBudget() { 
                 const budgetValue = parseFloat(elements.globalMonthlyBudgetInput.value);
                 if (!isNaN(budgetValue) && budgetValue >= 0) { state.globalMonthlyBudget = budgetValue; saveGlobalBudget(); showToast('Budget mensile salvato!'); renderHomeScreen(); } 
                 else { showModal('Errore', 'Valore budget non valido.', () => {}); }
             }
            function exportData() { 
                try {
                    showToast("Preparazione file...");
                    const dataToExport = { categories: state.categories, expenses: state.expenses, globalMonthlyBudget: state.globalMonthlyBudget, appVersion: versionString, exportedAt: new Date().toISOString() };
                    const dataString = JSON.stringify(dataToExport, null, 2); 
                    const blob = new Blob([dataString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `spese_backup_${new Date().toISOString().split('T')[0]}.json`; 
                    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); 
                    // (Alpha 27) Modificato messaggio toast
                    setTimeout(() => showToast("File pronto! Controlla i Download o scegli 'Salva su File'."), 500); 
                } catch (error) { console.error("Errore esportazione:", error); showModal('Errore Esportazione', 'Problema during l\'esportazione.', () => {}); }
            }
            function importData() { elements.importFileInput.click(); }
            function handleFileImport(event) { 
                const file = event.target.files[0];
                if (!file) { return; }
                showToast("Lettura file..."); 
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (importedData && typeof importedData === 'object' && Array.isArray(importedData.categories) && Array.isArray(importedData.expenses)) {
                            showModal('Conferma Importazione', `Sovrascrivere i dati con ${importedData.categories.length} cat. e ${importedData.expenses.length} spese?`, () => {
                                state.categories = importedData.categories || []; 
                                state.expenses = importedData.expenses || []; 
                                state.globalMonthlyBudget = importedData.globalMonthlyBudget || 0; 
                                // Esegui migrazione dati su dati importati
                                let needsSave = false;
                                state.categories.forEach(cat => {
                                    if (cat.budget !== undefined) { cat.budgetType = 'weekly'; cat.budgetValue = cat.budget; delete cat.budget; needsSave = true; }
                                    if (!cat.budgetType) { cat.budgetType = 'none'; cat.budgetValue = null; needsSave = true; }
                                    // (Alpha 39) Rinomina 'isSpecial' in 'isFixed' (Controllo migrazione)
                                    if (cat.isSpecial === undefined) { 
                                        cat.isSpecial = false; 
                                        cat.presetValue = null; 
                                        needsSave = true; 
                                    }
                                     // (Alpha 55) Migrazione Icone
                                    if (cat.isSpecial && !cat.icon) {
                                        cat.icon = 'euro'; // Icona di default
                                        needsSave = true;
                                    }
                                });
                                // --- Fine Migrazione ---
                                saveCategories(); saveExpenses(); saveGlobalBudget(); 
                                elements.importFileInput.value = null; 
                                showToast('Dati importati!'); 
                                navigate('home'); // Vai always alla home dopo l'import
                            });
                        } else { showModal('Errore File', 'Struttura file non valida.', () => {}); }
                    } catch (error) { console.error("Errore parsing JSON:", error); showModal('Errore File', 'Impossibile leggere il file JSON.', () => {}); }
                    elements.importFileInput.value = null; 
                };
                reader.onerror = () => { showModal('Errore File', 'Impossibile leggere il file.', () => {}); elements.importFileInput.value = null; };
                reader.readAsText(file); 
            }
            
            // --- COLLEGAMENTO PULSANTI ---
            elements.addExpenseBtn.addEventListener('click', () => navigate('addCategory'));
            elements.manageCategoriesBtnHome.addEventListener('click', () => navigate('manageCategories'));
            elements.confirmExpenseBtn.addEventListener('click', addExpense); 
            elements.saveCategoryBtn.addEventListener('click', addCategory); 
			// (Alpha 71) Ripristino pulsanti "Torna Indietro" e "Annulla"
            backButtons.backToHomeFromAdd.addEventListener('click', () => navigate('home'));
            backButtons.backToHomeFromView.addEventListener('click', () => navigate('home'));
            backButtons.cancelAddAmount.addEventListener('click', () => navigate('addCategory')); 
            backButtons.backToHomeFromManage.addEventListener('click', () => navigate('home'));
            backButtons.backToViewFromDetail.addEventListener('click', () => navigate('viewExpenses'));                       
            backButtons.backToHomeFromMonthly.addEventListener('click', () => navigate('home')); 
            backButtons.cancelEditCategory.addEventListener('click', () => { 
                state.editingCategoryId = null; 
                state.tempSelectedIcon = 'euro'; // Resetta
                navigate('manageCategories'); 
            });
            elements.weeklyBox.addEventListener('click', () => navigate('viewExpenses'));
            elements.monthlyBox.addEventListener('click', () => navigate('monthlyHistory'));
            elements.newCategoryIsPresetCheckbox.addEventListener('change', handlePresetToggleAdd);
            elements.exportBtn.addEventListener('click', exportData);
            elements.importBtn.addEventListener('click', importData);
            elements.importFileInput.addEventListener('change', handleFileImport);
            elements.saveGlobalBudgetBtn.addEventListener('click', handleSaveGlobalBudget); 
            // (Alpha 36) Nuovi listener
            elements.viewChartBtn.addEventListener('click', () => navigate('chart'));
            backButtons.backToHomeFromChart.addEventListener('click', () => navigate('home'));
            backButtons.backToHistoryFromWeeklyDetail.addEventListener('click', () => navigate('monthlyHistory'));
           
            // (Alpha 37) Nuovo listener
            backButtons.backToWeeklyDetailFromCat.addEventListener('click', () => navigate('weeklyDetail'));


            // --- INIZIALIZZAZIONE ---
			function applyRecurringExpenses() {
  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();

  const alreadyAdded = new Set(
    state.expenses
      .filter(e => e.recurring)
      .map(e => `${e.categoryId}-${new Date(e.date).getMonth()}-${new Date(e.date).getFullYear()}`)
  );

  state.expenses.forEach(e => {
    if (e.recurring) {
      const d = new Date(e.date);
      const key = `${e.categoryId}-${currentMonth}-${currentYear}`;
      if (!alreadyAdded.has(key) && (d.getMonth() !== currentMonth || d.getFullYear() !== currentYear)) {
        state.expenses.push({
          id: Date.now() + Math.floor(Math.random() * 1000),
          categoryId: e.categoryId,
          amount: e.amount,
          note: e.note || '',
          date: new Date().toISOString(),
          recurring: true
        });
        alreadyAdded.add(key);
      }
    }
  });
  saveExpenses();
}
           // ... prima della funzione init() ...

            // --- (Alpha 65) GESTIONE TEMI ---
            const themeSelector = document.getElementById('theme-selector');
            const themeIcon = document.getElementById('theme-icon');
            // (Alpha 66) Aggiornato array temi
            const allThemeClasses = [
                'theme-light-default', 'theme-dark-default',
                'theme-light-corporate', 'theme-dark-corporate',
                'theme-light-laser', 'theme-dark-laser',
                'theme-light-synth', 'theme-dark-synth',
                'theme-light-graphite', 'theme-dark-graphite',
                'theme-dark' // La classe "marker"
            ];

            function applyTheme(themeName) {
                if (!themeSelector) return; 

                // 1. Pulisce tutte le classi tema dal body
                document.body.classList.remove(...allThemeClasses);

                // 2. Aggiunge la classe del tema specifico
                document.body.classList.add(themeName);

                // 3. Aggiunge la classe marker "theme-dark" se è un tema scuro
                if (themeName.includes('dark')) {
                    document.body.classList.add('theme-dark');
                    if(themeIcon) themeIcon.textContent = '🌙';
                } else {
                    if(themeIcon) themeIcon.textContent = '🎨';
                }

                // 4. Salva la preferenza
                try {
                    localStorage.setItem('app-theme', themeName);
                } catch (e) {
                    console.error("Impossibile salvare il tema:", e);
                }

                // 5. Aggiorna il selettore (utile se chiamata da init)
                themeSelector.value = themeName;
                // ... (codice esistente)
                
                // 5. Aggiorna il selettore (utile se chiamata da init)
                themeSelector.value = themeName;
                
                // 6. (Alpha 69) AGGIUNGI QUESTO BLOCCO:
                // Aggiorna i grafici se sono attualmente visibili
                if (state.currentScreen === 'chart') {
                    // Diamo 50ms al DOM per aggiornare i CSS prima di ridisegnare
                    setTimeout(updateCharts, 50); 
                }
            } // <- Questa è la } di chiusura

            function loadTheme() {
                if (!themeSelector) return; 
                let savedTheme = null;
                try {
                    savedTheme = localStorage.getItem('app-theme');
                } catch (e) {
                    console.error("Impossibile caricare il tema:", e);
                }

                // (Alpha 65) Migrazione da vecchio 'dark-mode'
                if (!savedTheme) {
                    try {
                        const oldDarkMode = localStorage.getItem('dark-mode');
                        if (oldDarkMode === 'true') {
                            savedTheme = 'theme-dark-default'; // Migra a nuovo tema scuro
                            localStorage.removeItem('dark-mode'); // Pulisce vecchio setting
                        } else if (oldDarkMode === 'false') {
                            savedTheme = 'theme-light-default'; // Migra a nuovo tema chiaro
                            localStorage.removeItem('dark-mode'); // Pulisce vecchio setting
                        }
                    } catch (e) { /* ignora */ }
                }
                
                // Applica il tema salvato o il default
                applyTheme(savedTheme || 'theme-light-default');
            }
            // --- FINE GESTIONE TEMI ---


            // --- INIZIALIZZAZIONE ---
			
            function init() {
                elements.appVersion.textContent = versionString; 
                loadData(); // Carica da localStorage
                loadTheme(); // (Alpha 65) AGGIUNGI QUESTA LINEA
				applyRecurringExpenses(); // Duplica spese ricorrenti se necessario
                navigate('home'); // Parte dalla schermata home
            }

            init(); // Avvia l'inizializzazione

            // (Alpha 65) AGGIUNGI QUESTO LISTENER dopo init()
            if (themeSelector) {
                themeSelector.addEventListener('change', () => {
                    applyTheme(themeSelector.value);
                });
            }
        });
    </script>
    
</body>
</html>